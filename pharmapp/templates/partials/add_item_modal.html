<!-- Add Item Modal for Barcode Scanner -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addItemModalLabel">
                    <i class="fas fa-barcode me-2"></i>
                    <span id="modalTitle">Add New Item</span>
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addItemForm" method="post" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Hidden fields -->
                    <input type="hidden" id="itemMode" name="mode" value="retail">
                    <input type="hidden" id="isOfflineMode" name="is_offline" value="false">
                    <input type="hidden" id="customBarcodeId" name="custom_barcode_id" value="">
                    
                    <!-- Barcode Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Barcode Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemBarcode" class="form-label">Barcode *</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                            <input type="text" class="form-control" id="itemBarcode" name="barcode" 
                                                   required maxlength="200" readonly>
                                            <button type="button" class="btn btn-outline-secondary" 
                                                    onclick="clearBarcode()" title="Clear barcode">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-success" 
                                                    onclick="openBarcodeScanner()" title="Scan barcode">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Scanned barcode (auto-filled). Click to edit if needed.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="barcodeType" class="form-label">Barcode Type</label>
                                        <select class="form-select" id="barcodeType" name="barcode_type">
                                            <option value="OTHER">Other/Unknown</option>
                                            <option value="UPC">UPC</option>
                                            <option value="EAN13">EAN-13</option>
                                            <option value="CODE128">Code-128</option>
                                            <option value="QR">QR Code</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Item Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="itemName" class="form-label">Item Name *</label>
                                        <input type="text" class="form-control" id="itemName" name="name" 
                                               required maxlength="200" placeholder="Enter item name">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="itemBrand" class="form-label">Brand</label>
                                        <input type="text" class="form-control" id="itemBrand" name="brand" 
                                               maxlength="200" placeholder="Enter brand name">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="itemDosageForm" class="form-label">Dosage Form</label>
                                        <input type="text" class="form-control" id="itemDosageForm" name="dosage_form" 
                                               maxlength="200" placeholder="e.g., Tablet, Capsule">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="itemUnit" class="form-label">Unit</label>
                                        <input type="text" class="form-control" id="itemUnit" name="unit" 
                                               maxlength="200" placeholder="e.g., Pcs, Bottle, Box">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing and Stock -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing & Stock</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="itemCost" class="form-label">Cost Price *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₦</span>
                                            <input type="number" class="form-control" id="itemCost" name="cost" 
                                                   required step="0.01" min="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="itemPrice" class="form-label">Selling Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₦</span>
                                            <input type="number" class="form-control" id="itemPrice" name="price" 
                                                   step="0.01" min="0" placeholder="0.00">
                                        </div>
                                        <div class="form-text">Leave blank to calculate from markup</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="itemMarkup" class="form-label">Markup (%)</label>
                                        <select class="form-select" id="itemMarkup" name="markup">
                                            <option value="0">No markup</option>
                                            <option value="2.5">2.5% markup</option>
                                            <option value="5">5% markup</option>
                                            <option value="10">10% markup</option>
                                            <option value="15">15% markup</option>
                                            <option value="20">20% markup</option>
                                            <option value="25">25% markup</option>
                                            <option value="30">30% markup</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="itemStock" class="form-label">Initial Stock *</label>
                                        <input type="number" class="form-control" id="itemStock" name="stock" 
                                               required min="0" placeholder="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Additional Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemExpDate" class="form-label">Expiry Date</label>
                                        <input type="date" class="form-control" id="itemExpDate" name="exp_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="itemLowStock" class="form-label">Low Stock Alert</label>
                                        <input type="number" class="form-control" id="itemLowStock" name="low_stock_threshold" 
                                               min="0" placeholder="Alert when stock reaches this level">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Offline Mode Indicator -->
                    <div id="offlineModeIndicator" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-wifi-slash me-2"></i>
                        <strong>Offline Mode:</strong> Item will be queued for sync when you're back online.
                    </div>

                    <!-- Error Messages -->
                    <div id="addItemErrors" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div id="errorMessages"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitItemBtn">
                        <i class="fas fa-save me-1"></i>
                        <span id="submitBtnText">Add Item</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global function to show add item modal
window.showAddItemModal = function(barcode, mode = 'retail', isOffline = false) {
    console.log('[Add Item Modal] Opening modal with:', { barcode, mode, isOffline });
    
    // Set mode and offline status
    document.getElementById('itemMode').value = mode;
    document.getElementById('isOfflineMode').value = isOffline;
    
    // Update modal title
    const title = mode === 'wholesale' ? 'Add New Wholesale Item' : 'Add New Retail Item';
    document.getElementById('modalTitle').textContent = title;
    
    // Pre-fill barcode
    document.getElementById('itemBarcode').value = barcode || '';
    
    // Show offline indicator if needed
    const offlineIndicator = document.getElementById('offlineModeIndicator');
    if (isOffline) {
        offlineIndicator.style.display = 'block';
        document.getElementById('submitBtnText').textContent = 'Queue Item';
    } else {
        offlineIndicator.style.display = 'none';
        document.getElementById('submitBtnText').textContent = 'Add Item';
    }
    
    // Hide any previous errors
    document.getElementById('addItemErrors').style.display = 'none';
    
    // Reset form (except barcode and mode)
    const form = document.getElementById('addItemForm');
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        if (key !== 'barcode' && key !== 'mode' && key !== 'is_offline') {
            const input = form.elements[key];
            if (input && input.type !== 'hidden') {
                input.value = '';
            }
        }
    }
    
    // Show modal using Bootstrap 4/jQuery
    $('#addItemModal').modal('show');
    
    // Focus on item name field
    setTimeout(() => {
        document.getElementById('itemName').focus();
    }, 500);
};

// Clear barcode function
function clearBarcode() {
    document.getElementById('itemBarcode').value = '';
    document.getElementById('itemBarcode').focus();
}

// Handle form submission
document.getElementById('addItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = document.getElementById('submitItemBtn');
    const originalBtnText = document.getElementById('submitBtnText').textContent;
    
    // Get form data
    const formData = new FormData(form);
    const isOffline = formData.get('is_offline') === 'true';
    const mode = formData.get('mode');
    
    // Validate required fields
    const requiredFields = ['barcode', 'name', 'cost', 'stock'];
    const missingFields = [];
    
    for (const field of requiredFields) {
        const value = formData.get(field);
        if (!value || value.trim() === '') {
            missingFields.push(field);
        }
    }
    
    if (missingFields.length > 0) {
        showError(`Missing required fields: ${missingFields.join(', ')}`);
        return;
    }
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    document.getElementById('submitBtnText').textContent = 'Saving...';
    
    try {
        const itemData = {
            barcode: formData.get('barcode').trim(),
            name: formData.get('name').trim(),
            brand: formData.get('brand').trim(),
            dosage_form: formData.get('dosage_form').trim(),
            unit: formData.get('unit').trim(),
            cost: parseFloat(formData.get('cost')),
            price: formData.get('price') ? parseFloat(formData.get('price')) : null,
            markup: formData.get('markup') ? parseFloat(formData.get('markup')) : null,
            stock: parseInt(formData.get('stock')),
            exp_date: formData.get('exp_date') || null,
            barcode_type: formData.get('barcode_type'),
            mode: mode,
            custom_only: document.getElementById('customOnlyCheckbox')?.checked || false
        };
        
        if (document.getElementById('customOnlyCheckbox')?.checked) {
            // Save as custom barcode only
            if (window.barcodeScanner && window.dbManager) {
                try {
                    const customBarcodeData = {
                        barcode: itemData.barcode,
                        barcode_type: itemData.barcode_type || 'OTHER',
                        name: itemData.name,
                        description: `Custom item - ${itemData.brand || 'N/A'}`,
                        notes: `Created via add item form - ${new Date().toLocaleDateString()}`,
                        mode: mode,
                        status: 'active'
                    };
                    
                    await window.barcodeScanner.saveCustomBarcode(customBarcodeData);
                    showSuccess('Custom barcode saved successfully!');
                    $('#addItemModal').modal('hide');
                } catch (error) {
                    console.error('[Add Item] Error saving custom barcode:', error);
                    showError('Failed to save custom barcode: ' + error.message);
                }
            }
        } else if (isOffline) {
            // Handle offline regular item creation
            await handleOfflineItemCreation(itemData);
        } else {
            // Handle online submission
            await handleOnlineItemCreation(itemData);
        }
        
        // Close modal on success using Bootstrap 4/jQuery
        $('#addItemModal').modal('hide');
        
    } catch (error) {
        console.error('[Add Item Modal] Error:', error);
        showError(error.message || 'Failed to create item. Please try again.');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        document.getElementById('submitBtnText').textContent = originalBtnText;
    }
});

// Handle online item creation
async function handleOnlineItemCreation(itemData) {
    const response = await fetch('/api/barcode/add-item/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(itemData)
    });
    
    const result = await response.json();
    
    if (response.ok && result.status === 'success') {
        showSuccess(`${itemData.name} has been added successfully!`);
        
        // Refresh the current page or redirect
        if (window.location.pathname.includes('dispense')) {
            // On dispense page, just refresh the item list
            location.reload();
        } else {
            // Navigate to item detail or list page
            window.location.href = itemData.mode === 'wholesale' 
                ? '/wholesale/wholesales/' 
                : '/store/store/';
        }
    } else {
        throw new Error(result.user_message || result.error || 'Failed to create item');
    }
}

// Handle offline item creation
async function handleOfflineItemCreation(itemData) {
    if (!window.dbManager) {
        throw new Error('IndexedDB not available for offline storage');
    }
    
    const offlineItem = {
        id: `offline_${Date.now()}`,
        action: 'create_item',
        data: itemData,
        timestamp: new Date().toISOString(),
        status: 'pending_sync'
    };
    
    await window.dbManager.add('pendingActions', offlineItem);
    showSuccess('Item has been queued for creation when you are back online.');
}

// Show error function
function showError(message) {
    const errorDiv = document.getElementById('addItemErrors');
    const errorMessages = document.getElementById('errorMessages');
    
    errorMessages.textContent = message;
    errorDiv.style.display = 'block';
    
    // Scroll to top of modal to show error
    document.getElementById('addItemModal').scrollTop = 0;
}

// Show success function
function showSuccess(message) {
    // Use existing notification system if available
    if (window.offlineHandler && window.offlineHandler.showInAppNotification) {
        window.offlineHandler.showInAppNotification('Success', message, 'success');
    } else {
        // Fallback to alert
        alert(message);
    }
}

// Auto-calculate price when markup changes
document.getElementById('itemMarkup').addEventListener('change', function() {
    const cost = parseFloat(document.getElementById('itemCost').value);
    const markup = parseFloat(this.value);
    const priceField = document.getElementById('itemPrice');
    
    if (cost && markup && !priceField.value) {
        const calculatedPrice = cost + (cost * markup / 100);
        priceField.value = calculatedPrice.toFixed(2);
    }
});

// Auto-calculate price when cost changes
document.getElementById('itemCost').addEventListener('change', function() {
    const cost = parseFloat(this.value);
    const markup = parseFloat(document.getElementById('itemMarkup').value);
    const priceField = document.getElementById('itemPrice');
    
    if (cost && markup) {
        const calculatedPrice = cost + (cost * markup / 100);
        priceField.value = calculatedPrice.toFixed(2);
    }
});

// Make barcode field editable on click
document.getElementById('itemBarcode')?.addEventListener('click', function() {
    this.readOnly = false;
    this.classList.add('bg-light');
});

document.getElementById('itemBarcode')?.addEventListener('blur', function() {
    this.readOnly = true;
    this.classList.remove('bg-light');
});
</div>
</div>
</div>
</div>
</div>

<!-- Add Item Modal JavaScript -->
<script>
// Define global functions immediately when script loads
window.openBarcodeScanner = function() {
    const modal = document.getElementById('barcodeScannerModal');
    if (modal) {
        // Set mode to retail for store items
        modal.dataset.mode = 'retail';
        $('#barcodeScannerModal').modal('show');
    } else {
        console.error('[Add Item Modal] Barcode scanner modal not found');
        alert('Barcode scanner not available. Please enter barcode manually.');
    }
};

// Set up barcode scanner callback
window.onBarcodeItemFound = function(item, barcode) {
    // Fill barcode field
    document.getElementById('itemBarcode').value = barcode;
    
    // Close scanner modal
    $('#barcodeScannerModal').modal('hide');
    
    // Focus on item name field
    document.getElementById('itemName').focus();
};

// Make barcode field editable on click
document.getElementById('itemBarcode')?.addEventListener('click', function() {
    this.readOnly = false;
    this.classList.add('bg-light');
});

document.getElementById('itemBarcode')?.addEventListener('blur', function() {
    this.readOnly = true;
    this.classList.remove('bg-light');
});
</script>
</script>

{% extends "partials/base.html" %}

{% block content %}

<h3 style="color: red;">Select for: {{ customer.name }}</h3>
<h4>Wallet Balance: â‚¦ {{ wallet_balance }}</h4>

<!-- Action selection (purchase or return) -->
<div class="mb-4">
    <label for="action" class="form-label" style="font-weight: bold;">Select Action:</label>
    <select id="action" class="form-select form-control" name="action" form="item-form"
        style="background-color: rgb(252, 182, 182); width:auto">
        <option value="purchase" selected>Purchase</option>
        <option value="return">Return</option>
    </select>
</div>

<!-- Search field to filter items -->
<div class="mb-3">
    <div class="input-group">
        <input type="text" class="form-control" id="wholesale-item-search" name="q" placeholder="Search for wholesale items..."
            hx-get="{% url 'wholesale:search_wholesale_items' %}" hx-trigger="keyup changed delay:150ms"
            hx-target="#for-customer" hx-swap="innerHTML" hx-indicator=".htmx-indicator"
            style="background-color: rgb(210, 247, 253);">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#barcodeScannerModal" data-mode="wholesale">
            <i class="fas fa-barcode"></i> Scan
        </button>
    </div>
    <div class="htmx-indicator" style="display:none; margin-top: 10px;">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <small>Searching...</small>
    </div>
</div>



<form method="post" action="" id="item-form">
    {% csrf_token %}
    <div id="item-selection">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Item</th>
                    <th>D/form</th>
                    <th>Brand</th>
                    <th>Unit</th>
                    <th>Price</th>
                    <th>Stock Qty</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody id="for-customer">
                {% for item in items %}
                <tr>
                    <td>
                        <input type="checkbox" name="item_ids" value="{{ item.id }}">
                    </td>
                    <td>{{ item.name|title }}</td>
                    <td>{{ item.dosage_form|title }}</td>
                    <td>{{ item.brand|title }}</td>
                    <td>{{ item.unit }}</td>
                    <td>{{ item.price }}</td>
                    <td>{{ item.stock }}</td>
                    <td>
                        <input type="number" name="quantities" min="0.5" max="{{ item.stock_quantity }}" value="1" step="0.5"
                            class="form-control input-sm" disabled>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Payment Method and Status Selection -->
    <div class="row mt-4 mb-3">
        <div class="col-md-6">
            <div class="form-group">
                <label for="payment_method" class="form-label" style="font-weight: bold;">Payment Method:</label>
                <select id="payment_method" name="payment_method" class="form-select form-control" style="background-color: rgb(210, 247, 253); width:auto">
                    <option value="Cash" selected>Cash</option>
                    <option value="Wallet">Wallet</option>
                    <option value="Transfer">Transfer</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="status" class="form-label" style="font-weight: bold;">Payment Status:</label>
                <select id="status" name="status" class="form-select form-control" style="background-color: rgb(210, 247, 253); width:auto">
                    <option value="Paid" selected>Paid</option>
                    <option value="Unpaid">Unpaid</option>
                </select>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-success">Proceed with Action</button>
</form>

<script>
    // Global object to store selected items across searches
    let selectedItems = {};

    // Function to save item selection state
    function saveItemSelection(itemId, isChecked, quantity) {
        if (isChecked) {
            selectedItems[itemId] = {
                checked: true,
                quantity: quantity || 1
            };
        } else {
            delete selectedItems[itemId];
        }
        console.log('Selected items:', selectedItems);
    }

    // Function to restore item selections after content swap
    function restoreItemSelections() {
        Object.keys(selectedItems).forEach(function(itemId) {
            const checkbox = document.querySelector(`input[type="checkbox"][value="${itemId}"]`);
            const quantityInput = checkbox ? checkbox.closest('tr').querySelector('input[type="number"]') : null;

            if (checkbox && quantityInput) {
                checkbox.checked = selectedItems[itemId].checked;
                quantityInput.disabled = !checkbox.checked;
                quantityInput.value = selectedItems[itemId].quantity;
            }
        });
    }

    // Function to add hidden inputs for selected items not visible in current search
    function addHiddenInputsForSelectedItems() {
        // Remove existing hidden inputs first
        document.querySelectorAll('.hidden-selected-item').forEach(el => el.remove());

        const form = document.getElementById('item-form');
        const visibleItemIds = Array.from(document.querySelectorAll('input[type="checkbox"][name="item_ids"]'))
            .map(cb => cb.value);

        Object.keys(selectedItems).forEach(function(itemId) {
            if (!visibleItemIds.includes(itemId)) {
                // Add hidden inputs for items not visible in current search
                const hiddenItemId = document.createElement('input');
                hiddenItemId.type = 'hidden';
                hiddenItemId.name = 'item_ids';
                hiddenItemId.value = itemId;
                hiddenItemId.className = 'hidden-selected-item';
                form.appendChild(hiddenItemId);

                const hiddenQuantity = document.createElement('input');
                hiddenQuantity.type = 'hidden';
                hiddenQuantity.name = 'quantities';
                hiddenQuantity.value = selectedItems[itemId].quantity;
                hiddenQuantity.className = 'hidden-selected-item';
                form.appendChild(hiddenQuantity);
            }
        });
    }

    // Function to enable quantity input when checkbox is selected
    function setupCheckboxListeners() {
        document.querySelectorAll('input[type="checkbox"][name="item_ids"]').forEach(function (checkbox) {
            checkbox.addEventListener('change', function () {
                const quantityInput = this.closest('tr').querySelector('input[type="number"]');
                const itemId = this.value;
                const quantity = quantityInput.value;

                quantityInput.disabled = !this.checked;

                // Save selection state
                saveItemSelection(itemId, this.checked, quantity);

                // Update hidden inputs
                addHiddenInputsForSelectedItems();
            });
        });

        // Also listen for quantity changes
        document.querySelectorAll('input[type="number"][name="quantities"]').forEach(function (quantityInput) {
            quantityInput.addEventListener('change', function () {
                const checkbox = this.closest('tr').querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const itemId = checkbox.value;
                    saveItemSelection(itemId, true, this.value);
                }
            });
        });
    }

    // Call the function on page load
    setupCheckboxListeners();
    restoreItemSelections();

    // Set up HTMX event listener to reinitialize checkbox listeners after search results load
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'for-customer') {
            setupCheckboxListeners();
            restoreItemSelections();
            addHiddenInputsForSelectedItems();
        }
    });

    // Update form action dynamically based on selected action
    const actionSelect = document.getElementById('action');
    actionSelect.addEventListener('change', function () {
        const form = document.getElementById('item-form');
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = this.value;
        form.appendChild(actionInput);
    });
</script>

<!-- Barcode Scanner Integration -->
{% include 'partials/barcode_scanner_modal.html' %}

<!-- Barcode Scanner Callback for Wholesale Item Selection -->
<script>
    console.log('[Wholesale Item Selection] Defining barcode callback');

    window.onBarcodeItemFound = function(item, barcode) {
        console.log('[Wholesale Item Selection] Barcode scanned:', barcode, 'Item:', item);

        // Fill the search input with the item name
        const searchInput = document.getElementById('wholesale-item-search');
        if (searchInput && item) {
            searchInput.value = item.name;
            console.log('[Wholesale Item Selection] Search input filled with:', item.name);

            // Trigger HTMX search
            setTimeout(() => {
                htmx.trigger(searchInput, 'keyup');
                console.log('[Wholesale Item Selection] HTMX search triggered');

                // Wait for search results to load, then auto-select the item
                setTimeout(() => {
                    // Find the checkbox for this wholesale item
                    const checkbox = document.querySelector(`input[type="checkbox"][data-item-id="${item.id}"]`);
                    if (checkbox && !checkbox.checked) {
                        checkbox.checked = true;
                        console.log('[Wholesale Item Selection] Item checkbox auto-selected');

                        // Find and set quantity to 1 if not already set
                        const quantityInput = document.querySelector(`input[name="quantities"][data-item-id="${item.id}"]`);
                        if (quantityInput && (!quantityInput.value || quantityInput.value === '0')) {
                            quantityInput.value = '1';
                            quantityInput.disabled = false;
                            console.log('[Wholesale Item Selection] Quantity set to 1');
                        }
                    }
                }, 800); // Wait for HTMX to load results
            }, 100);
        } else {
            console.error('[Wholesale Item Selection] Search input not found or item is null');
        }

        // Close the scanner modal
        const modalElement = document.getElementById('barcodeScannerModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
        }

        // Show success notification
        if (window.offlineHandler && window.offlineHandler.showInAppNotification) {
            window.offlineHandler.showInAppNotification(
                'Wholesale Item Scanned',
                `${item.name} added to selection`,
                'success'
            );
        }
    };

    console.log('[Wholesale Item Selection] Barcode callback ready');

    // ==================== HARDWARE BARCODE SCANNER SUPPORT ====================
    // Supports USB/Bluetooth handheld barcode scanners for wholesale registered customers
    // No need to click scan button - just point and scan!
    // ==========================================================================

    // Load hardware scanner module
    const hardwareScannerScript = document.createElement('script');
    hardwareScannerScript.src = "{% static 'js/hardware-scanner.js' %}";
    hardwareScannerScript.onload = function() {
        console.log('[Wholesale Item Selection] Hardware scanner module loaded');

        // Initialize hardware scanner for wholesale registered customers
        window.selectWholesaleItemsPageHardwareScanner = new HardwareScannerHandler({
            mode: 'wholesale',
            scannerSpeed: 50,        // Max 50ms between characters
            minBarcodeLength: 3,     // Min barcode length
            maxBarcodeLength: 50     // Max barcode length
        });

        // Start listening for scanner input
        window.selectWholesaleItemsPageHardwareScanner.init();
        console.log('[Wholesale Item Selection] Hardware scanner initialized - Ready to scan!');

        // Disable hardware scanner when camera modal is open (avoid conflicts)
        $('#barcodeScannerModal').on('shown.bs.modal', function() {
            if (window.selectWholesaleItemsPageHardwareScanner) {
                window.selectWholesaleItemsPageHardwareScanner.disable();
                console.log('[Wholesale Item Selection] Hardware scanner disabled (camera active)');
            }
        });

        // Re-enable hardware scanner when camera modal is closed
        $('#barcodeScannerModal').on('hidden.bs.modal', function() {
            if (window.selectWholesaleItemsPageHardwareScanner) {
                window.selectWholesaleItemsPageHardwareScanner.enable();
                console.log('[Wholesale Item Selection] Hardware scanner enabled');
            }
        });
    };
    document.head.appendChild(hardwareScannerScript);

    // ==========================================================================
    // USAGE: Just scan with your USB/Bluetooth barcode scanner!
    // - Point scanner at barcode
    // - Press trigger
    // - Item automatically appears in search results
    // ==========================================================================
</script>

{% endblock %}
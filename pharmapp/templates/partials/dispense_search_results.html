{% load humanize %}
{% load permission_tags %}

{% if results %}
<div class="results-header">
    <i class="fas fa-list mr-2"></i>
    Search Results ({{ results|length }} item{{ results|length|pluralize }} found)
</div>

{% for item in results %}
<div class="item-card">
    <div class="row align-items-center">
        <div class="col-md-8 item-info">
            <div class="item-name">{{ item.name|default:"Unknown Item"|title }}</div>
            <div class="item-details">
                <strong>Form:</strong> {{ item.dosage_form|default:"N/A"|title }} | 
                <strong>Brand:</strong> {% if item.brand %}{{ item.brand|title }}{% else %}N/A{% endif %} | 
                <strong>Unit:</strong> {{ item.unit|default:"unit" }}
            </div>
            <div class="item-stock">
                <i class="fas fa-boxes mr-1"></i>
                {{ item.stock|default:0 }} {{ item.unit|default:"unit" }} Available
            </div>
            <div class="item-price">
                <i class="fas fa-tag mr-1"></i>
                â‚¦{{ item.price|default:0|floatformat:2 }} each
            </div>
        </div>
        <div class="col-md-4">
            <form method="POST"
                  data-item-name="{{ item.name|default:'Unknown Item' }}"
                  data-item-price="{{ item.price|default:0 }}"
                  data-item-id="{{ item.id }}"
                  class="add-to-cart-form"
                  hx-post="{% url 'store:add_to_cart' item.id %}?from_dispense=true"
                  hx-target="#cart-summary-widget"
                  hx-swap="outerHTML"
                  hx-indicator="#loading-indicator-{{ item.id|default:'unknown' }}"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token|escapejs }}"}'>
                {% csrf_token %}
                <div class="quantity-form">
                    <label for="quantity_{{ item.id|default:'unknown' }}" class="form-label mb-0">Qty:</label>
                    <input type="number"
                           name="quantity"
                           id="quantity_{{ item.id|default:'unknown' }}"
                           class="form-control quantity-input"
                           value="1"
                           min="1"
                           max="{{ item.stock|default:1 }}"
                           required>
                    <input type="hidden" name="unit" value="{{ item.unit|default:'unit' }}">
                    <input type="hidden" name="from_dispense" value="true">
                    <button type="submit" class="btn btn-success add-to-cart-btn">
                        <span id="loading-indicator-{{ item.id|default:'unknown' }}" class="htmx-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                        <span class="btn-text">
                            <i class="fas fa-cart-plus mr-1"></i>Add to Cart
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% elif query %}
<div class="no-results">
    <i class="fas fa-search"></i>
    <h4>No items found</h4>
    <p>No items found for "{{ query }}". Try searching with different keywords or check the spelling.</p>
</div>
{% else %}
<div class="no-results">
    <i class="fas fa-pills"></i>
    <h4>Ready to Search</h4>
    <p>Enter an item name or brand to start searching for items to dispense.</p>
</div>
{% endif %}

<!-- Barcode/QR Scanner Modal -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1" role="dialog" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="barcodeScannerModalLabel">
                    <i class="fas fa-barcode"></i> Scan Barcode or QR Code
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Scanner Status -->
                <div id="scanner-status" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle"></i> <span id="scanner-status-text">Initializing scanner...</span>
                </div>

                <!-- Camera view container -->
                <div id="barcode-scanner" class="scanner-container" style="width: 100%; min-height: 300px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;"></div>

                <!-- Scanner Controls -->
                <div class="scanner-controls mt-3 text-center">
                    <button type="button" id="start-scan-btn" class="btn btn-success">
                        <i class="fas fa-camera"></i> Start Camera
                    </button>
                    <button type="button" id="stop-scan-btn" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-stop"></i> Stop Camera
                    </button>
                    <button type="button" id="retry-scan-btn" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-redo"></i> Retry Camera
                    </button>
                    
                    <button type="button" id="manage-barcodes-btn" class="btn btn-info" data-toggle="modal" data-target="#customBarcodesModal">
                        <i class="fas fa-list"></i> Manage Barcodes
                    </button>

                    <!-- Auto-start option -->
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="auto-start-checkbox">
                        <label class="form-check-label" for="auto-start-checkbox">
                            <small>Auto-start camera when opening scanner</small>
                        </label>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Manual entry fallback -->
                <div class="manual-entry">
                    <label class="font-weight-bold">
                        <i class="fas fa-keyboard"></i> Or enter barcode manually:
                    </label>
                    <div class="input-group">
                        <input type="text" id="manual-barcode-input" class="form-control"
                               placeholder="Enter barcode number"
                               autocomplete="off">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button" id="manual-lookup-btn">
                                <i class="fas fa-search"></i> Lookup
                            </button>
                        </div>
                    </div>
                    <small class="form-text text-muted">
                        Supports UPC, EAN-13, Code-128, and QR codes
                    </small>
                </div>

                <hr class="my-3">

                <!-- File upload for barcode image -->
                <div class="file-upload">
                    <label class="font-weight-bold">
                        <i class="fas fa-image"></i> Or upload barcode image:
                    </label>
                    <input type="file" id="barcode-file-input" class="form-control-file"
                           accept="image/*">
                    <small class="form-text text-muted">
                        Upload a photo of a barcode to scan
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Scanner container styles */
    #barcode-scanner {
        background-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
    }

    #barcode-scanner video {
        width: 100%;
        height: auto;
        border-radius: 6px;
    }

    .scanner-container:empty::before {
        content: 'Camera will appear here';
        display: flex;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: #999;
    }

    /* Manual input focus */
    #manual-barcode-input:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }

    /* Scanner status styles */
    #scanner-status {
        margin-bottom: 1rem;
    }
</style>

<script>
// Initialize modal - works for both initial page load and HTMX-loaded content
(function initBarcodeScannerModal() {
    console.log('[Scanner Modal] Script loading...');

    // Default handlers
    function defaultSuccessHandler(item, barcode) {
        console.log('[Scanner Modal] Item found:', item);
    }

    function defaultErrorHandler(error) {
        console.error('[Scanner Modal] Error:', error);
    }

    // Check if jQuery is available - if not, wait and retry
    if (typeof jQuery === 'undefined') {
        console.warn('[Scanner Modal] jQuery not loaded yet, retrying in 100ms...');
        setTimeout(initBarcodeScannerModal, 100);
        return;
    }

    console.log('[Scanner Modal] Initializing script...');

    let barcodeScanner = null;
    const modal = document.getElementById('barcodeScannerModal');
    const startBtn = document.getElementById('start-scan-btn');
    const stopBtn = document.getElementById('stop-scan-btn');
    const retryBtn = document.getElementById('retry-scan-btn');
    const manualInput = document.getElementById('manual-barcode-input');
    const manualLookupBtn = document.getElementById('manual-lookup-btn');
    const fileInput = document.getElementById('barcode-file-input');
    const statusDiv = document.getElementById('scanner-status');
    const statusText = document.getElementById('scanner-status-text');

    // Check if all elements were found
    if (!modal) {
        console.error('[Scanner Modal] Modal element not found!');
        return;
    }
    if (!startBtn || !stopBtn || !retryBtn) {
        console.error('[Scanner Modal] Button elements not found!');
        return;
    }

    // Check if already initialized to prevent duplicate event listeners
    if (modal.dataset.initialized === 'true') {
        console.log('[Scanner Modal] Already initialized, skipping setup');
        return;
    }

    console.log('[Scanner Modal] All elements found, setting up event listeners...');

    // Mark as initialized
    modal.dataset.initialized = 'true';

    /**
     * Show status message
     */
    function showStatus(message, type = 'info', duration = 3000) {
        statusDiv.className = `alert alert-${type}`;
        statusDiv.style.display = 'block';

        // Show retry progress as loading spinner
        if (message.includes('retrying')) {
            statusDiv.innerHTML = `<div class="d-flex align-items-center">
                <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                <span>${message}</span>
            </div>`;
        } else {
            statusDiv.innerHTML = message;
        }

        // Auto-hide messages based on type and duration
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, duration);
        }
    }

    /**
     * Hide status message
     */
    function hideStatus() {
        statusDiv.style.display = 'none';
    }

    /**
     * Transfer data-mode from button to modal before opening
     */
    $(modal).on('show.bs.modal', function(event) {
        // Get the button that triggered the modal
        const button = event.relatedTarget;
        if (button && button.dataset.mode) {
            // Transfer mode from button to modal
            this.dataset.mode = button.dataset.mode;
            console.log('[Scanner Modal] Mode set from button:', button.dataset.mode);
        } else {
            // Default to retail if no mode specified
            this.dataset.mode = 'retail';
            console.log('[Scanner Modal] No mode on button, defaulting to retail');
        }
    });

    /**
     * Initialize scanner when modal opens
     */
    $(modal).on('shown.bs.modal', async function() {
        const mode = this.dataset.mode || 'retail';

        console.log('[Scanner Modal] Modal opened in', mode, 'mode');

        // Wait for library to be ready (max 3 seconds)
        let libraryReady = false;
        let attempts = 0;
        const maxAttempts = 30;  // 30 attempts * 100ms = 3 seconds

        console.log('[Scanner Modal] Checking for BarcodeScanner and Html5Qrcode...');

        while (!libraryReady && attempts < maxAttempts) {
            if (typeof Html5Qrcode !== 'undefined' && typeof BarcodeScanner !== 'undefined') {
                libraryReady = true;
                console.log('[Scanner Modal] âœ… Both libraries found!');
                break;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;

            if (attempts % 5 === 0) {
                console.log('[Scanner Modal] Still waiting for libraries... Html5Qrcode:', typeof Html5Qrcode, 'BarcodeScanner:', typeof BarcodeScanner);
            }
        }

        if (!libraryReady) {
            showStatus('Scanner library failed to load. Please refresh the page.', 'danger');
            console.error('[Scanner Modal] Timeout waiting for libraries');
            return;
        }

        console.log('[Scanner Modal] Libraries ready after ' + (attempts * 100) + 'ms');

        try {
            console.log('[Scanner Modal] Creating BarcodeScanner instance...');

            // Initialize scanner with dynamic callback lookup from parent page
            barcodeScanner = new BarcodeScanner({
                scannerId: 'barcode-scanner',
                mode: mode,
                onSuccess: function(item, barcode) {
                    const callback = window.onBarcodeItemFound || defaultSuccessHandler;
                    console.log('[Scanner Modal] Invoking callback');
                    callback(item, barcode);
                },
                onError: defaultErrorHandler
            });

            // Make instance available globally for dynamic modals
            window.barcodeScanner = barcodeScanner;

            console.log('[Scanner Modal] BarcodeScanner instance created');
            console.log('[Scanner Modal] Calling init()...');

            await barcodeScanner.init();
            hideStatus();
            console.log('[Scanner Modal] âœ… Scanner initialized successfully');

            // Auto-start option (check localStorage setting)
            const autoStart = localStorage.getItem('barcode_auto_start') === 'true';
            console.log('[Scanner Modal] Auto-start setting:', autoStart);

            if (autoStart) {
                console.log('[Scanner Modal] ðŸš€ Auto-starting camera...');
                setTimeout(() => {
                    console.log('[Scanner Modal] Clicking start button...');
                    startBtn.click();
                }, 200);
            } else {
                console.log('[Scanner Modal] â„¹ï¸ Auto-start disabled. Click "Start Camera" button to begin.');
            }

        } catch (error) {
            showStatus('Failed to initialize scanner: ' + error.message, 'danger');
            console.error('[Scanner Modal] Initialization error:', error);
        }
    });

    /**
     * Clean up when modal closes
     */
    $(modal).on('hidden.bs.modal', async function() {
        if (barcodeScanner) {
            await barcodeScanner.destroy();
            barcodeScanner = null;
        }

        // Reset UI
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        retryBtn.style.display = 'none';
        manualInput.value = '';
        fileInput.value = '';
        hideStatus();
        document.getElementById('barcode-scanner').innerHTML = '';

        console.log('[Scanner Modal] Cleaned up');
    });

    /**
     * Start scanning button
     */
    startBtn.addEventListener('click', async function() {
        console.log('[Scanner Modal] ===== START BUTTON CLICKED =====');

        if (!barcodeScanner) {
            showStatus('Scanner not initialized. Please close and reopen this modal.', 'danger');
            console.error('[Scanner Modal] âŒ Scanner instance is null');
            return;
        }

        console.log('[Scanner Modal] Scanner instance exists:', !!barcodeScanner);

        // Check if Html5Qrcode library is loaded
        if (typeof Html5Qrcode === 'undefined') {
            showStatus('Barcode scanner library not loaded. Please refresh the page.', 'danger');
            console.error('[Scanner Modal] âŒ Html5Qrcode library not found');
            return;
        }

        console.log('[Scanner Modal] Html5Qrcode library loaded: âœ“');

        showStatus('Starting camera...', 'info');
        retryBtn.style.display = 'none'; // Hide retry button when starting fresh
        console.log('[Scanner Modal] ðŸŽ¥ Calling barcodeScanner.startScanning()...');

        try {
            await barcodeScanner.startScanning();
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            retryBtn.style.display = 'none';
            showStatus('Camera ready - point at barcode', 'success');
            console.log('[Scanner Modal] Camera started successfully');
        } catch (error) {
            console.error('[Scanner Modal] Failed to start camera:', error);
            
            // Show retry button for retryable errors
            if (error.name === 'NotReadableError' || error.name === 'OverconstrainedError') {
                startBtn.style.display = 'none';
                retryBtn.style.display = 'inline-block';
                showStatus('Camera failed to start. Click "Retry Camera" to try again.', 'warning');
            } else if (error.name === 'NotAllowedError') {
                showStatus('Camera permission denied. Please allow camera access in your browser settings.', 'danger');
            } else if (error.name === 'NotFoundError') {
                showStatus('No camera found on this device.', 'danger');
            } else {
                showStatus('Failed to start camera: ' + (error.message || 'Unknown error'), 'danger');
            }
        }
    });

    /**
     * Retry scanning button
     */
    retryBtn.addEventListener('click', async function() {
        console.log('[Scanner Modal] ===== RETRY BUTTON CLICKED =====');

        if (!barcodeScanner) {
            showStatus('Scanner not initialized. Please close and reopen this modal.', 'danger');
            console.error('[Scanner Modal] âŒ Scanner instance is null');
            return;
        }

        showStatus('Retrying camera...', 'info');
        console.log('[Scanner Modal] ðŸ”„ Calling barcodeScanner.retryCameraStart()...');

        try {
            await barcodeScanner.retryCameraStart();
            retryBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            showStatus('Camera started successfully - point at barcode', 'success');
            console.log('[Scanner Modal] Camera retry successful');
        } catch (error) {
            console.error('[Scanner Modal] Failed to retry camera:', error);
            showStatus('Retry failed: ' + (error.message || 'Unknown error'), 'danger');
        }
    });

    /**
     * Stop scanning button
     */
    stopBtn.addEventListener('click', async function() {
        if (barcodeScanner) {
            await barcodeScanner.stopScanning();
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            showStatus('Camera stopped', 'info');
        }
    });

    /**
     * Manual lookup button
     */
    manualLookupBtn.addEventListener('click', function() {
        const barcode = manualInput.value.trim();
        if (!barcode) {
            showStatus('Please enter a barcode', 'warning');
            return;
        }

        if (barcodeScanner) {
            showStatus('Looking up barcode...', 'info');
            barcodeScanner.lookupBarcode(barcode);
        } else {
            showStatus('Scanner not initialized', 'danger');
        }
    });

    /**
     * Manual input - Enter key support
     */
    manualInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            manualLookupBtn.click();
        }
    });

    /**
     * File upload handler
     */
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!barcodeScanner) {
            showStatus('Scanner not initialized', 'danger');
            return;
        }

        showStatus('Scanning image...', 'info');
        barcodeScanner.scanFile(file);
    });

    /**
     * Default success handler (if not overridden by parent page)
     */
    function defaultSuccessHandler(item, barcode) {
        showStatus(`Found: ${item.name}`, 'success');
        console.log('[Scanner Modal] Item found:', item);

        // Auto-close modal after 2 seconds
        setTimeout(() => {
            $(modal).modal('hide');
        }, 2000);
    }

    /**
     * Default error handler
     */
    function defaultErrorHandler(error, barcode) {
        showStatus(`Item not found for barcode: ${barcode}`, 'danger');
        console.error('[Scanner Modal] Error:', error);
    }

    console.log('[Scanner Modal] Script loaded and ready');
})(); // End IIFE - executes immediately on script load

// Handle auto-start checkbox preference
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('auto-start-checkbox');
    if (checkbox) {
        // Load saved preference
        checkbox.checked = localStorage.getItem('barcode_auto_start') === 'true';

        // Save preference when changed
        checkbox.addEventListener('change', function() {
            localStorage.setItem('barcode_auto_start', this.checked);
            console.log('[Scanner Modal] Auto-start preference saved:', this.checked);
        });
    }
});
</script>

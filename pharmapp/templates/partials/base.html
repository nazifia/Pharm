{% load static %}
{% load humanize %}
{% load permission_tags %}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Cache Control - Prevent browser caching of dynamic pages -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Nazz| Tech</title>

    <!-- Favicon configuration -->
    <link rel="icon" type="image/svg+xml" href="{% static 'img/favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/icon-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/icon-192x192.png' %}">
    <link rel="mask-icon" href="{% static 'img/favicon.svg' %}" color="#4A90E2">

    <!-- Preload critical resources -->
    <link rel="preload" href="{% static 'htmx/htmx.min.js' %}" as="script">
    <link rel="preload" href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" as="style">
    <link rel="preload" href="{% static 'css/sb-admin-2.min.css' %}" as="style">

    <!-- HTMX for all pages - load synchronously to avoid timing issues -->
    <script src="{% static 'htmx/htmx.min.js' %}"></script>
    <script>
        // Configure HTMX to NOT cache requests - ensures fresh data on every request
        document.body.setAttribute('hx-headers', JSON.stringify({
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        }));

        // Ensure HTMX is loaded before continuing
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof htmx === 'undefined') {
                console.error('HTMX failed to load');
                // Try to load from CDN as fallback
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js';
                script.onload = function() {
                    console.log('HTMX loaded from CDN fallback');
                    // Reload any htmx-enabled elements
                    htmx.process(document.body);
                };
                script.onerror = function() {
                    console.error('Failed to load HTMX from CDN');
                };
                document.head.appendChild(script);
            } else {
                console.log('[HTMX] Loaded successfully - cache disabled for all requests');
            }
        });
    </script>

    <!-- Custom fonts for this template with async loading -->
    <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css" media="print" onload="this.media='all'">
    <noscript><link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css"></noscript>

    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&display=swap"
        rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet"></noscript>

    <!-- Custom styles for this template with async loading -->
    <link href="{% static 'css/sb-admin-2.min.css' %}" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="{% static 'css/sb-admin-2.min.css' %}" rel="stylesheet"></noscript>

    <!-- Offline indicator styles -->
    <link href="{% static 'css/offline-indicator.css' %}" rel="stylesheet">

    <!-- Extra CSS block for child templates -->
    {% block extra_css %}{% endblock %}

    <!-- Add manifest link -->
    <link rel="manifest" href="{% static 'manifest.json' %}">

    <!-- Add theme-color meta tag -->
    <meta name="theme-color" content="#4A90E2">

    <style>
        .nazz:hover {
            transform: scale(1.05);
            transition: 0.5s ease-in-out;
        }

        .offline-status-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #connection-status .badge {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
        }

        #sync-button {
            display: none;
        }

        .offline-indicator {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }
    </style>

</head>

<body id="page-top">

    <!-- Add offline status indicator -->
    <div class="offline-indicator" id="offline-indicator">
        You are currently offline. Some features may be limited.
    </div>

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center"
                href="{% url 'store:dashboard' %}">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-prescription"></i>
                </div>
                <div class="sidebar-brand-text mx-3">NAZZ PHARMACY</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- ==================== DASHBOARD ==================== -->
            <li class="nav-item active">
                <a class="nav-link" href="{% url 'store:dashboard' %}">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== OPERATIONS ==================== -->
            <div class="sidebar-heading">
                Operations
            </div>

            <!-- Dispensing -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseDispensing"
                    aria-expanded="true" aria-controls="collapseDispensing">
                    <i class="fas fa-fw fa-pills"></i>
                    <span>Dispensing</span>
                </a>
                <div id="collapseDispensing" class="collapse" aria-labelledby="headingDispensing" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        {% if user|can_operate_retail %}
                        <h6 class="collapse-header">Retail:</h6>
                        <a class="collapse-item" href="{% url 'store:dispense' %}">
                            <i class="fas fa-pills"></i> Retail Dispense</a>
                        {% endif %}
                        {% if user|can_operate_wholesale %}
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Wholesale:</h6>
                        <a class="collapse-item" href="{% url 'wholesale:dispense_wholesale' %}">
                            <i class="fas fa-warehouse"></i> Wholesale Dispense</a>
                        {% endif %}
                    </div>
                </div>
            </li>

            <!-- Customers -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseCustomers"
                    aria-expanded="true" aria-controls="collapseCustomers">
                    <i class="fas fa-fw fa-users"></i>
                    <span>Customers</span>
                </a>
                <div id="collapseCustomers" class="collapse" aria-labelledby="headingCustomers" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Retail Customers:</h6>
                        <a class="collapse-item" href="" data-toggle="modal" data-target="#registerCustomerModal"
                            hx-get="{% url 'store:register_customers' %}"
                            hx-target="{% url 'store:register_customers' %}" hx-trigger="click">
                            <i class="fas fa-user-plus"></i> Register New Customer
                        </a>
                        <a class="collapse-item" href="{% url 'store:customer_list' %}">
                            <i class="fas fa-list"></i> Retail Customers</a>
                        <a class="collapse-item" href="{% url 'store:customers_on_negative' %}">
                            <i class="fas fa-exclamation-triangle"></i> Customers on Negative (Retail)</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Wholesale Customers:</h6>
                        <a class="collapse-item" href="" data-toggle="modal"
                            data-target="#registerWholesaleCustomerModal"
                            hx-get="{% url 'wholesale:register_wholesale_customers' %}"
                            hx-target="{% url 'wholesale:register_wholesale_customers' %}" hx-trigger="click">
                            <i class="fas fa-user-plus"></i> New Wholesale Customer
                        </a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_customers' %}">
                            <i class="fas fa-list"></i> Wholesale Customers</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_customers_on_negative' %}">
                            <i class="fas fa-exclamation-triangle"></i> Customers on Negative (Wholesale)</a>
                    </div>
                </div>
            </li>

            <!-- Payments -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePayments"
                    aria-expanded="true" aria-controls="collapsePayments">
                    <i class="fas fa-fw fa-credit-card"></i>
                    <span>Payments</span>
                </a>
                <div id="collapsePayments" class="collapse" aria-labelledby="headingPayments" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        {% if user|can_dispense_items %}
                        <h6 class="collapse-header">My Payment Requests (Dispenser):</h6>
                        <a class="collapse-item" href="{% url 'store:payment_requests' %}">
                            <i class="fas fa-receipt"></i> My Retail Requests</a>
                        {% if user|can_operate_wholesale %}
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_payment_requests' %}">
                            <i class="fas fa-receipt"></i> My Wholesale Requests</a>
                        {% endif %}
                        <div class="collapse-divider"></div>
                        {% endif %}
                        {% if user|is_cashier or user.profile.user_type == 'Admin' %}
                        <h6 class="collapse-header">Cashier Dashboard:</h6>
                        <a class="collapse-item" href="{% url 'store:cashier_dashboard' %}">
                            <i class="fas fa-cash-register"></i> Cashier Dashboard (Retail)</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_cashier_dashboard' %}">
                            <i class="fas fa-cash-register"></i> Cashier Dashboard (Wholesale)</a>
                        <div class="collapse-divider"></div>
                        {% endif %}
                        {% if user|is_cashier or user.profile.user_type == 'Admin' or user.profile.user_type == 'Manager' %}
                        <h6 class="collapse-header">Payment Totals:</h6>
                        <a class="collapse-item" href="{% url 'store:cashier_payment_totals' %}">
                            <i class="fas fa-money-bill-wave"></i> Payment Totals (Retail)</a>
                        <a class="collapse-item" href="{% url 'wholesale:cashier_payment_totals' %}">
                            <i class="fas fa-money-bill-wave"></i> Payment Totals (Wholesale)</a>
                        {% endif %}
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== INVENTORY ==================== -->
            <div class="sidebar-heading">
                Inventory
            </div>

            <!-- Inventory -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseInventory"
                    aria-expanded="true" aria-controls="collapseInventory">
                    <i class="fas fa-fw fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                <div id="collapseInventory" class="collapse" aria-labelledby="headingInventory" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Stock Management:</h6>
                        <a class="collapse-item" href="{% url 'store:adjust_stock_levels' %}">
                            <i class="fas fa-edit"></i> Adjust Retail Stock</a>
                        <a class="collapse-item" href="{% url 'wholesale:adjust_wholesale_stock_levels' %}">
                            <i class="fas fa-edit"></i> Adjust Wholesale Stock</a>
                        <a class="collapse-item" href="{% url 'store:exp_date_alert' %}">
                            <i class="fas fa-calendar-times"></i> Retail Expiry Alerts</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_exp_alert' %}">
                            <i class="fas fa-calendar-times"></i> Wholesale Expiry Alerts</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Stock Transfers:</h6>
                        <a class="collapse-item" href="{% url 'store:transfer_multiple_store_items' %}">
                            <i class="fas fa-exchange-alt"></i> Move Store Items</a>
                        {% comment %} <a class="collapse-item" href="{% url 'wholesale:transfer_multiple_wholesale_items' %}">
                            <i class="fas fa-exchange-alt"></i> Move Wholesale Items</a> {% endcomment %}
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Quality Control:</h6>
                        <a class="collapse-item" href="{% url 'store:create_stock_check' %}">
                            <i class="fas fa-clipboard-check"></i> Create Stock Check (Retail)</a>
                        <a class="collapse-item" href="{% url 'store:list_stock_checks' %}">
                            <i class="fas fa-list"></i> Stock Check Reports (Retail)</a>
                        <a class="collapse-item" href="{% url 'wholesale:create_wholesale_stock_check' %}">
                            <i class="fas fa-clipboard-check"></i> Create Stock Check (Wholesale)</a>
                        <a class="collapse-item" href="{% url 'wholesale:list_wholesale_stock_checks' %}">
                            <i class="fas fa-list"></i> Stock Check Reports (Wholesale)</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== REPORTS & ANALYTICS ==================== -->
            <div class="sidebar-heading">
                Reports & Analytics
            </div>

            <!-- Reports & Analytics -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseReports"
                    aria-expanded="true" aria-controls="collapseReports">
                    <i class="fas fa-fw fa-chart-line"></i>
                    <span>Reports & Analytics</span>
                </a>
                <div id="collapseReports" class="collapse" aria-labelledby="headingReports" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Sales Reports:</h6>
                        <a class="collapse-item" href="{% url 'store:daily_sales' %}">
                            <i class="fas fa-calendar-day"></i> Daily Sales</a>
                        <a class="collapse-item" href="{% url 'store:monthly_sales' %}">
                            <i class="fas fa-calendar-alt"></i> Monthly Sales</a>
                        <a class="collapse-item" href="{% url 'store:sales_by_user' %}">
                            <i class="fas fa-user-chart"></i> Sales by User (Retail)</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesales_by_user' %}">
                            <i class="fas fa-user-chart"></i> Sales by User (Wholesale)</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Dispensing Reports:</h6>
                        <a class="collapse-item" href="{% url 'store:dispensing_log' %}">
                            <i class="fas fa-clipboard-list"></i> Dispensing Log</a>
                        {% if user.is_superuser or user.is_staff or user.profile.user_type == 'Admin' or user.profile.user_type == 'Manager' %}
                        <a class="collapse-item" href="{% url 'store:user_dispensing_summary' %}">
                            <i class="fas fa-chart-bar"></i> All Users Summary</a>
                        <a class="collapse-item" href="{% url 'store:user_dispensing_details' %}">
                            <i class="fas fa-list-alt"></i> All Users Details</a>
                        {% endif %}
                        <a class="collapse-item" href="{% url 'store:user_dispensing_summary' %}">
                            <i class="fas fa-user-chart"></i> My Summary</a>
                        <a class="collapse-item" href="{% url 'store:my_dispensing_details' %}">
                            <i class="fas fa-user-cog"></i> My Details</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Customer Reports:</h6>
                        <a class="collapse-item" href="{% url 'store:monthly_customer_performance' %}">
                            <i class="fas fa-users-cog"></i> Monthly Customer Performance</a>
                        <a class="collapse-item" href="{% url 'store:yearly_customer_performance' %}">
                            <i class="fas fa-chart-line"></i> Yearly Customer Performance</a>
                        <a class="collapse-item" href="{% url 'store:customer_list' %}">
                            <i class="fas fa-history"></i> Retail Customer Records</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_customers' %}">
                            <i class="fas fa-history"></i> Wholesale Customer Records</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Receipts:</h6>
                        <a class="collapse-item" href="{% url 'store:receipt_list' %}">
                            <i class="fas fa-receipt"></i> Retail Receipts</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_receipt_list' %}">
                            <i class="fas fa-receipt"></i> Wholesale Receipts</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== FINANCE ==================== -->
            <div class="sidebar-heading">
                Finance
            </div>

            <!-- Finance -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseFinance"
                    aria-expanded="true" aria-controls="collapseFinance">
                    <i class="fas fa-fw fa-dollar-sign"></i>
                    <span>Finance</span>
                </a>
                <div id="collapseFinance" class="collapse" aria-labelledby="headingFinance" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Customer Accounts:</h6>
                        <a class="collapse-item" href="{% url 'store:customer_list' %}">
                            <i class="fas fa-wallet"></i> Retail Customer Funds</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_customers' %}">
                            <i class="fas fa-wallet"></i> Wholesale Customer Funds</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Expenses:</h6>
                        <a class="collapse-item" href="{% url 'store:expense_list' %}">
                            <i class="fas fa-list"></i> View Expenses</a>
                        {% comment %} <a class="collapse-item" href="{% url 'store:add_expense_form' %}">
                            <i class="fas fa-plus"></i> Add Expense</a> {% endcomment %}
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== PROCUREMENT ==================== -->
            <div class="sidebar-heading">
                Procurement
            </div>

            <!-- Procurement -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseProcurement"
                    aria-expanded="true" aria-controls="collapseProcurement">
                    <i class="fas fa-fw fa-truck"></i>
                    <span>Procurement</span>
                </a>
                <div id="collapseProcurement" class="collapse" aria-labelledby="headingProcurement" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Suppliers:</h6>
                        <a class="collapse-item" href="{% url 'store:register_supplier_view' %}">
                            <i class="fas fa-user-plus"></i> Register Supplier</a>
                        <a class="collapse-item" href="{% url 'store:supplier_list' %}">
                            <i class="fas fa-list"></i> Supplier List</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Procurement :</h6>
                        <a class="collapse-item" href="{% url 'store:add_procurement' %}">
                            <i class="fas fa-plus"></i> New Procurement</a>
                        <a class="collapse-item" href="{% url 'store:procurement_list' %}">
                            <i class="fas fa-list"></i> Procurement List</a>
                        <a class="collapse-item" href="{% url 'store:search_procurement' %}">
                            <i class="fas fa-search"></i> Search Procurement</a>
                        <div class="collapse-divider"></div>
                        {% comment %} <h6 class="collapse-header">Procurement (Wholesale):</h6>
                        <a class="collapse-item" href="{% url 'wholesale:add_wholesale_procurement' %}">
                            <i class="fas fa-plus"></i> New Procurement</a>
                        <a class="collapse-item" href="{% url 'wholesale:wholesale_procurement_list' %}">
                            <i class="fas fa-list"></i> Procurement List</a>
                        <a class="collapse-item" href="{% url 'wholesale:search_wholesale_procurement' %}">
                            <i class="fas fa-search"></i> Search Procurement</a> {% endcomment %}
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Analytics:</h6>
                        <a class="collapse-item" href="{% url 'store:supplier_monthly_analytics' %}">
                            <i class="fas fa-chart-line"></i> Monthly Analytics</a>
                        <a class="collapse-item" href="{% url 'store:supplier_performance_dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Performance Dashboard</a>
                        <a class="collapse-item" href="{% url 'store:enhanced_procurement_search' %}">
                            <i class="fas fa-search-plus"></i> Advanced Search</a>
                        <a class="collapse-item" href="{% url 'store:supplier_comparison' %}">
                            <i class="fas fa-balance-scale"></i> Supplier Comparison</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== COMMUNICATION ==================== -->
            <div class="sidebar-heading">
                Communication
            </div>

            <!-- Communication -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseCommunication"
                    aria-expanded="true" aria-controls="collapseCommunication">
                    <i class="fas fa-fw fa-comments"></i>
                    <span>Communication</span>
                </a>
                <div id="collapseCommunication" class="collapse" aria-labelledby="headingCommunication" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Chat & Notifications:</h6>
                        <a class="collapse-item" href="{% url 'chat:chat_view_default' %}">
                            <i class="fas fa-comments"></i> Chat System
                            <span id="sidebar-unread-badge" class="badge badge-danger badge-counter" style="display: none;">0</span>
                        </a>
                        {% if user.profile.user_type == 'Admin' or user.profile.user_type == 'Manager' %}
                        <a class="collapse-item" href="{% url 'chat:bulk_message' %}">
                            <i class="fas fa-bullhorn"></i> Bulk Message</a>
                        {% endif %}
                        <a class="collapse-item" href="{% url 'store:notification_list' %}">
                            <i class="fas fa-bell"></i> Notifications
                            <span id="notification-badge" class="badge badge-warning badge-counter" style="display: none;">0</span>
                        </a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Notebook:</h6>
                        <a class="collapse-item" href="{% url 'notebook:dashboard' %}">
                            <i class="fas fa-tachometer-alt"></i> Dashboard</a>
                        <a class="collapse-item" href="{% url 'notebook:note_list' %}">
                            <i class="fas fa-sticky-note"></i> All Notes</a>
                        <a class="collapse-item" href="{% url 'notebook:note_create' %}">
                            <i class="fas fa-plus"></i> New Note</a>
                        <a class="collapse-item" href="{% url 'notebook:archived_notes' %}">
                            <i class="fas fa-archive"></i> Archived Notes</a>
                        <a class="collapse-item" href="{% url 'notebook:category_list' %}">
                            <i class="fas fa-tags"></i> Categories</a>
                        <a class="collapse-item" href="{% url 'notebook:category_create' %}">
                            <i class="fas fa-plus"></i> New Category</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- ==================== ADMINISTRATION ==================== -->
            <div class="sidebar-heading">
                Administration
            </div>

            <!-- Administration -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseAdmin"
                    aria-expanded="true" aria-controls="collapseAdmin">
                    <i class="fas fa-fw fa-user-cog"></i>
                    <span>Administration</span>
                </a>
                <div id="collapseAdmin" class="collapse" aria-labelledby="headingAdmin" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">User Management:</h6>
                        <a class="collapse-item" href="{% url 'userauth:register' %}">
                            <i class="fas fa-user-plus"></i> User Registration</a>
                        <a class="collapse-item" href="{% url 'userauth:user_list' %}">
                            <i class="fas fa-users"></i> User Management</a>
                        <a class="collapse-item" href="{% url 'userauth:privilege_management_view' %}">
                            <i class="fas fa-lock"></i> User Privileges</a>
                        <a class="collapse-item" href="{% url 'userauth:profile' %}">
                            <i class="fas fa-user-circle"></i> My Profile</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">System Monitoring:</h6>
                        {% if user|has_permission:"view_activity_logs" %}
                        <a class="collapse-item" href="{% url 'userauth:activity_dashboard' %}">
                            <i class="fas fa-chart-line"></i> Activity Logs</a>
                        {% endif %}
                        <!--<a class="collapse-item" href="{% url 'admin:index' %}">-->
                        <!--    <i class="fas fa-cog"></i> Django Admin</a>-->
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Communication Admin:</h6>
                        <a class="collapse-item" href="{% url 'chat:chat_view_default' %}">
                            <i class="fas fa-comments"></i> Chat Management</a>
                        {% if user.profile.user_type == 'Admin' or user.profile.user_type == 'Manager' %}
                        <a class="collapse-item" href="{% url 'chat:bulk_message' %}">
                            <i class="fas fa-bullhorn"></i> Bulk Message</a>
                        {% endif %}

                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0 lg" id="sidebarToggle"></button>
            </div>

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-dark bg-info topbar mb-4 static-top shadow">

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar marquee -->
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-head text-xs" style="color: red;">
                            INFORMATION
                            <div class="marquee-container">
                                <div id="marquee-wrapper" class="d-flex align-items-center">
                                    <marquee id="dynamic-marquee" behavior="" direction="">
                                        <h4 class="marquee-text">{% if marquee_text %}{{ marquee_text }}{% else %}WELCOME TO NAZZ PHARMACY{% endif %}</h4>
                                    </marquee>

                                </div>
                                <div id="marquee-edit" style="display: none;" class="d-flex align-items-center">
                                    {% comment %} <input type="text"
                                           id="marquee-input"
                                           class="form-control form-control-sm me-2"
                                           value="{% if marquee_text %}{{ marquee_text }}{% else %}WELCOME TO NAZZ PHARMACY{% endif %}">
                                           {% if user.is_superuser %}
                                           <button class="btn btn-sm btn-primary ms-2 mx-5"
                                                   onclick="toggleMarqueeEdit()"
                                                   style="position: absolute; right: 10px; z-index: 1000;">
                                               <i class="fas fa-edit"></i>
                                           </button>
                                       {% endif %}
                                    <button class="btn btn-sm btn-success me-1" onclick="saveMarquee()">
                                        <i class="fas fa-save"></i>
                                    </button> {% endcomment %}
                                    {% comment %} <button class="btn btn-sm btn-danger" onclick="toggleMarqueeEdit()">
                                        <i class="fas fa-times"></i>
                                    </button> {% endcomment %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">

                        <!-- Nav Item - Alerts -->
                        <li class="nav-item dropdown no-arrow mx-1">
                            {% comment %} <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-bell fa-fw"></i>
                                <!-- Counter - Alerts -->
                                <span class="badge badge-danger badge-counter">3+</span> {% endcomment %}
                            </a>
                            <!-- Dropdown - Alerts -->
                            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="alertsDropdown">
                                <h6 class="dropdown-header">
                                    Alerts Center
                                </h6>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="mr-3">
                                        <div class="icon-circle bg-primary">
                                            <i class="fas fa-file-alt text-white"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="small text-gray-500">December 12, 2019</div>
                                        <span class="font-weight-bold">A new monthly report is ready to download!</span>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="mr-3">
                                        <div class="icon-circle bg-success">
                                            <i class="fas fa-donate text-white"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="small text-gray-500">December 7, 2019</div>
                                        $290.29 has been deposited into your account!
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="mr-3">
                                        <div class="icon-circle bg-warning">
                                            <i class="fas fa-exclamation-triangle text-white"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="small text-gray-500">December 2, 2019</div>
                                        Spending Alert: We've noticed unusually high spending for your account.
                                    </div>
                                </a>
                                <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                            </div>
                        </li>

                        <!-- Nav Item - Messages -->
                        <li class="nav-item dropdown no-arrow mx-1">
                            {% comment %} <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-envelope fa-fw"></i>
                                <!-- Counter - Messages -->
                                <span class="badge badge-danger badge-counter">7</span>
                            </a> {% endcomment %}
                            <!-- Dropdown - Messages -->
                            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="messagesDropdown">
                                <h6 class="dropdown-header">
                                    Message Center
                                </h6>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3">
                                        <img class="rounded-circle" src="{% static 'img/undraw_profile_1.svg' %}"
                                            alt="...">
                                        <div class="status-indicator bg-success"></div>
                                    </div>
                                    <div class="font-weight-bold">
                                        <div class="text-truncate">Hi there! I am wondering if you can help me with a
                                            problem I've been having.</div>
                                        <div class="small text-gray-500">Emily Fowler · 58m</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3">
                                        <img class="rounded-circle" src="{% static 'img/undraw_profile_2.svg' %}"
                                            alt="...">
                                        <div class="status-indicator"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">I have the photos that you ordered last month, how
                                            would you like them sent to you?</div>
                                        <div class="small text-gray-500">Jae Chun · 1d</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3">
                                        <img class="rounded-circle" src="{% static 'img/undraw_profile_3.svg' %}"
                                            alt="...">
                                        <div class="status-indicator bg-warning"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">Last month's report looks great, I am very happy with
                                            the progress so far, keep up the good work!</div>
                                        <div class="small text-gray-500">Morgan Alvarez · 2d</div>
                                    </div>
                                </a>
                                <a class="dropdown-item d-flex align-items-center" href="#">
                                    <div class="dropdown-list-image mr-3">
                                        <img class="rounded-circle" src="https://source.unsplash.com/Mv9hjnEUHR4/60x60"
                                            alt="...">
                                        <div class="status-indicator bg-success"></div>
                                    </div>
                                    <div>
                                        <div class="text-truncate">Am I a good boy? The reason I ask is because someone
                                            told me that people say this to all dogs, even if they aren't good...</div>
                                        <div class="small text-gray-500">Chicken the Dog · 2w</div>
                                    </div>
                                </a>
                                <a class="dropdown-item text-center small text-gray-500" href="#">Read More Messages</a>
                            </div>
                        </li>

                        <div class="topbar-divider d-none d-sm-block"></div>


                        {% if user.is_authenticated %}
                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-white-600 small">
                                    {{ user.username|upper }}</span>
                                <img class="img-profile rounded-circle"
                                    src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}{% static 'img/undraw_profile.svg' %}{% endif %}">
                            </a>
                            <!-- Dropdown - User Information -->
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="{% url 'userauth:profile' %}">
                                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Profile
                                </a>
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Settings
                                </a>
                                <a class="dropdown-item" href="{% url 'userauth:activity_dashboard' %}">
                                    <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Activity Log
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                        {% else %}
                        <a href="{% url 'store:index' %}" class="btn btn-outline-light btn-sm my-3"
                            style="font-weight: bolder;">Login</a>
                        {% endif %}

                    </ul>

                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                        {% if not request.user.is_authenticated %}
                        <h2 style="color: rgb(255, 3, 3); text-align:center; font-weight:bold">Please log in to continue.</h2>
                        {% endif %}
                    </div>

                    <!-- Content Row -->
                    <div class="row">

                        <!-- Store Card Example -->
                        <a href="{% url 'store:store' %}" class="col-xl-3 col-md-6 mb-4 nazz"
                            style="text-decoration: none;">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                STORE</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">RETAILING</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-store fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- Wholesale Card Example -->
                        <a href="{% url 'wholesale:wholesales' %}" class="col-xl-3 col-md-6 mb-4 nazz"
                            style="text-decoration: none;">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                STORE</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">WHOLESALE</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-store fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- Total Purchase value Card -->
                        {% if user|can_view_financial_data %}
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">TOTAL
                                                PURCHASE VALUE
                                            </div>
                                            <div class="row no-gutters align-items-center">
                                                <div class="col-auto">
                                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">
                                                        ₦{{total_purchase_value|intcomma}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Total stock Card Example -->
                        {% if user|can_view_financial_data %}
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                TOTAL STOCK VALUE:</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">₦{{total_stock_value|intcomma}}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Content Row -->

                    <div class="row">


                        <!-- Area Chart -->
                        <div class="col-12">
                            {% block content %}
                            <div id="display"></div>
                            {% endblock content %}
                        </div>

                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Nazz Tech <span>2025</span>. All rights reserved.</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a class="btn btn-sm btn-danger" href="{% url 'store:logout_user' %}">Logout</a>
                </div>
            </div>
        </div>
    </div>



    <!-- Register Retail Customers modal -->
    <div class="modal fade" id="registerCustomerModal" tabindex="-1" aria-labelledby="registerCustomerModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>REGISTER CUSTOMER</h3>
                    <button class="close" data-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'store:register_customers' %}" method="post">
                        {% csrf_token %}
                        <input type="text" name="name" placeholder="Customer name..." class="form-control" required>
                        <input type="number" name="phone" placeholder="Phone number" class="form-control mt-3" required>
                        <input type="text" name="address" placeholder="Address" class="form-control mt-3" required>
                        <input type="submit" value="Register" class="btn btn-sm btn-success mt-3 ">
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Register Wholesale customer modal -->
    <div class="modal fade" id="registerWholesaleCustomerModal" tabindex="-1"
        aria-labelledby="registerWholesaleCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>REGISTER WHOLESALE CUSTOMER</h5>
                    <button class="close" data-bs-dismiss="modal" aria-label="Close">x</button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'wholesale:register_wholesale_customers' %}" method="post">
                        {% csrf_token %}
                        <input type="text" name="name" placeholder="Customer name..." class="form-control" required>
                        <input type="number" name="phone" placeholder="Phone number" class="form-control mt-3" required>
                        <input type="text" name="address" placeholder="Address" class="form-control mt-3" required>
                        <input type="submit" value="Register" class="btn btn-sm btn-success mt-3 ">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Retail customer modal -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

            </div>
        </div>
    </div>



    <!-- Transfer Request Modal -->
    <div class="modal fade" id="transferRequestModal" tabindex="-1" aria-labelledby="transferRequestModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="transferRequestModalContent">
            <!-- HTMX will load form content here -->
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal for Barcode Scanner -->
    {% include 'partials/add_item_modal.html' %}


    <div class="offline-status-container">
        <div id="connection-status">
            <div class="status-indicator">
                <span class="status-dot online"></span>
                <span class="status-text">Online</span>
            </div>
            <div class="sync-status hidden">
                <span class="sync-icon">↻</span>
                <span class="sync-text">Syncing...</span>
            </div>
        </div>
        {% if user.is_authenticated %}
            <button id="sync-button" class="btn btn-sm btn-primary">Sync Data</button>
        {% endif %}
    </div>


{% comment %} Provide csrf token to transfer-request {% endcomment %}
    <script>
        // Configure HTMX CSRF token using multiple approaches for robustness
        document.body.addEventListener("htmx:configRequest", (event) => {
            try {
                if (event && event.detail && event.detail.headers) {
                    // Method 1: Direct template variable (most reliable)
                    event.detail.headers["X-CSRFToken"] = "{{ csrf_token }}";

                    // Method 2: Read from meta tag (fallback)
                    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    if (csrfMeta) {
                        const csrfToken = csrfMeta.getAttribute('content');
                        if (csrfToken && csrfToken !== '') {
                            event.detail.headers["X-CSRFToken"] = csrfToken;
                        }
                    }

                    console.log('HTMX CSRF token set:', event.detail.headers["X-CSRFToken"]);
                }
            } catch (error) {
                console.error('Error setting CSRF token in HTMX:', error);
            }
        });

        // Debug: Log CSRF token availability
        console.log('CSRF token available in template:', '{{ csrf_token }}' !== '');
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        console.log('CSRF meta tag available:', csrfMeta !== null);
        if (csrfMeta) {
            console.log('CSRF meta tag content:', csrfMeta.getAttribute('content'));
        }
    </script>
    <script>
        // Method 3: Configure HTMX to automatically handle CSRF tokens
        // This sets up HTMX to read CSRF token from the meta tag automatically
        document.addEventListener('DOMContentLoaded', function() {
            // HTMX should automatically read from meta[name="csrf-token"]
            // This is a fallback configuration if the automatic detection doesn't work
            if (typeof htmx !== 'undefined') {
                htmx.config.globalHeaders = {
                    'X-CSRFToken': '{{ csrf_token }}'
                };
                console.log('HTMX global headers configured with CSRF token');
            }
        });
    </script>




    <script>
        // Warn users 10 minutes before session expiration
        const timeoutWarning = 20 * 60 * 1000; // 10 minute
        const logoutUrl = "{% url 'store:index' %}";

        let timeoutTimer;

        function startTimer() {
            timeoutTimer = setTimeout(() => {
                window.location.href = logoutUrl;
            }, ({{ SESSION_COOKIE_AGE|default:5200 }} * 1000) - timeoutWarning);
            // Fallback to 5200 (20 minutes) if SESSION_COOKIE_AGE is not in context

            // Reset timer on any activity
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);
        }

        function resetTimer() {
            clearTimeout(timeoutTimer);
            startTimer();
        }

        startTimer();
    </script>

    <!-- Notebook New Notes Indicator Script -->
    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notebookIndicator = document.getElementById('notebook-new-indicator');

            function checkForNewNotes() {
                fetch('/notebook/api/new-notes-count/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.new_notes_count > 0) {
                            notebookIndicator.textContent = data.new_notes_count;
                            notebookIndicator.style.display = 'inline';
                        } else {
                            notebookIndicator.style.display = 'none';
                        }
                    })
                    .catch(error => console.error('Error checking new notes:', error));
            }

            // Check for new notes every 30 seconds
            if (notebookIndicator) {
                checkForNewNotes(); // Initial check
                setInterval(checkForNewNotes, 30000); // Check every 30 seconds
            }
        });
    </script>
    {% endif %}


    <!-- Bootstrap core JavaScript-->
    <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>

    <!-- Configure jQuery AJAX to include CSRF token for all requests -->
    <script>
        // Set up CSRF token for all jQuery AJAX requests
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                }
            }
        });
    </script>

    <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <!-- Core plugin JavaScript-->
    <script src="{% static 'vendor/jquery-easing/jquery.easing.min.js' %}"></script>

    <!-- Custom scripts for all pages-->
    <script src="{% static 'js/sb-admin-2.min.js' %}"></script>

    <!-- Page level plugins -->
    <script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>

    <!-- Page level custom scripts -->

    <!-- User Permissions for JavaScript -->
    <script>
        window.userPermissions = {
            canManageItems: {% if can_manage_items %}true{% else %}false{% endif %},
            isAdmin: {% if is_admin %}true{% else %}false{% endif %},
            isManager: {% if is_manager %}true{% else %}false{% endif %},
            canManageInventory: {% if can_manage_inventory %}true{% else %}false{% endif %}
        };
    </script>

    <!-- Offline-first functionality scripts -->
    <script src="{% static 'js/indexeddb-manager.js' %}"></script>
    <script src="{% static 'js/sync-manager.js' %}"></script>
    <script src="{% static 'js/offline-handler.js' %}"></script>
    <script src="{% static 'js/offline-helpers.js' %}"></script>

    <!-- Barcode/QR-code scanning library - load from local static with CDN fallback -->
    <script src="{% static 'vendor/html5-qrcode/html5-qrcode.min.js' %}"></script>
    <script>
        // Track library loading status
        window.barcodeLibraryStatus = 'loading';

        // Load Html5Qrcode with local-first approach and CDN fallback
        (function() {
            // First, try to load from local static (already loaded by script tag above)
            if (typeof Html5Qrcode !== 'undefined') {
                console.log('[Base] Html5Qrcode library loaded successfully from local static');
                window.barcodeLibraryStatus = 'loaded';
                loadScannerModules();
                return;
            }

            // If local load failed, try CDN fallback
            console.log('[Base] Local Html5Qrcode not available, trying CDN fallback...');
            window.barcodeLibraryStatus = 'error';

            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
            fallbackScript.async = false;
            fallbackScript.onload = function() {
                if (typeof Html5Qrcode !== 'undefined') {
                    console.log('[Base] Html5Qrcode loaded from CDN fallback');
                    window.barcodeLibraryStatus = 'loaded';
                    loadScannerModules();
                } else {
                    console.error('[Base] Html5Qrcode not available after CDN load');
                    window.barcodeLibraryStatus = 'failed';
                }
            };
            fallbackScript.onerror = function() {
                console.error('[Base] Both local and CDN failed to load Html5Qrcode');
                window.barcodeLibraryStatus = 'failed';
            };
            document.head.appendChild(fallbackScript);
        })();

        // Function to load scanner modules after Html5Qrcode is available
        function loadScannerModules() {
            // Verify Html5Qrcode is available
            if (typeof Html5Qrcode === 'undefined') {
                console.error('[Base] Html5Qrcode not available for scanner modules');
                return;
            }

            console.log('[Base] Html5Qrcode confirmed available, loading scanner modules...');

            // Load barcode-scanner.js
            const scannerScript = document.createElement('script');
            scannerScript.src = "{% static 'js/barcode-scanner.js' %}?v=3.1";
            scannerScript.onload = function() {
                console.log('[Base] Barcode scanner module loaded');

                // Load hardware scanner module
                const hardwareScript = document.createElement('script');
                hardwareScript.src = "{% static 'js/hardware-scanner.js' %}?v=3.1";
                hardwareScript.onload = function() {
                    console.log('[Base] Hardware scanner module loaded');

                    // Load cart integration module
                    const cartIntegrationScript = document.createElement('script');
                    cartIntegrationScript.src = "{% static 'js/barcode-cart-integration.js' %}?v=1.0";
                    cartIntegrationScript.onload = function() {
                        console.log('[Base] Barcode cart integration module loaded');
                        document.dispatchEvent(new Event('scannerModulesLoaded'));
                    };
                    cartIntegrationScript.onerror = function() {
                        console.error('[Base] Failed to load barcode-cart-integration.js');
                    };
                    document.head.appendChild(cartIntegrationScript);
                };
                hardwareScript.onerror = function() {
                    console.error('[Base] Failed to load hardware-scanner.js');
                };
                document.head.appendChild(hardwareScript);
            };
            scannerScript.onerror = function() {
                console.error('[Base] Failed to load barcode-scanner.js');
            };
            document.head.appendChild(scannerScript);
        }
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[Base Template] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.error('[Base Template] Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Custom script for footer copyright -->
    <script>
        const yearElement = document.getElementById('year');
        if (yearElement) {
            yearElement.innerHTML = new Date().getFullYear();
        }
    </script>

    <!-- Add this style section to your existing styles -->
    <style>
        .marquee-container {
            position: relative;
            width: 100%;
            padding: 0 10px;
        }

        #marquee-wrapper, #marquee-edit {
            width: 100%;
            position: relative;
        }

        #marquee-edit {
            padding: 5px 0;
        }

        .marquee-text {
            margin: 0;
            color: black;
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            min-width: 250px;
        }
    </style>

    <!-- Add this right before the closing body tag -->
    <div class="toast-container"></div>

    <!-- Add this to your existing scripts section -->
    <script>
        function toggleMarqueeEdit() {
            const wrapper = document.getElementById('marquee-wrapper');
            const edit = document.getElementById('marquee-edit');

            if (wrapper.style.display !== 'none') {
                wrapper.style.display = 'none';
                edit.style.display = 'flex';
                document.getElementById('marquee-input').focus();
            } else {
                wrapper.style.display = 'flex';
                edit.style.display = 'none';
            }
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show alert alert-${type}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function saveMarquee() {
            const newText = document.getElementById('marquee-input').value.trim();
            if (!newText) {
                showToast('Marquee text cannot be empty!', 'danger');
                return;
            }

            // Send AJAX request using fetch
            fetch("{% url 'store:update_marquee' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `marquee_text=${encodeURIComponent(newText)}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // Update the marquee content
                const marqueeElement = document.getElementById('dynamic-marquee');
                if (marqueeElement) {
                    marqueeElement.innerHTML = `<h4 class="marquee-text">${newText}</h4>`;
                }

                // Switch back to display mode
                toggleMarqueeEdit();

                // Show success message
                showToast('Marquee updated successfully!');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to update marquee!', 'danger');
            });
        }

        // Add keyboard event listener for the input
        const marqueeInput = document.getElementById('marquee-input');
        if (marqueeInput) {
            marqueeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveMarquee();
                } else if (e.key === 'Escape') {
                    toggleMarqueeEdit();
                }
            });
        }
    </script>

    <!-- Chat Unread Badge Update Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update chat unread badge in sidebar
        function updateChatUnreadBadge() {
            {% if user.is_authenticated %}
            fetch('{% url "chat:unread_messages_count" %}')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('sidebar-unread-badge');
                    if (badge) {
                        if (data.unread_count > 0) {
                            badge.textContent = data.unread_count;
                            badge.style.display = 'inline';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(error => console.error('Error fetching unread count:', error));
            {% endif %}
        }

        // Update immediately and then every 30 seconds
        updateChatUnreadBadge();
        setInterval(updateChatUnreadBadge, 30000);

        // Update notification badge
        function updateNotificationBadge() {
            {% if user.is_authenticated %}
            fetch('{% url "store:notification_count_api" %}')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notification-badge');
                    if (badge) {
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.style.display = 'inline';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(error => console.error('Error updating notification count:', error));
            {% endif %}
        }

        // Update notification badge immediately and then every 30 seconds
        updateNotificationBadge();
        setInterval(updateNotificationBadge, 30000);
    });
    </script>

    <!-- Performance optimization: defer non-critical scripts -->
    <script>
        // Preload critical resources
        function preloadCriticalResources() {
            const criticalUrls = [
                '{% static "js/realtime-chat.js" %}',
                '{% static "vendor/jquery/jquery.min.js" %}',
                '{% static "vendor/bootstrap/js/bootstrap.bundle.min.js" %}'
            ];

            criticalUrls.forEach(url => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'script';
                link.href = url;
                document.head.appendChild(link);
            });
        }

        // Initialize preloading
        preloadCriticalResources();
    </script>

    <!-- Real-time Chat Scripts with defer loading -->
    <script src="{% static 'js/realtime-chat.js' %}" defer></script>
    <script>
    // Global real-time chat initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Set user ID for real-time chat
        document.body.dataset.userId = '{{ request.user.id }}';

        // Update unread badge more frequently when real-time chat is active
        if (typeof window.realtimeChat !== 'undefined') {
            // Override the update frequency for better real-time experience
            setInterval(updateChatUnreadBadge, 5000); // Update every 5 seconds instead of 30
        }
    });
    </script>

    <!-- Auto-refresh on page navigation/show (Offline-Aware) -->
    <script>
    // Auto-refresh functionality that respects offline mode
    (function() {
        // Check if user is online before attempting refresh
        function isOnline() {
            return navigator.onLine;
        }

        // Force page reload when user navigates back/forward to prevent stale data
        // BUT ONLY if online to preserve offline functionality
        window.addEventListener('pageshow', function(event) {
            // Check if page is loaded from cache (bfcache)
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                // Only reload if online - preserve offline mode functionality
                if (isOnline()) {
                    console.log('[Auto-Refresh] Reloading page to prevent stale data (online mode)');
                    window.location.reload();
                } else {
                    console.log('[Auto-Refresh] Skipping reload - offline mode active');
                }
            }
        });

        // Also handle visibility change to refresh when tab becomes visible after being hidden
        // BUT ONLY if online
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isOnline()) {
                // Tab became visible and we're online, check if data might be stale
                const lastRefresh = sessionStorage.getItem('lastPageRefresh');
                const now = Date.now();

                // If last refresh was more than 30 seconds ago, reload
                if (!lastRefresh || (now - parseInt(lastRefresh)) > 30000) {
                    console.log('[Auto-Refresh] Refreshing stale page data (online mode)');
                    sessionStorage.setItem('lastPageRefresh', now.toString());
                    window.location.reload();
                } else {
                    console.log('[Auto-Refresh] Data still fresh, no reload needed');
                }
            } else if (!document.hidden && !isOnline()) {
                console.log('[Auto-Refresh] Skipping reload - offline mode active');
            }
        });

        // Update last refresh timestamp on page load
        sessionStorage.setItem('lastPageRefresh', Date.now().toString());

        // Listen for online/offline events to provide feedback
        window.addEventListener('online', function() {
            console.log('[Auto-Refresh] Connection restored - auto-refresh enabled');
        });

        window.addEventListener('offline', function() {
            console.log('[Auto-Refresh] Offline mode - auto-refresh disabled');
        });
    })();
    </script>

    <!-- Allow child templates to inject additional JavaScript -->
    {% block extra_js %}{% endblock %}
</body>

</html>

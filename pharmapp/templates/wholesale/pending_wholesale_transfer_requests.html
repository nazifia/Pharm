<!-- templates/wholesale/pending_wholesale_transfer_requests.html -->
{% extends "partials/base.html" %}
{% block content %}
<div class="container mt-4 table-responsive">
  {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} mt-2 text-center">{{ message }}</div>
            {% endfor %}
          {% endif %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Pending Transfer Requests (Wholesale Side)</h2>
    <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>
  
  {% if wholesale_pending_transfers %}
  <table class="table table-bordered table-hover shadow">
    <thead>
      <tr>
        <th>Item Name</th>
        <th>Item Unit</th>
        <th>Requested Qty</th>
        <th>Request Date</th>
        <th>Approved Qty & Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for transfer in wholesale_pending_transfers %}
      <tr id="transfer-{{ transfer.id }}">
        <td>
          {% if transfer.from_wholesale %}
            {{ transfer.retail_item.name|default:'Unknown Item' }}
          {% else %}
            {{ transfer.wholesale_item.name|default:'Unknown Item' }}
          {% endif %}
        </td>
        <td>
          {% if transfer.from_wholesale %}
            {{ transfer.retail_item.unit|default:'N/A' }}
          {% else %}
            {{ transfer.wholesale_item.unit|default:'N/A' }}
          {% endif %}
        </td>
        <td>{{ transfer.requested_quantity }}</td>
        <td>{{ transfer.created_at|date:"Y-m-d H:i" }}</td>
        <td>
          <!-- Inline form for approved quantity -->
          <form method="post"
                action="{% url 'wholesale:wholesale_approve_transfer' transfer.id %}"
                class="approve-form"
                style="display: inline;">
            {% csrf_token %}
            <div class="input-group input-group-sm mb-2" style="min-width: 150px;">
                <input type="number"
                       name="approved_quantity"
                       value="{% if transfer.approved_quantity %}{{ transfer.approved_quantity }}{% else %}{{ transfer.requested_quantity }}{% endif %}"
                       class="form-control form-control-sm"
                       min="1"
                       max="{% if transfer.from_wholesale %}{{ transfer.retail_item.stock|default:transfer.requested_quantity }}{% else %}{{ transfer.wholesale_item.stock|default:transfer.requested_quantity }}{% endif %}"
                       required
                       placeholder="Qty"
                       id="approved-qty-{{ transfer.id }}">
                <button type="submit" class="btn btn-sm btn-success" title="Approve with this quantity">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
          </form>

          <!-- Reject Form -->
          <form method="post"
                action="{% url 'wholesale:reject_wholesale_transfer' transfer.id %}"
                class="reject-form"
                style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger btn-block"
                    onclick="return confirm('Are you sure you want to reject this transfer request?')"
                    title="Reject this transfer"
                    style="width: 100%;">
                <i class="fas fa-times"></i> Reject
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle"></i>
        No pending transfer requests.
        <br>
        <small>You can <a href="{% url 'wholesale:create_transfer_request' %}" class="alert-link">create a new transfer request</a> if needed.</small>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Pending transfers page loaded');
    
    // Handle approve forms
    document.querySelectorAll('.approve-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Approve form submitted');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
            
            const formData = new FormData(this);
            const rowElement = this.closest('tr');
            const transferId = rowElement.id.replace('transfer-', '');
            
            console.log('Approving transfer:', transferId, 'Qty:', formData.get('approved_quantity'));
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Approve response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Approve response data:', data);
                if (data.success) {
                    // Update the row to show success
                    const approvedQty = rowElement.cells[4].querySelector('input').value;
                    rowElement.innerHTML = `
                        <td>${rowElement.cells[0].textContent}</td>
                        <td>${rowElement.cells[1].textContent}</td>
                        <td>${rowElement.cells[2].textContent}</td>
                        <td>${rowElement.cells[3].textContent}</td>
                        <td>
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle"></i> Approved (Qty: ${approvedQty})
                            </div>
                        </td>
                    `;
                    // Remove row after delay
                    setTimeout(() => {
                        rowElement.style.opacity = '0';
                        rowElement.style.transition = 'opacity 0.5s';
                        setTimeout(() => rowElement.remove(), 500);
                    }, 2000);
                } else {
                    // Show error in the row
                    const actionsCell = rowElement.querySelector('td:last-child');
                    actionsCell.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle"></i> ${data.message}
                        </div>
                    `;
                    // Reset form after delay
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Approve error:', error);
                const actionsCell = rowElement.querySelector('td:last-child');
                actionsCell.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Error occurred. Please try again.
                    </div>
                `;
                setTimeout(() => {
                    location.reload();
                }, 3000);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });
    
    // Handle reject forms
    document.querySelectorAll('.reject-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Reject form submitted');
            
            if (!confirm('Are you sure you want to reject this transfer request?')) {
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Rejecting...';
            
            const formData = new FormData(this);
            const rowElement = this.closest('tr');
            const transferId = rowElement.id.replace('transfer-', '');
            
            console.log('Rejecting transfer:', transferId);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Reject response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Reject response data:', data);
                if (data.success) {
                    // Update the row to show rejection
                    rowElement.innerHTML = `
                        <td>${rowElement.cells[0].textContent}</td>
                        <td>${rowElement.cells[1].textContent}</td>
                        <td>${rowElement.cells[2].textContent}</td>
                        <td>${rowElement.cells[3].textContent}</td>
                        <td>
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-times-circle"></i> Rejected
                            </div>
                        </td>
                    `;
                    // Mark row as rejected
                    rowElement.style.backgroundColor = '#f8d7da';
                    setTimeout(() => {
                        rowElement.style.opacity = '0';
                        rowElement.style.transition = 'opacity 0.5s';
                        setTimeout(() => rowElement.remove(), 500);
                    }, 3000);
                } else {
                    // Show error
                    const actionsCell = rowElement.querySelector('td:last-child');
                    actionsCell.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle"></i> ${data.message}
                        </div>
                    `;
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Reject error:', error);
                const actionsCell = rowElement.querySelector('td:last-child');
                actionsCell.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Error occurred. Please try again.
                    </div>
                `;
                setTimeout(() => {
                    location.reload();
                }, 3000);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    });
});
</script>
{% endblock %}

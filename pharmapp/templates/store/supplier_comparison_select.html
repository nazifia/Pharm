{% extends "partials/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-balance-scale mr-2"></i>Supplier Comparison
        </h1>
        <div class="btn-group" role="group">
            <a href="{% url 'store:supplier_monthly_analytics' %}" class="btn btn-info btn-sm">
                <i class="fas fa-chart-line mr-1"></i>Monthly Analytics
            </a>
            <a href="{% url 'store:supplier_performance_dashboard' %}" class="btn btn-success btn-sm">
                <i class="fas fa-tachometer-alt mr-1"></i>Performance Dashboard
            </a>
            <a href="{% url 'store:enhanced_procurement_search' %}" class="btn btn-warning btn-sm">
                <i class="fas fa-search mr-1"></i>Advanced Search
            </a>
        </div>
    </div>

    <!-- Supplier Selection Form -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-users mr-2"></i>Select Suppliers to Compare
            </h6>
        </div>
        <div class="card-body">
            <form method="get" action="{% url 'store:supplier_comparison' %}" id="comparisonForm">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label font-weight-bold">Choose Suppliers (Select 2-5 suppliers)</label>
                        <div class="row">
                            {% for supplier in suppliers %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-left-primary h-100">
                                        <div class="card-body p-3">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input supplier-checkbox" 
                                                       id="supplier_{{ supplier.id }}" name="suppliers" value="{{ supplier.id }}">
                                                <label class="custom-control-label" for="supplier_{{ supplier.id }}">
                                                    <strong>{{ supplier.name }}</strong>
                                                </label>
                                            </div>
                                            {% if supplier.phone %}
                                                <small class="text-muted d-block mt-1">
                                                    <i class="fas fa-phone mr-1"></i>{{ supplier.phone }}
                                                </small>
                                            {% endif %}
                                            {% if supplier.contact_info %}
                                                <small class="text-muted d-block">
                                                    <i class="fas fa-map-marker-alt mr-1"></i>{{ supplier.contact_info|truncatechars:30 }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-left-info h-100">
                            <div class="card-body">
                                <h6 class="font-weight-bold text-info mb-3">
                                    <i class="fas fa-calendar mr-2"></i>Date Range
                                </h6>
                                <div class="form-group">
                                    <label for="start_date" class="form-label">Start Date</label>
                                    <input type="date" name="start_date" id="start_date" class="form-control" 
                                           value="{{ request.GET.start_date }}">
                                </div>
                                <div class="form-group">
                                    <label for="end_date" class="form-label">End Date</label>
                                    <input type="date" name="end_date" id="end_date" class="form-control" 
                                           value="{{ request.GET.end_date }}">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary btn-block" id="compareBtn" disabled>
                                        <i class="fas fa-balance-scale mr-1"></i>Compare Suppliers
                                    </button>
                                </div>
                                <div class="alert alert-info mt-3" role="alert">
                                    <small>
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Select 2-5 suppliers to compare their performance metrics side by side.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-chart-bar mr-2"></i>Quick Statistics
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="border-left-primary p-3">
                        <h4 class="text-primary font-weight-bold">{{ suppliers.count }}</h4>
                        <p class="text-muted mb-0">Total Suppliers</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="border-left-success p-3">
                        <h4 class="text-success font-weight-bold">Active</h4>
                        <p class="text-muted mb-0">All Suppliers</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="border-left-info p-3">
                        <h4 class="text-info font-weight-bold">Compare</h4>
                        <p class="text-muted mb-0">Performance</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="border-left-warning p-3">
                        <h4 class="text-warning font-weight-bold">Analytics</h4>
                        <p class="text-muted mb-0">Available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-question-circle mr-2"></i>How to Use
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="font-weight-bold text-dark">Steps:</h6>
                    <ol class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Select 2-5 suppliers from the list above
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Choose your date range (optional)
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            Click "Compare Suppliers" to view detailed comparison
                        </li>
                    </ol>
                </div>
                <div class="col-md-6">
                    <h6 class="font-weight-bold text-dark">Comparison Includes:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-chart-line text-primary mr-2"></i>
                            Total procurement values
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-shopping-cart text-primary mr-2"></i>
                            Number of orders
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calculator text-primary mr-2"></i>
                            Average order values
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar text-primary mr-2"></i>
                            First and last procurement dates
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.supplier-checkbox');
    const compareBtn = document.getElementById('compareBtn');
    
    function updateCompareButton() {
        const checkedBoxes = document.querySelectorAll('.supplier-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count >= 2 && count <= 5) {
            compareBtn.disabled = false;
            compareBtn.innerHTML = '<i class="fas fa-balance-scale mr-1"></i>Compare ' + count + ' Suppliers';
        } else {
            compareBtn.disabled = true;
            if (count === 0) {
                compareBtn.innerHTML = '<i class="fas fa-balance-scale mr-1"></i>Select Suppliers';
            } else if (count === 1) {
                compareBtn.innerHTML = '<i class="fas fa-balance-scale mr-1"></i>Select at least 2 suppliers';
            } else {
                compareBtn.innerHTML = '<i class="fas fa-balance-scale mr-1"></i>Maximum 5 suppliers allowed';
            }
        }
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCompareButton);
    });
    
    // Set default date range (last 12 months)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setFullYear(endDate.getFullYear() - 1);
    
    if (!document.getElementById('start_date').value) {
        document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    }
    if (!document.getElementById('end_date').value) {
        document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    }
});
</script>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.custom-control-label {
    cursor: pointer;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}
</style>
{% endblock %}

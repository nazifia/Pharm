{% extends "partials/base.html" %}
{% load permission_tags %}
{% load store_filters %}
{% block content %}
<style>
  /* Style for manual price override */
  .manual-override-active {
    background-color: #fffacd; /* Light yellow background */
    border: 1px solid #ffd700; /* Gold border */
    font-weight: bold;
  }

  /* Style for the override checkbox */
  .price-override-checkbox:checked + label {
    font-weight: bold;
    color: #0056b3;
  }

  /* Style for the calculated price when override is active */
  .override-active .calculated-price {
    text-decoration: line-through;
    color: #6c757d;
  }
</style>
<div class="container mt-4" id="transfer-messages">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Transfer Wholesale Items</h2>
  </div>

  <!-- Search Field -->
  <div class="mb-3">
    <input type="text" name="search" id="search" style="width: 300px; background-color: lightblue;" class="form-control" placeholder="Search by item name or brand..."
           hx-get="{% url 'wholesale:transfer_multiple_wholesale_items' %}"
           hx-target="#wholesale-items"
           hx-trigger="keyup changed delay:100ms">
  </div>

  <!-- Messages (errors or successes) -->
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>

  <form id="transfer-form" method="post"
        hx-post="{% url 'wholesale:transfer_multiple_wholesale_items' %}"
        hx-target="#transfer-messages"
        hx-swap="outerHTML">
    {% csrf_token %}
    <table class="table table-bordered shadow table-hover table-responsive">
      <thead class="table-secondary">
        <tr>
          <th>
            <input type="checkbox" id="select-all-checkbox" title="Select All">
            <label for="select-all-checkbox" class="ml-1">Select All</label>
          </th>
          <th>Item Name</th>
          <th>D/form</th>
          <th>Brand</th>
          <th>Unit</th>
          <th>Stock</th>
          <th>Procurement Value</th>
          <th>R/Qty</th>
          <th>Transfer Unit</th>
          <th>Unit Conversion</th>
          <th>Markup (%)</th>
          <th>Price Override</th>
          <th>Destination</th>
        </tr>
      </thead>
      <!-- The tbody with id "wholesale-items" will be updated by the search HTMX call -->
      <tbody id="wholesale-items">
        {% for item in wholesale_items %}
        <tr id="wholesale-item-{{ item.id }}">
          <td>
            <input type="checkbox" name="select_{{ item.id }}">
            <input type="hidden" name="cost_{{ item.id }}" value="{{ item.cost }}">
          </td>
          <td>{{ item.name|upper }}</td>
          <td>{{ item.dosage_form }}</td>
          <td>{{ item.brand }}</td>
          <td>{{ item.unit }}</td>
          <td>
            {% if user|can_edit_transfer_item_quantity %}
            <div class="d-flex align-items-center">
              <span class="stock-display font-weight-bold" id="stock-display-{{ item.id }}">
                {{ item.stock }}
              </span>
              <button type="button"
                      class="btn btn-sm btn-link text-primary edit-stock-btn ml-2"
                      data-item-id="{{ item.id }}"
                      data-current-stock="{{ item.stock }}"
                      data-item-name="{{ item.name }}"
                      data-item-brand="{{ item.brand }}"
                      data-item-unit="{{ item.unit }}"
                      data-toggle="tooltip"
                      title="Edit stock quantity">
                <i class="fas fa-edit"></i>
              </button>
            </div>
            {% else %}
            <span class="font-weight-bold">{{ item.stock }}</span>
            {% endif %}
          </td>
          <td class="procurement-value text-center"
              data-cost="{{ item.cost }}"
              data-stock="{{ item.stock }}">
            <span class="badge badge-info badge-lg" style="font-size: 0.95rem;">
              ₦<span class="item-proc-value">{{ item.cost|multiply:item.stock|floatformat:2 }}</span>
            </span>
            <br>
            <small class="text-muted">
              ₦{{ item.cost|floatformat:2 }} × {{ item.stock }}
            </small>
          </td>
          <td>
            <input type="number" name="quantity_{{ item.id }}" style="width:100px;" class="form-control" min="0" value="0" step="0.5">
          </td>
          <td>
            <select name="transfer_unit_{{ item.id }}" style="width:130px;" class="form-control unit-select" data-item-id="{{ item.id }}">
              <option value="{{ item.unit }}" selected>{{ item.unit }}</option>
              {% for unit_value, unit_display in unit_choices %}
                {% if unit_value != item.unit %}
                  <option value="{{ unit_value }}">{{ unit_display }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="number" name="unit_conversion_{{ item.id }}" style="width:100px;" class="form-control unit-conversion" value="1" step="0.1">
            <small class="text-muted conversion-label">1 {{ item.unit }} = <span class="conversion-value">1</span> <span class="target-unit">{{ item.unit }}</span></small>
          </td>
          <td>
            <select name="markup_{{ item.id }}" style="width:150px;" class="form-control markup-select" data-item-id="{{ item.id }}">
              <option value="0">Select Markup</option>
              <option value="2.5">2.5% markup</option>
              <option value="5">5% markup</option>
              <option value="7.5">7.5% markup</option>
              <option value="10">10% markup</option>
              <option value="12.5">12.5% markup</option>
              <option value="15">15% markup</option>
              <option value="17.5">17.5% markup</option>
              <option value="20">20% markup</option>
              <option value="22.5">22.5% markup</option>
              <option value="25">25% markup</option>
              <option value="27.5">27.5% markup</option>
              <option value="30">30% markup</option>
              <option value="32.5">32.5% markup</option>
              <option value="35">35% markup</option>
              <option value="37.5">37.5% markup</option>
              <option value="40">40% markup</option>
              <option value="42.5">42.5% markup</option>
              <option value="45">45% markup</option>
              <option value="47.5">47.5% markup</option>
              <option value="50">50% markup</option>
              <option value="52.5">52.5% markup</option>
              <option value="55">55% markup</option>
              <option value="57.5">57.5% markup</option>
              <option value="60">60% markup</option>
              <option value="62.5">62.5% markup</option>
              <option value="65">65% markup</option>
              <option value="67.5">67.5% markup</option>
              <option value="70">70% markup</option>
              <option value="72.5">72.5% markup</option>
              <option value="75">75% markup</option>
              <option value="77.5">77.5% markup</option>
              <option value="80">80% markup</option>
              <option value="82.5">82.5% markup</option>
              <option value="85">85% markup</option>
              <option value="87.5">87.5% markup</option>
              <option value="90">90% markup</option>
              <option value="92.5">92.5% markup</option>
              <option value="95">95% markup</option>
              <option value="97.5">97.5% markup</option>
              <option value="100">100% markup</option>
            </select>
          </td>
          <td>
            <div class="form-check mb-1">
              <input type="checkbox" class="form-check-input price-override-checkbox" id="price_override_{{ item.id }}" name="price_override_{{ item.id }}">
              <label class="form-check-label" for="price_override_{{ item.id }}">Override</label>
            </div>
            <div class="mb-1">
              <small class="text-muted">Calculated: <span class="calculated-price" id="calculated_price_{{ item.id }}">0.00</span></small>
            </div>
            <div class="input-group" style="width:150px;">
              <input type="number" name="manual_price_{{ item.id }}" class="form-control manual-price" min="0" value="0" step="0.01" placeholder="Enter selling price">
              <div class="input-group-append">
                <span class="input-group-text">₦</span>
              </div>
            </div>
            <small class="text-muted d-block mt-1">Enter price to override calculated value</small>
          </td>
          <td>
            <select name="destination_{{ item.id }}" class="form-control" style="width:130px;">
              <option value="">Select</option>
              <option value="retail">Retail</option>
              <option value="wholesale">Wholesale</option>
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="submit" class="btn btn-sm btn-primary">Process Transfers</button>
  </form>

  <!-- Procurement Values Summary -->
  <div class="card mt-4 shadow-sm border-info">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">
        <i class="fas fa-chart-line"></i> Procurement Values Summary
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 col-sm-6 mb-3">
          <div class="text-center">
            <small class="text-muted d-block">Total Items</small>
            <h3 class="mb-0 text-primary">
              <span id="total-items-count">{{ wholesale_items.count }}</span>
            </h3>
          </div>
        </div>
        <div class="col-md-4 col-sm-6 mb-3">
          <div class="text-center">
            <small class="text-muted d-block">Average Item Value</small>
            <h4 class="mb-0 text-info">
              ₦<span id="average-item-value">0.00</span>
            </h4>
          </div>
        </div>
        <div class="col-md-4 col-sm-12 mb-3">
          <div class="text-center">
            <small class="text-muted d-block">Grand Total Procurement Value</small>
            <h2 class="mb-0 text-success font-weight-bold">
              ₦<span id="grand-procurement-total">0.00</span>
            </h2>
          </div>
        </div>
      </div>
      <hr>
      <p class="mb-0 text-muted small">
        <i class="fas fa-info-circle"></i>
        Procurement values are calculated as: Cost Price × Current Stock Quantity
      </p>
    </div>
  </div>
</div>

{% if user|can_edit_transfer_item_quantity %}
<!-- Edit Stock Quantity Modal -->
<div class="modal fade" id="editStockModal" tabindex="-1" role="dialog" aria-labelledby="editStockModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="editStockModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Edit Stock Quantity
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Warning -->
        <div class="alert alert-warning">
          <strong><i class="fas fa-exclamation-triangle"></i> Warning:</strong>
          This will permanently change the item's stock quantity in the database.
          This action is logged for audit purposes.
        </div>

        <!-- Form -->
        <form id="editStockForm">
          <input type="hidden" id="edit-item-id">

          <div class="form-group">
            <label class="font-weight-bold">Item:</label>
            <p class="form-control-plaintext" id="edit-item-info"></p>
          </div>

          <div class="form-group">
            <label for="edit-current-stock">Current Stock:</label>
            <input type="text"
                   class="form-control"
                   id="edit-current-stock"
                   readonly
                   style="background-color: #f8f9fa;">
          </div>

          <div class="form-group">
            <label for="edit-new-stock" class="font-weight-bold">
              New Stock Quantity: <span class="text-danger">*</span>
            </label>
            <input type="number"
                   class="form-control"
                   id="edit-new-stock"
                   min="0"
                   step="0.1"
                   required
                   placeholder="Enter new quantity">
            <small class="form-text text-muted">
              Enter 0 or greater. Decimals allowed (e.g., 15.5).
            </small>
          </div>

          <!-- Error display -->
          <div id="edit-stock-error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-circle"></i> <span class="error-text"></span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-primary" id="saveStockBtn">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  // Global function to trigger price calculation from inline event handlers
  function triggerPriceCalculation(selectElement) {
    console.log('Direct markup change triggered for:', selectElement.name);
    console.log('New value:', selectElement.value);
    const row = selectElement.closest('tr');
    if (row) {
      // Get the item ID from the select name
      const itemId = selectElement.name.split('_')[1];
      console.log('Item ID:', itemId);

      // Get the cost input
      const costInput = row.querySelector('input[name="cost_' + itemId + '"]');
      console.log('Cost input value:', costInput ? costInput.value : 'not found');

      // Calculate the selling price
      calculateSellingPrice(row);
    } else {
      console.error('Could not find row for select element:', selectElement);
    }
  }

  // Define the calculateSellingPrice function globally with full implementation
  window.calculateSellingPrice = function(row) {
    console.log('Global calculateSellingPrice called with row:', row);

    if (!row) {
      console.error('No row provided to calculateSellingPrice');
      return;
    }

    // Get the item ID from the select checkbox
    const selectCheckbox = row.querySelector('input[name^="select_"]');
    if (!selectCheckbox) {
      console.error('No select checkbox found in row');
      return;
    }

    const itemId = selectCheckbox.name.split('_')[1];
    console.log('Calculating price for item ID:', itemId);

    // Get the required elements
    const costInput = row.querySelector('input[name="cost_' + itemId + '"]');
    const markupSelect = row.querySelector('select[name="markup_' + itemId + '"]');
    const calculatedPriceSpan = row.querySelector('#calculated_price_' + itemId);
    const manualPriceInput = row.querySelector('input[name="manual_price_' + itemId + '"]');
    const unitConversionInput = row.querySelector('input[name="unit_conversion_' + itemId + '"]');
    const overrideCheckbox = row.querySelector('.price-override-checkbox');

    console.log('Cost input:', costInput);
    console.log('Markup select:', markupSelect);
    console.log('Calculated price span:', calculatedPriceSpan);

    if (costInput && markupSelect && calculatedPriceSpan) {
      console.log('Cost input value:', costInput.value);
      console.log('Markup select value:', markupSelect.value);

      // Parse the cost value
      let cost = 0;
      try {
        cost = parseFloat(costInput.value.replace(/,/g, '')) || 0;
      } catch (e) {
        console.error('Error parsing cost:', e);
        cost = 0;
      }

      // Parse the markup value
      const markup = parseFloat(markupSelect.value) || 0;

      // Parse the unit conversion value
      const unitConversion = parseFloat(unitConversionInput?.value || 1);

      console.log('Parsed cost:', cost);
      console.log('Parsed markup:', markup);
      console.log('Parsed unit conversion:', unitConversion);

      // Adjust cost based on unit conversion
      let adjustedCost = cost;
      if (unitConversion !== 1) {
        adjustedCost = cost / unitConversion;
      }

      console.log('Adjusted cost:', adjustedCost);

      // Calculate selling price
      const sellingPrice = adjustedCost + (adjustedCost * markup / 100);

      console.log('Calculated selling price:', sellingPrice);

      // Update the calculated price display
      calculatedPriceSpan.textContent = sellingPrice.toFixed(2);

      // Get the current manual price value
      const currentManualPrice = parseFloat(manualPriceInput.value) || 0;

      // If the manual price is 0 or matches the previous calculated price, update it
      // This ensures we don't overwrite a user's manual entry
      if (currentManualPrice === 0 || Math.abs(currentManualPrice - sellingPrice) < 0.01) {
        manualPriceInput.value = sellingPrice.toFixed(2);
      }

      // Always check the override checkbox to ensure the manual price is used
      overrideCheckbox.checked = true;
    } else {
      console.error('Missing required elements for calculation');
      if (!costInput) console.error('Cost input missing');
      if (!markupSelect) console.error('Markup select missing');
      if (!calculatedPriceSpan) console.error('Calculated price span missing');
    }
  };

  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');
    // Select All checkbox functionality
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const itemCheckboxes = document.querySelectorAll("input[type='checkbox'][name^='select_']");

    // Add event listener to the "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
      const isChecked = this.checked;

      // Update all item checkboxes
      itemCheckboxes.forEach(function(checkbox) {
        checkbox.checked = isChecked;
      });
    });

    // Add event listeners to individual checkboxes to update "Select All" state
    itemCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', updateSelectAllCheckbox);
    });

    // Function to update the "Select All" checkbox based on individual checkboxes
    function updateSelectAllCheckbox() {
      const allChecked = Array.from(itemCheckboxes).every(checkbox => checkbox.checked);
      const someChecked = Array.from(itemCheckboxes).some(checkbox => checkbox.checked);

      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }

    // Form submission handler
    document.getElementById("transfer-form").addEventListener("submit", function(e) {
      const checkboxes = document.querySelectorAll("input[type='checkbox'][name^='select_']");
      checkboxes.forEach(function(checkbox) {
        if (!checkbox.checked) {
          const row = checkbox.closest("tr");
          if (row) {
            row.querySelectorAll("input, select").forEach(function(el) {
              el.disabled = true;
            });
          }
        }
      });
    });

    // Handle unit selection change
    const unitSelects = document.querySelectorAll('.unit-select');
    unitSelects.forEach(function(select) {
      select.addEventListener('change', updateConversionLabel);
    });

    // Handle conversion value change
    const conversionInputs = document.querySelectorAll('.unit-conversion');
    conversionInputs.forEach(function(input) {
      input.addEventListener('input', function() {
        updateConversionLabel.call(this);
        // Also recalculate the price when conversion changes
        setTimeout(() => {
          const row = this.closest('tr');
          calculateSellingPrice(row);
        }, 100); // Small delay to allow conversion to update
      });
    });

    // Initial update of all conversion labels
    unitSelects.forEach(updateConversionLabel);

    // The calculateSellingPrice function is now defined globally

    // Calculate initial selling prices
    setTimeout(() => {
      console.log('Calculating initial selling prices');
      document.querySelectorAll('tr').forEach(function(row) {
        if (row.querySelector('input[name^="select_"]')) {
          // Set a default markup value if none is selected
          const itemId = row.querySelector('input[name^="select_"]').name.split('_')[1];
          const markupSelect = row.querySelector('select[name="markup_' + itemId + '"]');

          // Log the current state of the markup select
          console.log('Initial markup select value for item', itemId, ':', markupSelect ? markupSelect.value : 'not found');

          // Add a manual trigger for the markup select
          if (markupSelect) {
            // Add click handlers to each option in the markup select
            Array.from(markupSelect.options).forEach(option => {
              option.addEventListener('click', function() {
                console.log('Markup option clicked:', this.value);
                setTimeout(() => calculateSellingPrice(row), 10);
              });
            });
          }

          // Calculate the selling price
          calculateSellingPrice(row);
        }
      });
    }, 500); // Delay to ensure all elements are loaded

    // Recalculate selling price when markup changes - using direct approach
    function setupMarkupChangeListeners() {
      console.log('Setting up markup change listeners');
      const markupSelects = document.querySelectorAll('select[name^="markup_"]');
      console.log('Found', markupSelects.length, 'markup select elements');

      markupSelects.forEach(function(select) {
        // Remove any existing listeners to avoid duplicates
        select.removeEventListener('change', handleMarkupChange);
        select.removeEventListener('input', handleMarkupChange);
        select.removeEventListener('click', handleMarkupChange);

        // Add multiple event listeners to catch all possible events
        select.addEventListener('change', handleMarkupChange);
        select.addEventListener('input', handleMarkupChange);
        select.addEventListener('click', handleMarkupChange);

        // Also add event listeners to each option
        Array.from(select.options).forEach(option => {
          option.addEventListener('click', function() {
            console.log('Option clicked:', this.value);
            select.value = this.value;
            handleMarkupChange.call(select);
          });
        });

        console.log('Added event listeners to markup select:', select.name);

        // Manually trigger calculation once to ensure initial values are set
        setTimeout(() => {
          const row = select.closest('tr');
          if (row) calculateSellingPrice(row);
        }, 100);
      });
    }

    function handleMarkupChange(event) {
      console.log('Markup changed event triggered!');
      console.log('New markup value:', this.value);
      console.log('Select element:', this.name);
      const row = this.closest('tr');
      calculateSellingPrice(row);
    }

    // Set up the markup change listeners
    setupMarkupChangeListeners();

    // Recalculate selling price when unit changes
    document.querySelectorAll('select[name^="transfer_unit_"]').forEach(function(select) {
      select.addEventListener('change', function() {
        setTimeout(() => {
          const row = this.closest('tr');
          calculateSellingPrice(row);
        }, 100); // Small delay to allow unit conversion to update
      });
    });

    // Add event listeners to manual price inputs
    document.querySelectorAll('input[name^="manual_price_"]').forEach(function(input) {
      // Add input event listener to validate and format the manual price
      input.addEventListener('input', function() {
        const value = this.value;

        // Get the row and item ID
        const row = this.closest('tr');
        const itemId = row.id.replace('wholesale-item-', '');

        // Always ensure the override checkbox is checked
        const overrideCheckbox = row.querySelector('.price-override-checkbox');
        overrideCheckbox.checked = true;

        // Ensure the value is a valid number
        if (value && !isNaN(parseFloat(value))) {
          // Format to 2 decimal places only when the user has finished typing
          // This prevents the cursor from jumping to the end while typing
          if (value.indexOf('.') !== -1 && value.split('.')[1].length > 2) {
            const formattedValue = parseFloat(value).toFixed(2);
            this.value = formattedValue;
          }
        }

        console.log('Manual price updated for item', itemId, 'to', this.value);
      });

      // Add focus event listener to select all text for easy editing
      input.addEventListener('focus', function() {
        // Select all text for easy replacement
        this.select();
      });
    });

    function updateConversionLabel() {
      const itemId = this.getAttribute('data-item-id');
      const row = this.closest('tr');

      // If called directly on page load, we need to get the itemId differently
      const actualItemId = itemId || this.querySelector('.unit-select')?.getAttribute('data-item-id');

      const sourceUnit = row.querySelector('td:nth-child(5)').textContent.trim();
      const targetUnit = row.querySelector('.unit-select').value;
      const conversionValue = row.querySelector('.unit-conversion').value;

      const conversionLabel = row.querySelector('.conversion-label');
      const conversionValueSpan = row.querySelector('.conversion-value');
      const targetUnitSpan = row.querySelector('.target-unit');

      conversionValueSpan.textContent = conversionValue;
      targetUnitSpan.textContent = targetUnit;
      conversionLabel.innerHTML = `1 ${sourceUnit} = <span class="conversion-value">${conversionValue}</span> <span class="target-unit">${targetUnit}</span>`;
    }

    // Final calculation of all prices to ensure they're displayed correctly
    setTimeout(() => {
      console.log('Final calculation of all prices');
      document.querySelectorAll('tr').forEach(function(row) {
        if (row.querySelector('input[name^="select_"]')) {
          calculateSellingPrice(row);
        }
      });
    }, 1000);
  });

  // Trigger calculations when the page is fully loaded
  window.onload = function() {
    console.log('Window fully loaded');
    // Calculate all prices again after window load
    document.querySelectorAll('tr').forEach(function(row) {
      if (row.querySelector('input[name^="select_"]')) {
        calculateSellingPrice(row);
      }
    });
  };

  // ==================================================
  // Feature 3: Procurement Values Display & Calculation
  // ==================================================
  (function() {
    'use strict';

    console.log('[Procurement Values] Initializing...');

    /**
     * Calculate and display all procurement values
     */
    function calculateProcurementValues() {
      let grandTotal = 0;
      let itemCount = 0;
      const cells = document.querySelectorAll('.procurement-value');

      cells.forEach(function(cell) {
        const cost = parseFloat(cell.getAttribute('data-cost')) || 0;
        const stock = parseFloat(cell.getAttribute('data-stock')) || 0;
        const value = cost * stock;

        // Update individual cell display
        const valueSpan = cell.querySelector('.item-proc-value');
        if (valueSpan) {
          valueSpan.textContent = value.toFixed(2);
        }

        // Add to running totals
        grandTotal += value;
        itemCount++;
      });

      // Calculate average
      const average = itemCount > 0 ? grandTotal / itemCount : 0;

      // Update summary displays
      const grandTotalEl = document.getElementById('grand-procurement-total');
      const averageEl = document.getElementById('average-item-value');
      const itemCountEl = document.getElementById('total-items-count');

      if (grandTotalEl) {
        grandTotalEl.textContent = grandTotal.toLocaleString('en-NG', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      if (averageEl) {
        averageEl.textContent = average.toLocaleString('en-NG', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      if (itemCountEl) {
        itemCountEl.textContent = itemCount;
      }

      console.log('[Procurement Values] Calculated:', {
        itemCount,
        grandTotal: grandTotal.toFixed(2),
        average: average.toFixed(2)
      });
    }

    // Make function globally available for other features
    window.calculateProcurementValues = calculateProcurementValues;

    // Calculate on initial page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Procurement Values] DOM ready, calculating...');
      calculateProcurementValues();
    });

    // Recalculate after HTMX updates the table
    document.body.addEventListener('htmx:afterSwap', function(event) {
      if (event.detail.target.id === 'wholesale-items') {
        console.log('[Procurement Values] HTMX swap detected, recalculating...');
        // Wait for DOM update to complete
        setTimeout(calculateProcurementValues, 100);
      }
    });

    console.log('[Procurement Values] Ready');
  })();

  // ==================================================
  // Feature 2: Edit Stock Quantity
  // ==================================================
  {% if user|can_edit_transfer_item_quantity %}
  // Wrap in DOMContentLoaded or execute immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEditStockFeature);
  } else {
    initEditStockFeature();
  }

  function initEditStockFeature() {
    console.log('[Edit Stock] Feature enabled');

    // Cache modal references
    const $editStockModal = $('#editStockModal');
    const editNewStockInput = document.getElementById('edit-new-stock');

    if (!$editStockModal || !editNewStockInput) {
      console.warn('[Edit Stock] Modal elements not found, retrying...');
      setTimeout(initEditStockFeature, 100);
      return;
    }

    // Set up modal focus handler ONCE (outside click handler)
    $editStockModal.on('shown.bs.modal', function() {
      if (editNewStockInput) {
        editNewStockInput.focus();
        editNewStockInput.select();
      }
    });

    // Edit button click handler
    document.addEventListener('click', function(e) {
      if (e.target.closest('.edit-stock-btn')) {
        e.preventDefault();
        e.stopPropagation();

        const btn = e.target.closest('.edit-stock-btn');
        const itemId = btn.getAttribute('data-item-id');
        const currentStock = btn.getAttribute('data-current-stock');
        const itemName = btn.getAttribute('data-item-name');
        const itemBrand = btn.getAttribute('data-item-brand');
        const itemUnit = btn.getAttribute('data-item-unit');

        // Populate modal
        document.getElementById('edit-item-id').value = itemId;
        document.getElementById('edit-item-info').textContent =
          `${itemName.toUpperCase()} (${itemBrand || 'None'})`;
        document.getElementById('edit-current-stock').value =
          `${currentStock} ${itemUnit}`;
        document.getElementById('edit-new-stock').value = currentStock;
        document.getElementById('edit-stock-error').style.display = 'none';

        // Show modal
        $editStockModal.modal('show');
      }
    });

    // Save button click handler
    const saveBtn = document.getElementById('saveStockBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async function() {
        const itemId = document.getElementById('edit-item-id').value;
        const newStock = document.getElementById('edit-new-stock').value;
        const errorDiv = document.getElementById('edit-stock-error');
        const errorText = errorDiv.querySelector('.error-text');

        // Client-side validation
        if (!newStock || newStock.trim() === '') {
          errorText.textContent = 'Please enter a quantity';
          errorDiv.style.display = 'block';
          return;
        }

        const numStock = parseFloat(newStock);
        if (isNaN(numStock) || numStock < 0) {
          errorText.textContent = 'Please enter a valid quantity (0 or greater)';
          errorDiv.style.display = 'block';
          return;
        }

        // Disable button during save
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          const response = await fetch('/wholesale/update-wholesale-item-quantity/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
              item_id: itemId,
              quantity: numStock
            })
          });

          const data = await response.json();

          if (data.success) {
            // Update stock display
            const stockDisplay = document.getElementById('stock-display-' + itemId);
            if (stockDisplay) {
              stockDisplay.textContent = data.new_quantity;
            }

            // Update button data attribute
            const btn = document.querySelector(`.edit-stock-btn[data-item-id="${itemId}"]`);
            if (btn) {
              btn.setAttribute('data-current-stock', data.new_quantity);
            }

            // Update procurement value data attribute
            const procCell = document.querySelector(`tr#wholesale-item-${itemId} .procurement-value`);
            if (procCell) {
              procCell.setAttribute('data-stock', data.new_quantity);
            }

            // Show success notification
            const message = `Stock updated successfully!\n\n` +
                          `${data.item_name} (${data.item_brand})\n` +
                          `${data.old_quantity} → ${data.new_quantity} ${data.item_unit}`;

            alert(message);

            // Close modal
            $editStockModal.modal('hide');

            // Recalculate procurement values
            if (typeof calculateProcurementValues === 'function') {
              setTimeout(calculateProcurementValues, 100);
            }

            // Trigger price recalculation for the updated row
            const row = document.getElementById('wholesale-item-' + itemId);
            if (row && typeof window.calculateSellingPrice === 'function') {
              setTimeout(() => window.calculateSellingPrice(row), 150);
            }

          } else {
            errorText.textContent = data.error || 'Failed to update stock';
            errorDiv.style.display = 'block';
          }

        } catch (error) {
          console.error('[Edit Stock] Error:', error);
          errorText.textContent = 'Network error: ' + error.message;
          errorDiv.style.display = 'block';
        } finally {
          // Re-enable button
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
      });
    }

    // Clear error on input change
    const newStockInput = document.getElementById('edit-new-stock');
    if (newStockInput) {
      newStockInput.addEventListener('input', function() {
        const errorDiv = document.getElementById('edit-stock-error');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
      });
    }

    console.log('[Edit Stock] Initialization complete');
  }
  {% endif %}
</script>
{% include "partials/_transfer_price_calc.js.html" %}
{% endblock %}









{% load permission_tags %}
{% load store_filters %}
    {% for item in wholesale_items %}
    <tr id="wholesale-item-{{ item.id }}">
      <td>
        <input type="checkbox" name="select_{{ item.id }}" class="item-checkbox">
        <input type="hidden" name="cost_{{ item.id }}" value="{{ item.cost }}">
      </td>
      <td>{{ item.name|upper }}<br><small class="text-muted">Cost: ₦{{ item.cost }}</small></td>
      <td>{{ item.dosage_form }}</td>
      <td>{{ item.brand }}</td>
      <td>{{ item.unit }}</td>
      <td>
        {% if user|can_edit_transfer_item_quantity %}
        <div class="d-flex align-items-center">
          <span class="stock-display font-weight-bold" id="stock-display-{{ item.id }}">
            {{ item.stock }}
          </span>
          <button type="button"
                  class="btn btn-sm btn-link text-primary edit-stock-btn ml-2"
                  data-item-id="{{ item.id }}"
                  data-current-stock="{{ item.stock }}"
                  data-item-name="{{ item.name }}"
                  data-item-brand="{{ item.brand }}"
                  data-item-unit="{{ item.unit }}"
                  data-toggle="tooltip"
                  title="Edit stock quantity">
            <i class="fas fa-edit"></i>
          </button>
        </div>
        {% else %}
        <span class="font-weight-bold">{{ item.stock }}</span>
        {% endif %}
      </td>
      <td class="procurement-value text-center"
          data-cost="{{ item.cost }}"
          data-stock="{{ item.stock }}">
        <span class="badge badge-info badge-lg" style="font-size: 0.95rem;">
          ₦<span class="item-proc-value">{{ item.cost|multiply:item.stock|floatformat:2 }}</span>
        </span>
        <br>
        <small class="text-muted">
          ₦{{ item.cost|floatformat:2 }} × {{ item.stock }}
        </small>
      </td>
      <td>
        <input type="number" name="quantity_{{ item.id }}" style="width:100px;" class="form-control" min="0" value="0" step="0.5">
      </td>
      <td>
        <select name="transfer_unit_{{ item.id }}" style="width:130px;" class="form-control unit-select" data-item-id="{{ item.id }}">
          <option value="{{ item.unit }}" selected>{{ item.unit }}</option>
          {% for unit_value, unit_display in unit_choices %}
            {% if unit_value != item.unit %}
              <option value="{{ unit_value }}">{{ unit_display }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </td>
      <td>
        <input type="number" name="unit_conversion_{{ item.id }}" style="width:100px;" class="form-control unit-conversion" min="0.1" value="1" step="0.1">
        <small class="text-muted conversion-label">1 {{ item.unit }} = <span class="conversion-value">1</span> <span class="target-unit">{{ item.unit }}</span></small>
      </td>
      <td>
        <select name="markup_{{ item.id }}" style="width:150px;" class="form-control markup-select" data-item-id="{{ item.id }}">
          <option value="0">Select Markup</option>
          <option value="2.5">2.5% markup</option>
          <option value="5">5% markup</option>
          <option value="7.5">7.5% markup</option>
          <option value="10">10% markup</option>
          <option value="12.5">12.5% markup</option>
          <option value="15">15% markup</option>
          <option value="17.5">17.5% markup</option>
          <option value="20">20% markup</option>
          <option value="22.5">22.5% markup</option>
          <option value="25">25% markup</option>
          <option value="27.5">27.5% markup</option>
          <option value="30">30% markup</option>
          <option value="32.5">32.5% markup</option>
          <option value="35">35% markup</option>
          <option value="37.5">37.5% markup</option>
          <option value="40">40% markup</option>
          <option value="42.5">42.5% markup</option>
          <option value="45">45% markup</option>
          <option value="47.5">47.5% markup</option>
          <option value="50">50% markup</option>
          <option value="52.5">52.5% markup</option>
          <option value="55">55% markup</option>
          <option value="57.5">57.5% markup</option>
          <option value="60">60% markup</option>
          <option value="62.5">62.5% markup</option>
          <option value="65">65% markup</option>
          <option value="67.5">67.5% markup</option>
          <option value="70">70% markup</option>
          <option value="72.5">72.5% markup</option>
          <option value="75">75% markup</option>
          <option value="77.5">77.5% markup</option>
          <option value="80">80% markup</option>
          <option value="82.5">82.5% markup</option>
          <option value="85">85% markup</option>
          <option value="87.5">87.5% markup</option>
          <option value="90">90% markup</option>
          <option value="92.5">92.5% markup</option>
          <option value="95">95% markup</option>
          <option value="97.5">97.5% markup</option>
          <option value="100">100% markup</option>
        </select>
      </td>
      <td>
        <div class="form-check mb-1">
          <input type="checkbox" class="form-check-input price-override-checkbox" id="price_override_{{ item.id }}" name="price_override_{{ item.id }}">
          <label class="form-check-label" for="price_override_{{ item.id }}">Override</label>
        </div>
        <div class="mb-1">
          <small class="text-muted">Calculated: <span class="calculated-price" id="calculated_price_{{ item.id }}">0.00</span></small>
        </div>
        <div class="input-group" style="width:150px;">
          <input type="number" name="manual_price_{{ item.id }}" class="form-control manual-price" min="0" value="0" step="0.01" placeholder="Enter selling price">
          <div class="input-group-append">
            <span class="input-group-text">₦</span>
          </div>
        </div>
        <small class="text-muted d-block mt-1">Enter price to override calculated value</small>
      </td>
      <td>
        <select name="destination_{{ item.id }}" class="form-control" style="width:130px;">
          <option value="">Select</option>
          <option value="retail">Retail</option>
          <option value="wholesale">Wholesale</option>
        </select>
      </td>
    </tr>
    {% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Update the select-all checkbox state based on the loaded items
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');

    if (selectAllCheckbox) {
      // Add event listener to the "Select All" checkbox
      selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;

        // Update all item checkboxes
        itemCheckboxes.forEach(function(checkbox) {
          checkbox.checked = isChecked;
        });
      });

      // Add event listeners to individual checkboxes to update "Select All" state
      itemCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
      });

      // Initial update of the select-all checkbox state
      updateSelectAllCheckbox();
    }

    // Function to update the "Select All" checkbox based on individual checkboxes
    function updateSelectAllCheckbox() {
      const allChecked = Array.from(itemCheckboxes).every(checkbox => checkbox.checked);
      const someChecked = Array.from(itemCheckboxes).some(checkbox => checkbox.checked);

      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }

    // Recalculate procurement values after the partial content loads
    if (typeof window.calculateProcurementValues === 'function') {
      setTimeout(function() {
        window.calculateProcurementValues();
      }, 100);
    }

    // Recalculate selling prices for all rows after partial loads
    if (typeof window.calculateSellingPrice === 'function') {
      setTimeout(function() {
        document.querySelectorAll('tr[id^="wholesale-item-"]').forEach(function(row) {
          window.calculateSellingPrice(row);
        });
      }, 150);
    }
  });
</script>



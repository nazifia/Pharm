{% load static %}
{% block content %}

<!-- Required CSS Framework Dependencies -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<!-- Enhanced CSS and JavaScript for Wholesale Customer History -->
<style>
    /* Custom styles for customer history */
    .wholesale-history-container {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
    }

    .page-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(255, 255, 255, 0.05) 10px,
            rgba(255, 255, 255, 0.05) 20px
        );
        animation: slide 20s linear infinite;
    }

    @keyframes slide {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }

    .page-header h2 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        position: relative;
        z-index: 1;
    }

    .customer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        position: relative;
        z-index: 1;
    }

    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #28a745;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .year-section {
        background: white;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .year-section:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.12);
    }

    .year-header {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        color: white;
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        position: relative;
    }

    .year-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .year-total {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .collapse-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .year-header.collapsed .collapse-icon {
        transform: translateY(-50%) rotate(-90deg);
    }

    .month-section {
        border-bottom: 1px solid #e9ecef;
        padding: 20px 25px;
    }

    .month-section:last-child {
        border-bottom: none;
    }

    .period-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        cursor: pointer;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }

    .period-header:hover {
        background: #e9ecef;
    }

    .period-header h4 {
        margin: 0;
        color: #495057;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .monthly-total {
        background: #28a745;
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .custom-table thead {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }

    .custom-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .custom-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s ease;
    }

    .custom-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .custom-table td {
        padding: 12px 12px;
        vertical-align: middle;
    }

    .item-name {
        font-weight: 500;
        color: #495057;
    }

    .quantity-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .price-cell {
        font-weight: 600;
        color: #28a745;
        font-size: 1rem;
    }

    .no-history-alert {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }

    .no-history-alert i {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .wholesale-history-container {
            padding: 15px;
        }

        .page-header {
            padding: 20px;
        }

        .page-header h2 {
            font-size: 1.5rem;
        }

        .customer-info {
            flex-direction: column;
            gap: 15px;
        }

        .year-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .period-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .table-container {
            margin: 0 -15px;
        }
    }

    /* Loading animation */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .loading-spinner.active {
        display: block;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Fade in animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="wholesale-history-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2>Purchase History for {{ wholesale_customer.name }}</h2>
        <div class="customer-info">
            <div class="stats-card">
                <strong>Total Orders:</strong> {{ total_orders|default:0 }}
            </div>
            <div class="stats-card">
                <strong>Total Spent:</strong> ₦{{ grand_total|floatformat:2|default:"0.00" }}
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p class="mt-3">Loading history...</p>
    </div>

    {% for year, year_data in history_data.items %}
    <div class="year-section" data-year="{{ year }}">
        <div class="year-header" onclick="toggleYear('{{ year }}')">
            <h3><i class="fas fa-calendar-alt mr-2"></i>{{ year }}</h3>
            <div class="year-total">Annual Total: ₦{{ year_data.total|floatformat:2 }}</div>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>

        <div class="year-content" id="year-content-{{ year }}">
            {% for month, month_data in year_data.months.items %}
            <div class="month-section">
                <div class="period-header" onclick="toggleMonth('{{ year }}-{{ month }}')">
                    <h4><i class="fas fa-calendar mr-2"></i>{{ month }}</h4>
                    <div>
                        <span class="monthly-total">Monthly Total: ₦{{ month_data.total|floatformat:2 }}</span>
                        <i class="fas fa-chevron-down collapse-chevron ml-2"></i>
                    </div>
                </div>

                <div class="month-content" id="month-content-{{ year }}-{{ month }}">
                    <div class="table-container">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-clock mr-1"></i>Date</th>
                                    <th><i class="fas fa-box mr-1"></i>Item</th>
                                    <th><i class="fas fa-cubes mr-1"></i>Quantity</th>
                                    <th><i class="fas fa-money-bill-wave mr-1"></i>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for history in month_data.items %}
                                <tr class="history-row" data-date="{{ history.date|date:'Y-m-d' }}">
                                    <td>{{ history.date|date:"M d, Y" }}</td>
                                    <td class="item-name">{{ history.item.name }}</td>
                                    <td><span class="quantity-badge">{{ history.quantity }}</span></td>
                                    <td class="price-cell">₦{{ history.subtotal|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% empty %}
    <div class="no-history-alert">
        <i class="fas fa-history"></i>
        <h4>No Purchase History Found</h4>
        <p>{{ wholesale_customer.name }} hasn't made any wholesale purchases yet.</p>
    </div>
    {% endfor %}
</div>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize page with animations
    initializePage();
    
    // Add search functionality
    addSearchFeature();
    
    // Add sorting functionality
    addSortingFeature();
    
    // Add export functionality
    addExportFeature();
});

function initializePage() {
    // Animate page load
    const container = document.querySelector('.wholesale-history-container');
    const yearSections = document.querySelectorAll('.year-section');
    
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        container.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
    }, 100);
    
    // Animate year sections
    yearSections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            section.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            section.style.opacity = '1';
            section.style.transform = 'translateY(0)';
        }, 100 + (index * 100));
    });
}

function toggleYear(year) {
    const content = document.getElementById(`year-content-${year}`);
    const header = document.querySelector(`[data-year="${year}"] .year-header`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        header.classList.remove('collapsed');
    } else {
        content.style.display = 'none';
        header.classList.add('collapsed');
    }
}

function toggleMonth(yearMonth) {
    const content = document.getElementById(`month-content-${yearMonth}`);
    const header = content.previousElementSibling;
    const chevron = header.querySelector('.collapse-chevron');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
    }
}

function addSearchFeature() {
    // Create search bar
    const searchHtml = `
        <div class="search-container" style="margin-bottom: 20px;">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search by item name...">
                <div class="input-group-append">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
            </div>
        </div>
    `;
    
    const container = document.querySelector('.wholesale-history-container');
    const header = container.querySelector('.page-header');
    header.insertAdjacentHTML('afterend', searchHtml);
    
    // Add search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.history-row');
        
        rows.forEach(row => {
            const itemName = row.querySelector('.item-name').textContent.toLowerCase();
            if (itemName.includes(searchTerm)) {
                row.style.display = '';
                row.style.animation = 'fadeIn 0.3s ease';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

function addSortingFeature() {
    // Add sorting controls to table headers
    const tableHeaders = document.querySelectorAll('th');
    
    tableHeaders.forEach((header, index) => {
        if (index > 0) { // Skip the date column for this example
            header.style.cursor = 'pointer';
            header.title = 'Click to sort';
            
            header.addEventListener('click', function() {
                const table = header.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    const aValue = a.children[index].textContent.trim();
                    const bValue = b.children[index].textContent.trim();
                    
                    // Handle numeric sorting for price column
                    if (index === 3) { // Price column
                        return parseFloat(aValue.replace('₦', '').replace(',', '')) - 
                               parseFloat(bValue.replace('₦', '').replace(',', ''));
                    }
                    
                    return aValue.localeCompare(bValue);
                });
                
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        }
    });
}

function addExportFeature() {
    // Create export button
    const exportHtml = `
        <div class="export-container" style="text-align: right; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="exportToExcel()">
                <i class="fas fa-file-export mr-2"></i>Export to CSV
            </button>
        </div>
    `;
    
    const container = document.querySelector('.wholesale-history-container');
    const searchContainer = container.querySelector('.search-container');
    searchContainer.insertAdjacentHTML('afterend', exportHtml);
}

function exportToExcel() {
    // Show loading spinner
    document.getElementById('loadingSpinner').classList.add('active');
    
    // Create CSV content
    let csvContent = 'Date,Item,Quantity,Subtotal\n';
    
    document.querySelectorAll('.history-row').forEach(row => {
        const date = row.children[0].textContent;
        const item = row.children[1].textContent;
        const quantity = row.children[2].textContent;
        const subtotal = row.children[3].textContent;
        
        csvContent += `"${date}","${item}","${quantity}","${subtotal}"\n`;
    });
    
    // Create and download CSV file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `wholesale_history_${document.querySelector('.page-header h2').textContent.replace(/[^a-zA-Z0-9]/g, '_')}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Hide loading spinner
    setTimeout(() => {
        document.getElementById('loadingSpinner').classList.remove('active');
    }, 500);
    
    // Show success message
    showNotification('Export completed successfully!', 'success');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

{% endblock %}


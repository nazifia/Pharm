<!-- Custom Barcodes Management Modal -->
<div class="modal fade" id="customBarcodesModal" tabindex="-1" aria-labelledby="customBarcodesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="customBarcodesModalLabel">
                    <i class="fas fa-barcode me-2"></i>
                    Manage Custom Barcodes
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="customBarcodeSearch" class="form-control" 
                                   placeholder="Search barcodes or names...">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-outline-success" type="button" id="searchBtn">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="modeFilter" class="form-select">
                            <option value="">All Modes</option>
                            <option value="retail">Retail</option>
                            <option value="wholesale">Wholesale</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" id="addNewBtn" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Add New
                        </button>
                    </div>
                </div>

                <!-- Barcodes Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="customBarcodesTable">
                        <thead class="thead-light">
                            <tr>
                                <th>Barcode</th>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Notes</th>
                                <th>Mode</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customBarcodesTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination (if needed) -->
                <nav id="paginationNav" class="mt-3" style="display: none;">
                    <ul class="pagination justify-content-center">
                        <!-- Pagination buttons will be added dynamically -->
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" id="exportBtn" class="btn btn-outline-primary">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    #customBarcodesTable {
        font-size: 0.9em;
    }
    
    #customBarcodesTable th {
        font-size: 0.85em;
        white-space: nowrap;
    }
    
    #customBarcodesTable td {
        vertical-align: middle;
    }
    
    .barcode-cell {
        font-family: monospace;
        font-weight: bold;
        max-width: 150px;
    }
    
    .status-badge {
        font-size: 0.8em;
        padding: 2px 6px;
        border-radius: 10px;
    }
    
    .status-active {
        background-color: #28a745;
        color: white;
    }
    
    .status-inactive {
        background-color: #6c757d;
        color: white;
    }
    
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        margin: 0 2px;
    }
</style>

<script>
// Custom Barcodes Management Script
(function initCustomBarcodesManagement() {
    let currentPage = 1;
    let itemsPerPage = 10;
    let allBarcodes = [];
    let filteredBarcodes = [];

    // Initialize modal
    const modal = document.getElementById('customBarcodesModal');
    const searchInput = document.getElementById('customBarcodeSearch');
    const modeFilter = document.getElementById('modeFilter');
    const addNewBtn = document.getElementById('addNewBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchBtn = document.getElementById('searchBtn');

    if (!modal) {
        console.error('[Custom Barcodes] Modal not found');
        return;
    }

    // Load barcodes when modal opens
    modal.addEventListener('show.bs.modal', async function() {
        await loadCustomBarcodes();
        renderBarcodesTable();
    });

    // Search functionality
    async function performSearch() {
        const searchTerm = searchInput.value.trim();
        const mode = modeFilter.value;
        
        if (!searchTerm && !mode) {
            filteredBarcodes = [...allBarcodes];
        } else {
            filteredBarcodes = await window.dbManager.searchCustomBarcodes(searchTerm, mode);
        }
        
        currentPage = 1;
        renderBarcodesTable();
    }

    // Render barcodes table
    function renderBarcodesTable() {
        const tbody = document.getElementById('customBarcodesTableBody');
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageBarcodes = filteredBarcodes.slice(start, end);

        if (pageBarcodes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        <i class="fas fa-info-circle"></i>
                        No custom barcodes found
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = pageBarcodes.map(barcode => `
            <tr>
                <td class="barcode-cell">${barcode.barcode}</td>
                <td><span class="badge badge-info">${barcode.barcode_type || 'OTHER'}</span></td>
                <td>${barcode.name}</td>
                <td>${barcode.description || '-'}</td>
                <td>${barcode.notes || '-'}</td>
                <td><span class="badge ${barcode.mode === 'retail' ? 'badge-success' : 'badge-primary'}">${barcode.mode}</span></td>
                <td>${new Date(barcode.created_date).toLocaleDateString()}</td>
                <td>
                    <span class="status-badge ${barcode.status === 'active' ? 'status-active' : 'status-inactive'}">
                        ${barcode.status}
                    </span>
                </td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="editCustomBarcode(${barcode.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomBarcode(${barcode.id}, '${barcode.barcode}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        updatePagination();
    }

    // Update pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredBarcodes.length / itemsPerPage);
        const paginationNav = document.getElementById('paginationNav');
        
        if (totalPages <= 1) {
            paginationNav.style.display = 'none';
            return;
        }
        
        paginationNav.style.display = 'block';
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
        }
        
        // Next button
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
        
        paginationNav.querySelector('.pagination').innerHTML = paginationHTML;
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredBarcodes.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderBarcodesTable();
    }

    // Load all custom barcodes
    async function loadCustomBarcodes() {
        try {
            allBarcodes = await window.dbManager.getAllCustomBarcodes() || [];
            filteredBarcodes = [...allBarcodes];
        } catch (error) {
            console.error('[Custom Barcodes] Error loading barcodes:', error);
            allBarcodes = [];
            filteredBarcodes = [];
        }
    }

    // Edit custom barcode
    async function editCustomBarcode(id) {
        const barcode = allBarcodes.find(b => b.id === id);
        if (!barcode) return;
        
        const modal = createBarcodeFormModal('Edit Custom Barcode', barcode);
        document.body.appendChild(modal);
        
        // Handle form submission
        modal.querySelector('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                notes: formData.get('notes'),
                barcode_type: formData.get('barcode_type'),
                status: formData.get('status')
            };
            
            try {
                await window.dbManager.updateCustomBarcode(id, data);
                
                // Update local array
                const index = allBarcodes.findIndex(b => b.id === id);
                if (index !== -1) {
                    allBarcodes[index] = { ...allBarcodes[index], ...data };
                }
                
                await loadCustomBarcodes();
                renderBarcodesTable();
                modal.remove();
                
                window.offlineHandler?.showInAppNotification(
                    'Custom Barcode Updated',
                    'Barcode updated successfully',
                    'success'
                );
            } catch (error) {
                console.error('[Custom Barcodes] Error updating barcode:', error);
                window.offlineHandler?.showInAppNotification(
                    'Update Failed',
                    'Failed to update barcode: ' + error.message,
                    'error'
                );
            }
        });
    }

    // Delete custom barcode
    async function deleteCustomBarcode(id, barcode) {
        if (!confirm(`Are you sure you want to delete barcode "${barcode}"?`)) return;
        
        try {
            await window.dbManager.deleteCustomBarcode(id);
            
            // Update local array
            allBarcodes = allBarcodes.filter(b => b.id !== id);
            filteredBarcodes = filteredBarcodes.filter(b => b.id !== id);
            
            renderBarcodesTable();
            
            window.offlineHandler?.showInAppNotification(
                'Custom Barcode Deleted',
                `Barcode "${barcode}" deleted successfully`,
                'success'
            );
        } catch (error) {
            console.error('[Custom Barcodes] Error deleting barcode:', error);
            window.offlineHandler?.showInAppNotification(
                'Delete Failed',
                'Failed to delete barcode: ' + error.message,
                'error'
            );
        }
    }

    // Create barcode form modal
    function createBarcodeFormModal(title, barcode = null) {
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-barcode"></i>
                            ${title}
                        </h5>
                        <button type="button" class="close text-white" onclick="this.closest('.modal').remove()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form class="modal-body">
                        <input type="hidden" id="editBarcodeId" value="${barcode ? barcode.id : ''}">
                        
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" name="name" class="form-control" 
                                   value="${barcode ? barcode.name : ''}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2">${barcode ? barcode.description || '' : ''}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="2">${barcode ? barcode.notes || '' : ''}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Barcode Type</label>
                            <select name="barcode_type" class="form-select">
                                <option value="OTHER" ${barcode?.barcode_type === 'OTHER' ? 'selected' : ''}>Other/Unknown</option>
                                <option value="UPC" ${barcode?.barcode_type === 'UPC' ? 'selected' : ''}>UPC</option>
                                <option value="EAN13" ${barcode?.barcode_type === 'EAN13' ? 'selected' : ''}>EAN-13</option>
                                <option value="CODE128" ${barcode?.barcode_type === 'CODE128' ? 'selected' : ''}>Code-128</option>
                                <option value="QR" ${barcode?.barcode_type === 'QR' ? 'selected' : ''}>QR Code</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="active" ${barcode?.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${barcode?.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </form>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveBarcodeForm()">
                            ${barcode ? 'Update' : 'Save'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Auto-focus name field
        if (!barcode) {
            setTimeout(() => {
                modal.querySelector('input[name="name"]')?.focus();
            }, 100);
        }
        
        // Handle close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        return modal;
    }

    // Save barcode form
    async function saveBarcodeForm() {
        const modal = document.querySelector('.modal.show');
        const form = modal.querySelector('form');
        const formData = new FormData(form);
        
        const barcodeData = {
            name: formData.get('name'),
            description: formData.get('description'),
            notes: formData.get('notes'),
            barcode_type: formData.get('barcode_type'),
            status: formData.get('status')
        };
        
        const editId = document.getElementById('editBarcodeId').value;
        
        try {
            if (editId) {
                await window.dbManager.updateCustomBarcode(parseInt(editId), barcodeData);
            } else {
                await window.dbManager.saveCustomBarcode(barcodeData);
            }
            
            await loadCustomBarcodes();
            renderBarcodesTable();
            modal.remove();
            
            window.offlineHandler?.showInAppNotification(
                'Custom Barcode Saved',
                editId ? 'Barcode updated successfully' : 'Barcode saved successfully',
                'success'
            );
        } catch (error) {
            console.error('[Custom Barcodes] Error saving barcode:', error);
            window.offlineHandler?.showInAppNotification(
                'Save Failed',
                'Failed to save barcode: ' + error.message,
                'error'
            );
        }
    }

    // Export barcodes
    function exportBarcodes() {
        if (filteredBarcodes.length === 0) {
            window.offlineHandler?.showInAppNotification(
                'Export Failed',
                'No barcodes to export',
                'warning'
            );
            return;
        }
        
        const exportData = filteredBarcodes.map(b => ({
            barcode: b.barcode,
            barcode_type: b.barcode_type,
            name: b.name,
            description: b.description || '',
            notes: b.notes || '',
            mode: b.mode,
            status: b.status,
            created_date: b.created_date
        }));
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `custom-barcodes-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Event listeners
    searchBtn.addEventListener('click', performSearch);
    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
    });
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    modeFilter.addEventListener('change', performSearch);
    addNewBtn.addEventListener('click', () => {
        const modal = createBarcodeFormModal('Add New Custom Barcode');
        document.body.appendChild(modal);
    });
    
    exportBtn.addEventListener('click', exportBarcodes);

    console.log('[Custom Barcodes] Management script loaded');
})();

// Initialize when document is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCustomBarcodesManagement);
} else {
    initCustomBarcodesManagement();
}
</script>


{% load static %}

{% block content %}

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome 5 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* General Form Styling */
    body {
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        color: #333;
    }

    form {
        margin-left: 2em;
        margin-top: 1em;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
        width: 90%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Input Fields */
    form input,
    form select,
    form button,
    form textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    /* Labels */
    form label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
        color: #333;
    }

    /* Error Messages */
    form .text-danger {
        color: #ff0000;
        font-size: 12px;
        margin-top: -5px;
    }

    /* Buttons */
    form button {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 15px;
    }
    

    form button:hover {
        background-color: #0056b3;
    }

    #remove {
        background-color: red;
        padding: 6px;
        cursor: pointer;
    }

    #remove:hover {
        background-color: rgb(203, 2, 2);
    }

    #add-item {
        padding: 6px;
    }

    #save {
        padding: 6px;
        background-color: rgb(2, 179, 2);
    }

    #save:hover {
        background-color: green;
    }

    /* Dashboard Button Styling */
    .dashboard-btn {
        background-color: #4e73df;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
    }

    .dashboard-btn i {
        margin-right: 5px;
    }

    .dashboard-btn:hover {
        background-color: #2e59d9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: white;
    }

    .dashboard-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Table Styling */
    #item-formset {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    #item-formset th,
    #item-formset td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    #item-formset th {
        background-color: #f2f2f2;
        color: #333;
    }

    #item-formset .form-row td {
        vertical-align: middle;
    }

    /* Highlight New Rows */
    #item-formset .form-row.new-row {
        background-color: #e7f3ff;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        form {
            padding: 10px;
        }

        form input,
        form select,
        form button,
        form textarea {
            font-size: 12px;
        }
    }

    /* Search Results Dropdown Styling */
    .search-results {
        position: absolute;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 250px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        margin-top: 2px;
    }

    .search-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }

    .search-result-item:hover,
    .search-result-item.active {
        background-color: #007bff;
        color: white;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item strong {
        display: block;
        font-size: 14px;
    }

    .search-result-item small {
        font-size: 12px;
        opacity: 0.8;
    }

    .add-new-item {
        padding: 10px 12px;
        cursor: pointer;
        background-color: #e7f3ff;
        text-align: center;
        font-weight: bold;
        color: #007bff;
        border-top: 1px solid #ddd;
        transition: background-color 0.2s ease;
    }

    .add-new-item:hover {
        background-color: #cfe2ff;
    }

    .search-loading {
        padding: 10px 12px;
        text-align: center;
        color: #666;
        font-style: italic;
    }

    .search-no-results {
        padding: 10px 12px;
        text-align: center;
        color: #999;
        font-style: italic;
    }

    /* Input focus styling for autocomplete */
    input[name$="-item_name"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 style="text-align: center;"><strong> Procurement Form</strong></h3>
    <a href="{% url 'store:dashboard' %}" class="dashboard-btn"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a>
</div>

<!-- Scanner Control Section -->
<div class="mb-3 d-flex justify-content-between align-items-center">
    <button type="button" id="global-scan-btn" class="btn btn-primary btn-sm">
        <i class="fas fa-barcode"></i> Scan & Add New Item
    </button>
    <small class="text-muted">
        <i class="fas fa-info-circle"></i>
        Scan barcode to automatically add a new row with pre-filled data
    </small>
</div>

{% if request.GET.draft_id %}
<form method="post" action="{% url 'store:add_procurement' %}?draft_id={{ request.GET.draft_id }}">  <!-- Include draft_id in form action -->
{% else %}
<form method="post" action="{% url 'store:add_procurement' %}">
{% endif %}
    {% csrf_token %}
    {% if request.GET.draft_id %}
    <input type="hidden" name="draft_id" value="{{ request.GET.draft_id }}">  <!-- Preserve draft_id in form -->
    {% endif %}

    <!-- Procurement Form -->
    <div>
        {% for field in procurement_form %}
        <div>
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.help_text %}
            <small>{{ field.help_text }}</small>
            {% endif %}
            {% for error in field.errors %}
            <p class="text-danger">{{ error }}</p>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- ProcurementItem Formset -->
    <table id="item-formset">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>D/form</th>
                <th>Brand</th>
                <th>Barcode</th>
                <th>Unit</th>
                <th>Quantity</th>
                <th>Cost Price</th>
                <th>Subtotal</th>
                <th>Expiry Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{ formset.management_form }}
            <!-- Using form prefix for all form fields -->
            {% for form in formset %}
            <tr class="form-row">
                <td>{{ form.item_name }}</td>
                <td>{{ form.dosage_form }}</td>
                <td>{{ form.brand }}</td>
                <td>
                    <div class="input-group" style="width: 220px;">
                        {{ form.barcode }}
                        <div class="input-group-append">
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary scan-row-btn"
                                    data-row-index="{{ forloop.counter0 }}"
                                    data-toggle="tooltip"
                                    title="Scan barcode for this row">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                </td>
                <td>{{ form.unit }}</td>
                <td>{{ form.quantity }}</td>
                <td>{{ form.cost_price }}</td>
                <td class="subtotal">₦0.00</td>
                <td>{{ form.expiry_date }}</td>
                <!-- Hidden fields -->
                {{ form.markup.as_hidden }}
                {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">
                {% endif %}
                <td>
                    {% if form.instance.pk %}
                    <input type="checkbox" name="{{ form.DELETE.name }}" id="{{ form.DELETE.id }}">
                    Delete
                    {% else %}
                    <button type="button" id="remove" class="btn btn-danger btn-sm remove-item"
                        onclick="removeRow(this)">Remove</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="row">
        <div class="col-md-6">
            <button class="btn btn-primary btn-sm" type="button" id="add-item">Add Item</button>
            <button class="btn btn-success btn-sm" id="save" type="submit" name="action" value="save">Save</button>
            <button class="btn btn-secondary btn-sm" id="pause" type="submit" name="action" value="pause">Pause</button>
        </div>
        <div class="col-md-6 text-right">
            <h4>Total: ₦<span id="grand-total">0.00</span></h4>
        </div>
    </div>

</form>


<script>
    // Function to calculate subtotal for a row
    function calculateSubtotal(row) {
        const quantity = parseFloat(row.querySelector('input[name$="-quantity"]').value) || 0;
        const costPrice = parseFloat(row.querySelector('input[name$="-cost_price"]').value) || 0;
        const subtotal = quantity * costPrice;
        row.querySelector('.subtotal').textContent = '₦' + subtotal.toFixed(2);
        return subtotal;
    }

    // Function to calculate grand total
    function calculateGrandTotal() {
        const rows = document.querySelectorAll('#item-formset tbody tr');
        let grandTotal = 0;
        rows.forEach(row => {
            const subtotalText = row.querySelector('.subtotal').textContent.replace(/[^\d.-]/g, '');
            grandTotal += parseFloat(subtotalText) || 0;
        });
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }

    // Function to search for items as user types with enhanced features
    function setupItemSearch(row) {
        const itemNameInput = row.querySelector('input[name$="-item_name"]');
        const dosageFormSelect = row.querySelector('select[name$="-dosage_form"]');
        const brandInput = row.querySelector('input[name$="-brand"]');
        const barcodeInput = row.querySelector('input[name$="-barcode"]');
        const unitSelect = row.querySelector('select[name$="-unit"]');
        const costPriceInput = row.querySelector('input[name$="-cost_price"]');
        const expiryDateInput = row.querySelector('input[name$="-expiry_date"]');

        if (!itemNameInput) return;

        // Create a dropdown for search results
        const searchResultsDiv = document.createElement('div');
        searchResultsDiv.className = 'search-results';
        searchResultsDiv.style.display = 'none';
        itemNameInput.parentNode.style.position = 'relative';
        itemNameInput.parentNode.appendChild(searchResultsDiv);

        // Debounce timer for API calls
        let debounceTimer;
        let currentFocusIndex = -1;
        let currentResults = [];

        // Function to select an item from results
        function selectItem(item) {
            console.log('Selected item:', item);
            
            itemNameInput.value = item.name;
            if (dosageFormSelect) {
                Array.from(dosageFormSelect.options).forEach(option => {
                    if (option.value === item.dosage_form) {
                        option.selected = true;
                    }
                });
            }
            if (brandInput) brandInput.value = item.brand;
            if (barcodeInput && item.barcode) {
                barcodeInput.value = item.barcode;
                console.log('Barcode set:', item.barcode);
            }
            if (unitSelect) {
                Array.from(unitSelect.options).forEach(option => {
                    if (option.value === item.unit) {
                        option.selected = true;
                    }
                });
            }
            if (costPriceInput) costPriceInput.value = item.cost_price;
            if (expiryDateInput && item.expiry_date) {
                expiryDateInput.value = item.expiry_date.split('T')[0];
            }

            // Hide search results
            searchResultsDiv.style.display = 'none';
            currentFocusIndex = -1;

            // Calculate subtotal and grand total
            calculateSubtotal(row);
            calculateGrandTotal();
            
            // Visual feedback - highlight the row briefly
            row.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 500);
        }

        // Function to update visual focus
        function updateFocus() {
            const items = searchResultsDiv.querySelectorAll('.search-result-item');
            items.forEach((item, index) => {
                if (index === currentFocusIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Function to fetch and display results
        function fetchAndDisplayResults(query) {
            if (query.length < 2) {
                searchResultsDiv.style.display = 'none';
                return;
            }

            // Show loading state
            searchResultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';
            searchResultsDiv.style.display = 'block';

            // Debounce API calls
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchUrl = `{% url 'store:search_store_items' %}?q=${encodeURIComponent(query)}`;
                console.log(`Searching: ${searchUrl}`);
                
                fetch(searchUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Found ${data.results.length} results for "${query}"`);
                        searchResultsDiv.innerHTML = '';
                        currentResults = data.results;
                        currentFocusIndex = -1;

                        if (data.results.length > 0) {
                            data.results.forEach((item, index) => {
                                const resultItem = document.createElement('div');
                                resultItem.className = 'search-result-item';
                                
                                // Build detailed item info
                                let itemDetails = `<strong>${item.name}</strong>`;
                                if (item.brand || item.dosage_form) {
                                    itemDetails += `<small>${item.dosage_form || ''}${item.dosage_form && item.brand ? ' - ' : ''}${item.brand || ''}</small>`;
                                }
                                if (item.barcode) {
                                    itemDetails += `<small style="color: #666;">Barcode: ${item.barcode}</small>`;
                                }
                                itemDetails += `<small style="color: #28a745;">Unit: ${item.unit || 'N/A'} | Cost: ₦${item.cost_price.toFixed(2)}</small>`;
                                
                                resultItem.innerHTML = itemDetails;

                                // Click handler
                                resultItem.addEventListener('click', () => selectItem(item));

                                searchResultsDiv.appendChild(resultItem);
                            });

                            // Add option to add new item
                            const addNewItem = document.createElement('div');
                            addNewItem.className = 'add-new-item';
                            addNewItem.innerHTML = '<strong>+ Add New Item</strong>';
                            addNewItem.addEventListener('click', () => {
                                window.open('{% url "store:add_item" %}', '_blank');
                            });
                            searchResultsDiv.appendChild(addNewItem);
                        } else {
                            searchResultsDiv.innerHTML = '<div class="search-no-results">No items found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching items:', error);
                        searchResultsDiv.innerHTML = `
                            <div class="search-no-results">
                                <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                                <br>Error loading results
                                <br><small style="color: #999;">${error.message}</small>
                            </div>
                        `;
                    });
            }, 300); // 300ms debounce
        }

        // Add event listener for input changes
        itemNameInput.addEventListener('input', function() {
            const query = this.value.trim();
            fetchAndDisplayResults(query);
        });

        // Keyboard navigation
        itemNameInput.addEventListener('keydown', function(e) {
            const items = searchResultsDiv.querySelectorAll('.search-result-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentFocusIndex < items.length - 1) {
                    currentFocusIndex++;
                    updateFocus();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentFocusIndex > 0) {
                    currentFocusIndex--;
                    updateFocus();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocusIndex >= 0 && currentResults[currentFocusIndex]) {
                    selectItem(currentResults[currentFocusIndex]);
                }
            } else if (e.key === 'Escape') {
                searchResultsDiv.style.display = 'none';
                currentFocusIndex = -1;
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!itemNameInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                searchResultsDiv.style.display = 'none';
                currentFocusIndex = -1;
            }
        });

        // Add focus indicator to input
        itemNameInput.addEventListener('focus', function() {
            this.style.borderColor = '#007bff';
        });

        itemNameInput.addEventListener('blur', function() {
            this.style.borderColor = '#ccc';
        });
    }

    // Add event listeners to quantity and cost price inputs
    function addCalculationListeners(row) {
        const quantityInput = row.querySelector('input[name$="-quantity"]');
        const costPriceInput = row.querySelector('input[name$="-cost_price"]');

        if (quantityInput && costPriceInput) {
            quantityInput.addEventListener('input', function() {
                calculateSubtotal(row);
                calculateGrandTotal();
            });

            costPriceInput.addEventListener('input', function() {
                calculateSubtotal(row);
                calculateGrandTotal();
            });
        }
    }

    // Initialize calculation listeners for existing rows
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('#item-formset tbody tr');
        rows.forEach(row => {
            addCalculationListeners(row);
            calculateSubtotal(row);
        });
        calculateGrandTotal();
    });

    document.getElementById('add-item').addEventListener('click', function () {
        const tableBody = document.querySelector('#item-formset tbody');
        const totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');  // Using the form prefix
        if (!totalForms) {
            console.error('Could not find the management form input. Check the form prefix.');
            return;
        }
        const formIdx = parseInt(totalForms.value);

        // Clone the last form row to create a new one
        const newRow = tableBody.querySelector('tr:last-child').cloneNode(true);

        newRow.querySelectorAll('input, select').forEach(input => {
            const nameAttr = input.name.replace(/-\d+-/, `-${formIdx}-`);
            const idAttr = input.id.replace(/-\d+-/, `-${formIdx}-`);

            input.name = nameAttr;
            input.id = idAttr;

            if (input.type !== 'hidden') {
                input.value = ''; // Clear input values for new row

                // Clear any validation errors
                input.classList.remove('is-invalid');
                const errorDiv = input.parentNode.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            } else if (input.name.includes('markup')) {
                // Set default value for markup field
                input.value = '0';
            } else if (input.name.includes('DELETE')) {
                // Ensure DELETE checkbox is unchecked for new rows
                input.checked = false;
            }
        });

        // Reset subtotal
        newRow.querySelector('.subtotal').textContent = '₦0.00';

        // Update the management form total
        totalForms.value = formIdx + 1;

        // Add the new row to the table body
        tableBody.appendChild(newRow);

        // Add calculation listeners and search to the new row
        addCalculationListeners(newRow);
        setupItemSearch(newRow);
    });

    // Remove a dynamically added row
    function removeRow(button) {
        const row = button.closest('tr');
        const totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');  // Using the form prefix
        if (!totalForms) {
            console.error('Could not find the management form input. Check the form prefix.');
            return;
        }

        // Update the management form total only if the row is successfully removed
        if (row) {
            row.remove();
            totalForms.value = parseInt(totalForms.value) - 1;

            // Re-index remaining rows to avoid index gaps
            const rows = document.querySelectorAll('#item-formset tbody tr');
            rows.forEach((row, index) => {
                row.querySelectorAll('input, select').forEach(input => {
                    input.name = input.name.replace(/-\d+-/, `-${index}-`);
                    input.id = input.id.replace(/-\d+-/, `-${index}-`);
                });
            });

            // Recalculate grand total
            calculateGrandTotal();
        }
    }

    // Initialize calculations and search for existing rows
    document.querySelectorAll('#item-formset tbody tr').forEach(row => {
        addCalculationListeners(row);
        setupItemSearch(row);
        calculateSubtotal(row);
    });
    calculateGrandTotal();
</script>

<!-- Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1" role="dialog" aria-labelledby="scannerModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="scannerModalLabel">
                    <i class="fas fa-camera"></i> Barcode Scanner
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Allow camera access when prompted</li>
                        <li>Position the barcode within the highlighted box</li>
                        <li>Hold steady until scan completes</li>
                        <li>The item will be automatically added and filled</li>
                    </ul>
                </div>

                <!-- Scanner viewport -->
                <div id="barcode-scanner" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>

                <!-- Scan feedback -->
                <div id="scan-result" class="mt-3 alert alert-success" style="display: none;">
                    <i class="fas fa-check-circle"></i> <span class="result-text"></span>
                </div>
                <div id="scan-error" class="mt-3 alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i> <span class="error-text"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (required for modal interactions) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Html5Qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Load procurement scanner -->
<script src="{% static 'js/procurement-scanner.js' %}"></script>

{% endblock %}

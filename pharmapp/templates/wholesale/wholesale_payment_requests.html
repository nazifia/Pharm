{% extends "partials/base.html" %}

{% load static %}

{% block title %}Wholesale Payment Requests{% endblock %}

{% block extra_css %}
<!-- Additional CSS if needed -->
<style>
    .badge-pending { background-color: #ffc107; }
    .badge-accepted { background-color: #28a745; }
    .badge-rejected { background-color: #dc3545; }
    .badge-completed { background-color: #17a2b8; }
    .badge-cancelled { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-store text-primary"></i>
            {% if is_admin %}
                All Wholesale Payment Requests
            {% else %}
                My Wholesale Payment Requests
            {% endif %}
        </h1>
        <div>
            {% if user.is_authenticated %}
            {% if user.cashier %}
            <a href="{% url 'wholesale:wholesale_cashier_dashboard' %}" class="btn btn-info mr-2">
                <i class="fas fa-cash-register mr-2"></i>Cashier Dashboard
            </a>
            {% endif %}
            {% endif %}
            <a href="{% url 'store:dashboard' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Django Messages Display -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle"></i>
                {% elif message.tags == 'error' or message.tags == 'danger' %}
                    <i class="fas fa-exclamation-circle"></i>
                {% elif message.tags == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                {% elif message.tags == 'info' %}
                    <i class="fas fa-info-circle"></i>
                {% endif %}
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Search Filters -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-filter mr-2"></i>Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <!-- Date Range Filters -->
                <div class="col-md-4">
                    <label for="start_date" class="form-label">Start Date:</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" 
                           value="{{ start_date|default:'' }}">
                </div>
                <div class="col-md-4">
                    <label for="end_date" class="form-label">End Date:</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" 
                           value="{{ end_date|default:'' }}">
                </div>
                
                <!-- Cashier Filter (Admin Only) -->
                {% if is_admin and all_cashiers %}
                <div class="col-md-4">
                    <label for="cashier_id" class="form-label">Cashier:</label>
                    <select id="cashier_id" name="cashier_id" class="form-select">
                        <option value="">All Cashiers</option>
                        {% for cashier in all_cashiers %}
                            <option value="{{ cashier.cashier_id }}"
                                {% if selected_cashier and selected_cashier.cashier_id == cashier.cashier_id %}selected{% endif %}>
                                {{ cashier.name }} ({{ cashier.cashier_id }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <!-- Filter Buttons -->
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>Apply Filters
                    </button>
                    <a href="{% url 'wholesale:wholesale_payment_requests' %}" class="btn btn-secondary">
                        <i class="fas fa-times mr-2"></i>Clear Filters
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if messages %}
        <div class="alert-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

            <!-- Search Results Summary -->
            {% if start_date or end_date or selected_cashier %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <strong>Search Results:</strong> 
                Found {{ payment_requests|length }} wholesale payment request{{ payment_requests|length|pluralize }}
                {% if start_date or end_date %}
                    for date range: {% if start_date %}{{ start_date }}{% endif %}{% if start_date and end_date %} to {% endif %}{% if end_date %}{{ end_date }}{% endif %}
                {% endif %}
                {% if selected_cashier %}
                    {% if start_date or end_date %} | {% endif %}Cashier: {{ selected_cashier.name }}
                {% endif %}
            </div>
            {% endif %}

            {% if payment_requests %}
        <!-- Payment Requests Table Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list-alt mr-2"></i>Your Wholesale Payment Requests
                </h6>
                <span class="badge badge-info">{{ payment_requests.count }} Requests</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="paymentRequestsTable" width="100%" cellspacing="0">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-hashtag mr-1"></i> Request ID</th>
                                <th><i class="fas fa-calendar mr-1"></i> Date</th>
                                <th><i class="fas fa-pills text-primary mr-1"></i> Dispenser</th>
                                <th><i class="fas fa-info-circle mr-1"></i> Status</th>
                                <th><i class="fas fa-money-bill-wave mr-1"></i> Total Amount</th>
                                <th><i class="fas fa-user mr-1"></i> Customer</th>
                                <th><i class="fas fa-cash-register text-success mr-1"></i> Cashier</th>
                                <th><i class="fas fa-shopping-cart mr-1"></i> Items Count</th>
                                <th><i class="fas fa-cog mr-1"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in payment_requests %}
                            <tr>
                                <td>
                                    <span class="font-weight-bold">{{ request.request_id }}</span>
                                </td>
                                <td>{{ request.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <span class="text-primary" title="Created by: {{ request.dispenser.username }}">
                                        <i class="fas fa-pills"></i> {{ request.dispenser.username }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-{{ request.status|lower }}">
                                        {{ request.status|title }}
                                    </span>
                                </td>
                                <td>
                                    <strong class="text-success">â‚¦{{ request.total_amount|floatformat:2 }}</strong>
                                </td>
                                <td>
                                    {% if request.wholesale_customer %}
                                        <i class="fas fa-user-tag"></i> {{ request.wholesale_customer.name }}
                                    {% elif request.buyer_name %}
                                        <i class="fas fa-user"></i> {{ request.buyer_name }}
                                    {% else %}
                                        <span class="text-muted">Walk-in Customer</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.cashier %}
                                        <span class="text-success">{{ request.cashier.name }}</span>
                                    {% elif request.status == 'completed' %}
                                        <span class="text-muted">N/A</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ request.items.count }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'wholesale:wholesale_payment_request_detail' request.request_id %}"
                                       class="btn btn-sm btn-info" title="View Details">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <!-- No Requests Message Card -->
        <div class="card shadow mb-4">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-receipt text-muted" style="font-size: 4rem;"></i>
                </div>
                <h4 class="text-gray-800 mb-3">No Wholesale Payment Requests</h4>
                <p class="text-muted mb-4">
                    {% if start_date or end_date or selected_cashier %}
                        No wholesale payment requests found matching your search criteria.
                        {% if start_date or end_date %}
                            Date range: {% if start_date %}{{ start_date }}{% endif %}{% if start_date and end_date %} to {% endif %}{% if end_date %}{{ end_date }}{% endif %}
                        {% endif %}
                        {% if selected_cashier %}
                            {% if start_date or end_date %} | {% endif %}Cashier: {{ selected_cashier.name }}
                        {% endif %}
                    {% else %}
                        {% if is_admin %}
                            No wholesale payment requests found in the system.
                        {% else %}
                            You haven't sent any wholesale payment requests to the cashier yet.
                        {% endif %}
                    {% endif %}
                </p>
                {% if not is_admin %}
                <div class="d-flex justify-content-center">
                    <a href="{% url 'wholesale:wholesale_cart' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-cart mr-2"></i>Go to Wholesale Cart
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables for better table functionality -->
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">

<script>
$(document).ready(function() {
    $('#paymentRequestsTable').DataTable({
        responsive: true,
        pageLength: 25,
        order: [[1, 'desc']], // Sort by date descending
        language: {
            search: "Search payment requests:",
            lengthMenu: "Show _MENU_ requests per page",
            info: "Showing _START_ to _END_ of _TOTAL_ payment requests",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Check if there's a success message about payment request being sent
    const successMessages = document.querySelectorAll('.alert-success, .alert.alert-success');

    successMessages.forEach(function(messageElement) {
        const messageText = messageElement.textContent || messageElement.innerText;

        // Check if message contains "sent to cashier successfully"
        if (messageText.includes('sent to cashier successfully')) {
            console.log('[Wholesale Payment Request] Payment sent to cashier - setting localStorage flag');

            // Set flag with timestamp to trigger dispense page refresh
            localStorage.setItem('wholesale_payment_request_sent', Date.now().toString());

            // Clear flag after 5 seconds to prevent stale refreshes
            setTimeout(function() {
                localStorage.removeItem('wholesale_payment_request_sent');
                console.log('[Wholesale Payment Request] localStorage flag cleared');
            }, 5000);
        }
    });
});
</script>
{% endblock %}

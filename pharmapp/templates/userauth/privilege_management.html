{% extends "partials/base.html" %}
{% load custom_filters %}
{% load permission_tags %}
{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Privilege Management</h1>
                <a href="{% url 'userauth:user_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to User List
                </a>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Dispenser vs Cashier Information Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Dispenser vs Cashier Roles - Important Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-pills"></i> Dispenser Role</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Can dispense medications and items</li>
                                <li><i class="fas fa-check text-success"></i> Can create payment requests</li>
                                <li><i class="fas fa-check text-success"></i> Can view their own payment request history</li>
                                <li><i class="fas fa-check text-success"></i> Has access to medical and sales operations</li>
                                <li><strong class="text-primary">Roles:</strong> Admin, Manager, Pharmacist, Pharm-Tech, Salesperson, Wholesale roles</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fas fa-cash-register"></i> Cashier Role</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Can process payments</li>
                                <li><i class="fas fa-check text-success"></i> Can handle payment requests</li>
                                <li><i class="fas fa-check text-success"></i> Has access to cashier dashboard</li>
                                <li><i class="fas fa-check text-success"></i> Can manage payment workflows</li>
                                <li><strong class="text-success">Roles:</strong> Dedicated Cashier users (separate from dispensers)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Key Separation:</strong> A user cannot be both a dispenser and a cashier. 
                        Dispensers create payment requests, while cashiers process them. This ensures proper workflow separation and audit trails.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- User Selection and Privilege Assignment -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog"></i> Select User for Privilege Management
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="privilege-form">
                        {% csrf_token %}
                        <input type="hidden" id="selected_user_id" name="selected_user_id" value=""">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.user.id_for_label }}">Select User:</label>
                                {{ form.user }}
                                {% if form.user.help_text %}
                                    <small class="form-text text-muted">{{ form.user.help_text }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>&nbsp;</label>
                                <div>
                                    <button type="button" class="btn btn-info" onclick="loadUserPermissions()">
                                        <i class="fas fa-search"></i> Load User Permissions
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="permissions-section" style="display: none;">
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Available Permissions:</h6>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="permission-search" class="form-control form-control-sm mr-2"
                                           placeholder="Search permissions..." style="width: 200px;">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="filterPermissions('all')" id="filter-all">All</button>
                                        <button type="button" class="btn btn-outline-success" onclick="filterPermissions('granted')" id="filter-granted">Granted</button>
                                        <button type="button" class="btn btn-outline-warning" onclick="filterPermissions('revoked')" id="filter-revoked">Revoked</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                {% for field in form %}
                                    {% if 'permission_' in field.name %}
                                        <div class="col-md-4 mb-2">
                                            <div class="form-check">
                                                {{ field }}
                                                <label class="form-check-label" for="{{ field.id_for_label }}">
                                                    {{ field.label }}
                                                </label>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Permissions
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Role-Based Permissions Reference -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Role-Based Permissions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="rolePermissionsAccordion">
                        {% for role, permissions in user_permissions.items %}
                            <div class="card">
                                <div class="card-header p-2" id="heading{{ forloop.counter }}">
                                    <h6 class="mb-0">
                                        <button class="btn btn-link btn-sm" type="button" data-toggle="collapse"
                                                data-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                                                aria-controls="collapse{{ forloop.counter }}">
                                            {% if role == 'Cashier' %}
                                                <span class="badge badge-success">
                                                    <i class="fas fa-cash-register"></i> {{ role }}
                                                </span>
                                            {% elif role == 'Admin' or role == 'Manager' or role == 'Pharmacist' or role == 'Pharm-Tech' or role == 'Salesperson' or role == 'Wholesale Manager' or role == 'Wholesale Operator' or role == 'Wholesale Salesperson' %}
                                                <span class="badge badge-primary">
                                                    <i class="fas fa-pills"></i> {{ role }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-info">{{ role }}</span>
                                            {% endif %}
                                        </button>
                                    </h6>
                                </div>
                                <div id="collapse{{ forloop.counter }}" class="collapse"
                                     aria-labelledby="heading{{ forloop.counter }}"
                                     data-parent="#rolePermissionsAccordion">
                                    <div class="card-body p-2">
                                        <small>
                                            {% for permission in permissions %}
                                                <div class="permission-item">
                                                    <i class="fas fa-check text-success"></i>
                                                    {{ permission|format_permission }}
                                                </div>
                                            {% endfor %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-sm" onclick="selectAllPermissions()">
                            <i class="fas fa-check-square"></i> Select All Permissions
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllPermissions()">
                            <i class="fas fa-square"></i> Clear All Permissions
                        </button>
                        <hr>
                        <button type="button" class="btn btn-info btn-sm" onclick="applyRoleTemplate('Admin')">
                            <i class="fas fa-user-shield"></i> Apply Admin Template
                        </button>
                        <button type="button" class="btn btn-success btn-sm" onclick="applyRoleTemplate('Manager')">
                            <i class="fas fa-user-tie"></i> Apply Manager Template
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="applyRoleTemplate('Pharmacist')">
                            <i class="fas fa-pills"></i> Apply Pharmacist Template
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="applyRoleTemplate('Pharm-Tech')">
                            <i class="fas fa-user-md"></i> Apply Pharm-Tech Template
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyRoleTemplate('Salesperson')">
                            <i class="fas fa-handshake"></i> Apply Salesperson Template
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="applyRoleTemplate('Cashier')">
                            <i class="fas fa-cash-register"></i> Apply Cashier Template
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="applyRoleTemplate('Wholesale Manager')">
                            <i class="fas fa-store"></i> Apply Wholesale Manager Template
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="applyRoleTemplate('Wholesale Operator')">
                            <i class="fas fa-industry"></i> Apply Wholesale Operator Template
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="applyRoleTemplate('Wholesale Salesperson')">
                            <i class="fas fa-users"></i> Apply Wholesale Salesperson Template
                        </button>
                        <hr>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="showBulkPermissionModal()">
                            <i class="fas fa-users-cog"></i> Bulk Permission Management
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Permission Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stat-number" id="total-permissions">{{ user_permissions|length }}</div>
                <div class="stat-label">User Roles</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stat-number" id="total-users">-</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stat-number" id="active-permissions">-</div>
                <div class="stat-label">Active Permissions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stat-number" id="custom-permissions">-</div>
                <div class="stat-label">Custom Permissions</div>
            </div>
        </div>
    </div>

    <!-- Cashier Assignment Management -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cash-register"></i> Cashier Assignment Management
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-light" onclick="addNewCashier()">
                                <i class="fas fa-plus"></i> Add Cashier
                            </button>
                            <button class="btn btn-light" onclick="refreshCashierList()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="cashier-search" placeholder="Search cashiers...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="cashier-type-filter">
                                <option value="">All Types</option>
                                <option value="retail">Retail Only</option>
                                <option value="wholesale">Wholesale Only</option>
                                <option value="both">Retail & Wholesale</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="cashier-status-filter">
                                <option value="">All Status</option>
                                <option value="True">Active</option>
                                <option value="False">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="searchCashiers()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>

                    <!-- Cashier List -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="cashier-table">
                            <thead class="table-primary">
                                <tr>
                                    <th>Cashier ID</th>
                                    <th>Name</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cashier-tbody">
                                <!-- Cashier data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cashier Statistics -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Cashier Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-item mb-3">
                                <h4 class="text-primary" id="total-cashiers">0</h4>
                                <small>Total Cashiers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item mb-3">
                                <h4 class="text-success" id="active-cashiers">0</h4>
                                <small>Active</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item mb-3">
                                <h4 class="text-warning" id="retail-cashiers">0</h4>
                                <small>Retail Only</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item mb-3">
                                <h4 class="text-info" id="wholesale-cashiers">0</h4>
                                <small>Wholesale Only</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="text-center mb-3">Both Operations</h6>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="both-cashiers-progress" style="width: 0%">0</div>
                        </div>
                        <small class="text-muted">Cashiers handling both retail & wholesale</small>
                    </div>
                </div>
            </div>

            <!-- Quick Cashier Actions -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-sm" onclick="addNewCashier()">
                            <i class="fas fa-plus"></i> Add New Cashier
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="viewCashierDashboard()">
                            <i class="fas fa-chart-line"></i> View Dashboard
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="exportCashierReport()">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="bulkUpdateCashiers()">
                            <i class="fas fa-users-cog"></i> Bulk Update
                        </button>
                        <hr>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deactivateInactiveCashiers()">
                            <i class="fas fa-user-minus"></i> Deactivate Inactive
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="sendNotifications()">
                            <i class="fas fa-bell"></i> Send Notifications
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current User Permissions Display -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Current User Permissions Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div id="current-permissions-display">
                        <p class="text-muted text-center">Select a user to view their current permissions.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wholesale Cashier Management Section -->
    <div class="row">
        <!-- Wholesale Cashier Functions -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-store"></i> Wholesale Cashier Functions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="wholesaleFunctionsAccordion">
                        <!-- Payment Processing -->
                        <div class="card">
                            <div class="card-header p-2" id="headingPayment">
                                <h6 class="mb-0">
                                    <button class="btn btn-link btn-sm" type="button" data-toggle="collapse"
                                            data-target="#collapsePayment" aria-expanded="false"
                                            aria-controls="collapsePayment">
                                        <span class="badge badge-warning">
                                            <i class="fas fa-credit-card"></i> Payment Processing
                                        </span>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapsePayment" class="collapse"
                                 aria-labelledby="headingPayment"
                                 data-parent="#wholesaleFunctionsAccordion">
                                <div class="card-body p-2">
                                    <small>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Process wholesale payment requests
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Accept pending payment requests
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Reject payment requests with reasons
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Generate wholesale receipts
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Handle payment method verification
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Request Management -->
                        <div class="card">
                            <div class="card-header p-2" id="headingRequest">
                                <h6 class="mb-0">
                                    <button class="btn btn-link btn-sm" type="button" data-toggle="collapse"
                                            data-target="#collapseRequest" aria-expanded="false"
                                            aria-controls="collapseRequest">
                                        <span class="badge badge-info">
                                            <i class="fas fa-list"></i> Request Management
                                        </span>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapseRequest" class="collapse"
                                 aria-labelledby="headingRequest"
                                 data-parent="#wholesaleFunctionsAccordion">
                                <div class="card-body p-2">
                                    <small>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> View pending payment requests
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Filter requests by status
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Search payment requests by ID
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Bulk process multiple requests
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Export payment request data
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Reporting Analytics -->
                        <div class="card">
                            <div class="card-header p-2" id="headingAnalytics">
                                <h6 class="mb-0">
                                    <button class="btn btn-link btn-sm" type="button" data-toggle="collapse"
                                            data-target="#collapseAnalytics" aria-expanded="false"
                                            aria-controls="collapseAnalytics">
                                        <span class="badge badge-primary">
                                            <i class="fas fa-chart-bar"></i> Reporting & Analytics
                                        </span>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapseAnalytics" class="collapse"
                                 aria-labelledby="headingAnalytics"
                                 data-parent="#wholesaleFunctionsAccordion">
                                <div class="card-body p-2">
                                    <small>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> View daily payment statistics
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Generate monthly cashier reports
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Track processing times
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Monitor cashier performance
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Export financial data
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Session Management -->
                        <div class="card">
                            <div class="card-header p-2" id="headingSession">
                                <h6 class="mb-0">
                                    <button class="btn btn-link btn-sm" type="button" data-toggle="collapse"
                                            data-target="#collapseSession" aria-expanded="false"
                                            aria-controls="collapseSession">
                                        <span class="badge badge-success">
                                            <i class="fas fa-user-clock"></i> Session Management
                                        </span>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapseSession" class="collapse"
                                 aria-labelledby="headingSession"
                                 data-parent="#wholesaleFunctionsAccordion">
                                <div class="card-body p-2">
                                    <small>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Start cashier session
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> End cashier session
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> View active cashier sessions
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Monitor session activities
                                        </div>
                                        <div class="permission-item">
                                            <i class="fas fa-check text-success"></i> Access session audit logs
                                        </div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt"></i> Quick Cashier Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-sm" onclick="openWholesaleCashier()">
                            <i class="fas fa-cash-register"></i> Open Cashier Dashboard
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="viewWholesaleRequests()">
                            <i class="fas fa-list"></i> View All Requests
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="refreshWholesaleStats()">
                            <i class="fas fa-sync-alt"></i> Refresh Statistics
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="startCashierSession()">
                            <i class="fas fa-play"></i> Start Cashier Session
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="endCashierSession()">
                            <i class="fas fa-stop"></i> End Cashier Session
                        </button>
                        <hr>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="generateCashierReport()">
                            <i class="fas fa-file-invoice"></i> Generate Daily Report
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="exportCashierData()">
                            <i class="fas fa-download"></i> Export Payment Data
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewCashierAudit()">
                            <i class="fas fa-history"></i> View Audit Trail
                        </button>
                        <hr>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="openBulkOperation()">
                            <i class="fas fa-users-cog"></i> Bulk Operations
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cashier Management Modal -->
<div class="modal fade" id="cashierManagementModal" tabindex="-1" role="dialog" aria-labelledby="cashierManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="cashierManagementModalLabel">
                    <i class="fas fa-cash-register"></i> Add/Edit Cashier
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="cashier-form" method="POST">
                {% csrf_token %}
                <input type="hidden" id="cashier-id" name="cashier_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cashier-user">User:</label>
                                <select class="form-control" id="cashier-user" name="user" required>
                                    <option value="">Select a user...</option>
                                    <!-- Users will be loaded dynamically -->
                                </select>
                                <small class="form-text text-muted">Select a user to assign as cashier</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cashier-name">Cashier Name:</label>
                                <input type="text" class="form-control" id="cashier-name" name="name" required 
                                       placeholder="Enter cashier display name">
                                <small class="form-text text-muted">This name will be displayed on receipts</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cashier-type">Cashier Type:</label>
                                <select class="form-control" id="cashier-type" name="cashier_type" required>
                                    <option value="">Select type...</option>
                                    <option value="retail">Retail Only</option>
                                    <option value="wholesale">Wholesale Only</option>
                                    <option value="both">Retail & Wholesale</option>
                                </select>
                                <small class="form-text text-muted">What operations can this cashier handle?</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="cashier-active" name="is_active" checked>
                                    <label class="form-check-label" for="cashier-active">
                                        <i class="fas fa-toggle-on text-success"></i> Active Cashier
                                    </label>
                                    <small class="form-text text-muted">Enable/disable cashier access</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Cashier Types:</strong><br>
                        • <strong>Retail Only:</strong> Can handle retail payment requests<br>
                        • <strong>Wholesale Only:</strong> Can handle wholesale payment requests<br>
                        • <strong>Retail & Wholesale:</strong> Can handle both types of requests
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Save Cashier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Permission Management Modal -->
<div class="modal fade" id="bulkPermissionModal" tabindex="-1" role="dialog" aria-labelledby="bulkPermissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bulkPermissionModalLabel">
                    <i class="fas fa-users-cog"></i> Bulk Permission Management
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bulk-permission-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Select Users:</h6>
                            <div class="form-group">
                                <select multiple class="form-control" id="bulk-users" name="users" size="8">
                                    <!-- Users will be loaded dynamically -->
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple users</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Select Permission:</h6>
                            <div class="form-group">
                                <select class="form-control" id="bulk-permission" name="permission">
                                    <option value="">Select a permission...</option>
                                    <!-- Permissions will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Action:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="bulk-action" id="bulk-grant" value="grant" checked>
                                    <label class="form-check-label" for="bulk-grant">
                                        <i class="fas fa-check text-success"></i> Grant Permission
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="bulk-action" id="bulk-revoke" value="revoke">
                                    <label class="form-check-label" for="bulk-revoke">
                                        <i class="fas fa-times text-danger"></i> Revoke Permission
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkPermission()">
                    <i class="fas fa-save"></i> Apply Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Role permission templates
const rolePermissions = {{ user_permissions|safe }};

// Cashier management variables
let allCashiers = [];
let currentCashierId = null;

// Cashier Management Functions
function loadCashiers() {
    // Load cashiers from real API
    fetch('/api/cashiers/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            allCashiers = data.cashiers;
            displayCashiers(data.cashiers);
            updateCashierStatistics(data.cashiers);
        } else {
            console.error('Error loading cashiers:', data.error);
            showNotification('Error loading cashiers: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading cashiers:', error);
        showNotification('Network error loading cashiers', 'danger');
    });
}

function displayCashiers(cashiers) {
    const tbody = document.getElementById('cashier-tbody');
    
    if (cashiers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>No cashiers found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = cashiers.map(cashier => `
        <tr>
            <td><span class="badge badge-primary">${cashier.cashier_id}</span></td>
            <td>${cashier.name}</td>
            <td>${cashier.user.full_name || cashier.user.username}</td>
            <td>
                <span class="badge badge-${getCashierTypeBadgeClass(cashier.cashier_type)}">
                    ${getCashierTypeDisplay(cashier.cashier_type)}
                </span>
            </td>
            <td>
                <span class="badge badge-${cashier.is_active ? 'success' : 'secondary'}">
                    ${cashier.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editCashier(${cashier.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-${cashier.is_active ? 'warning' : 'success'}"
                            onclick="toggleCashierStatus(${cashier.id})"
                            title="${cashier.is_active ? 'Deactivate' : 'Activate'}">
                        <i class="fas fa-${cashier.is_active ? 'eye-slash' : 'eye'}"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteCashier(${cashier.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getCashierTypeBadgeClass(type) {
    switch(type) {
        case 'retail': return 'warning';
        case 'wholesale': return 'info';
        case 'both': return 'success';
        default: return 'secondary';
    }
}

function getCashierTypeDisplay(type) {
    switch(type) {
        case 'retail': return 'Retail Only';
        case 'wholesale': return 'Wholesale Only';
        case 'both': return 'Retail & Wholesale';
        default: return 'Unknown';
    }
}

function updateCashierStatistics(cashiers) {
    const total = cashiers.length;
    const active = cashiers.filter(c => c.is_active).length;
    const retail = cashiers.filter(c => c.cashier_type === 'retail').length;
    const wholesale = cashiers.filter(c => c.cashier_type === 'wholesale').length;
    const both = cashiers.filter(c => c.cashier_type === 'both').length;
    
    document.getElementById('total-cashiers').textContent = total;
    document.getElementById('active-cashiers').textContent = active;
    document.getElementById('retail-cashiers').textContent = retail;
    document.getElementById('wholesale-cashiers').textContent = wholesale;
    
    const bothPercentage = total > 0 ? Math.round((both / total) * 100) : 0;
    const bothProgressBar = document.getElementById('both-cashiers-progress');
    bothProgressBar.style.width = bothPercentage + '%';
    bothProgressBar.textContent = both;
}

function searchCashiers() {
    const searchTerm = document.getElementById('cashier-search').value.toLowerCase();
    const typeFilter = document.getElementById('cashier-type-filter').value;
    const statusFilter = document.getElementById('cashier-status-filter').value;
    
    let filteredCashiers = allCashiers.filter(cashier => {
        const matchesSearch = !searchTerm || 
            cashier.name.toLowerCase().includes(searchTerm) ||
            cashier.cashier_id.toLowerCase().includes(searchTerm) ||
            cashier.user.toLowerCase().includes(searchTerm);
            
        const matchesType = !typeFilter || cashier.cashier_type === typeFilter;
        const matchesStatus = !statusFilter || cashier.is_active.toString() === statusFilter;
        
        return matchesSearch && matchesType && matchesStatus;
    });
    
    displayCashiers(filteredCashiers);
}

function addNewCashier() {
    currentCashierId = null;
    document.getElementById('cashier-id').value = '';
    document.getElementById('cashier-user').value = '';
    document.getElementById('cashier-name').value = '';
    document.getElementById('cashier-type').value = '';
    document.getElementById('cashier-active').checked = true;
    
    // Load available users (simulated)
    loadAvailableUsers();
    
    document.getElementById('cashierManagementModalLabel').innerHTML = 
        '<i class="fas fa-cash-register"></i> Add New Cashier';
    $('#cashierManagementModal').modal('show');
}

function loadAvailableUsers() {
    // Load available users from real API
    const userSelect = document.getElementById('cashier-user');
    userSelect.innerHTML = '<option value="">Loading users...</option>';
    
    fetch('/api/available-users/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            userSelect.innerHTML = '<option value="">Select a user...</option>' + 
                data.users.map(user => 
                    `<option value="${user.id}">${user.full_name} (${user.username}) - ${user.user_type}</option>`
                ).join('');
        } else {
            console.error('Error loading available users:', data.error);
            userSelect.innerHTML = '<option value="">No users available</option>';
        }
    })
    .catch(error => {
        console.error('Error loading available users:', error);
        userSelect.innerHTML = '<option value="">Error loading users</option>';
    });
}

function editCashier(cashierId) {
    const cashier = allCashiers.find(c => c.id === cashierId);
    if (!cashier) return;
    
    currentCashierId = cashierId;
    document.getElementById('cashier-id').value = cashierId;
    document.getElementById('cashier-name').value = cashier.name;
    document.getElementById('cashier-type').value = cashier.cashier_type;
    document.getElementById('cashier-active').checked = cashier.is_active;
    
    loadAvailableUsers();
    // Set the user selection (using user ID for the form field)
    document.getElementById('cashier-user').value = cashier.user.id;
    
    document.getElementById('cashierManagementModalLabel').innerHTML = 
        '<i class="fas fa-cash-register"></i> Edit Cashier';
    $('#cashierManagementModal').modal('show');
}

function toggleCashierStatus(cashierId) {
    const cashier = allCashiers.find(c => c.id === cashierId);
    if (!cashier) return;

    const newStatus = !cashier.is_active;
    const action = newStatus ? 'activate' : 'deactivate';

    if (confirm(`Are you sure you want to ${action} ${cashier.name}?`)) {
        updateCashierStatus(cashierId, { is_active: newStatus });
    }
}

function updateCashierStatus(cashierId, data) {
    fetch(`/api/cashier/${cashierId}/`, {
        method: 'PUT',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Cashier status updated successfully', 'success');
            loadCashiers(); // Reload to get fresh data
        } else {
            showNotification('Error updating cashier: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error updating cashier:', error);
        showNotification('Network error updating cashier: ' + error.message, 'danger');
    });
}

function deleteCashier(cashierId) {
    const cashier = allCashiers.find(c => c.id === cashierId);
    if (!cashier) return;

    if (confirm(`Are you sure you want to delete ${cashier.name}? This action cannot be undone.`)) {
        fetch(`/api/cashier/${cashierId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Cashier deleted successfully', 'success');
                loadCashiers(); // Reload to get fresh data
            } else {
                showNotification('Error deleting cashier: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting cashier:', error);
            showNotification('Network error deleting cashier: ' + error.message, 'danger');
        });
    }
}

function refreshCashierList() {
    loadCashiers();
    showNotification('Cashier list refreshed', 'info');
}

function viewCashierDashboard() {
    alert('Cashier dashboard would open here showing detailed analytics and performance metrics.');
}

function exportCashierReport() {
    alert('Cashier report export functionality would be implemented here.');
}

function bulkUpdateCashiers() {
    alert('Bulk cashier update functionality would be implemented here.');
}

function deactivateInactiveCashiers() {
    if (confirm('Are you sure you want to deactivate all inactive cashiers?')) {
        alert('Bulk deactivation functionality would be implemented here.');
    }
}

function sendNotifications() {
    alert('Send notifications to all cashiers functionality would be implemented here.');
}

function showNotification(message, type) {
    // Create a simple notification (you can enhance this)
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Handle cashier form submission
document.addEventListener('DOMContentLoaded', function() {
    const cashierForm = document.getElementById('cashier-form');
    if (cashierForm) {
        cashierForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(cashierForm);
            const cashierId = formData.get('cashier_id');

            const endpoint = cashierId ? `/api/cashier/${cashierId}/` : '/api/cashiers/';
            const method = cashierId ? 'PUT' : 'POST';
            
            const data = {
                user_id: parseInt(formData.get('user')),
                name: formData.get('name'),
                cashier_type: formData.get('cashier_type'),
                is_active: formData.get('is_active') === 'on'
            };
            
            fetch(endpoint, {
                method: method,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(cashierId ? 'Cashier updated successfully' : 'Cashier created successfully', 'success');
                    $('#cashierManagementModal').modal('hide');
                    // Reload the full cashier list to get complete data
                    loadCashiers();
                } else {
                    showNotification('Error saving cashier: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving cashier:', error);
                showNotification('Network error saving cashier: ' + error.message, 'danger');
            });
        });
    }
    
    // Load cashiers on page load
    loadCashiers();
});

function loadUserPermissions() {
    const userSelect = document.querySelector('select[name="user"]');
    const selectedUserId = userSelect.value;

    if (!selectedUserId) {
        alert('Please select a user first.');
        return;
    }

    // Show loading state
    const permissionsSection = document.getElementById('permissions-section');
    permissionsSection.style.display = 'block';
    permissionsSection.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading permissions...</div>';

    // Make AJAX call to get user's current permissions
    fetch(`/api/user-permissions/${selectedUserId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Set the selected user ID in the hidden field
                document.getElementById('selected_user_id').value = selectedUserId;

                // Update checkboxes dynamically
                updatePermissionCheckboxes(data.permissions);
                updateCurrentPermissionsDisplay(data.user, data.permissions);
            } else {
                alert('Error loading user permissions: ' + data.error);
                permissionsSection.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading user permissions');
            permissionsSection.style.display = 'none';
        });
}

function updateCurrentPermissionsDisplay(user, permissions = null) {
    const displayDiv = document.getElementById('current-permissions-display');

    if (typeof user === 'string') {
        // Legacy call with just userId
        const userSelect = document.querySelector('select[name="user"]');
        const selectedOption = userSelect.options[userSelect.selectedIndex];
        const userName = selectedOption.text;

        displayDiv.innerHTML = `
            <h6>Permissions for: <span class="badge badge-primary">${userName}</span></h6>
            <p class="text-info">Use the form above to modify permissions for this user.</p>
        `;
        return;
    }

    if (!user || !permissions) {
        displayDiv.innerHTML = '<p class="text-muted text-center">Select a user to view their current permissions.</p>';
        return;
    }

    // Role templates for comparison
    const roleTemplates = {
        'Pharmacist': ['manage_inventory', 'dispense_medication', 'process_sales', 'manage_customers', 'adjust_prices', 'process_returns', 'transfer_stock', 'view_sales_history', 'view_procurement_history', 'process_split_payments', 'search_items'],
        'Sales Representative': ['process_sales', 'manage_customers', 'view_sales_history', 'process_returns', 'process_split_payments', 'search_items'],
        'Inventory Manager': ['manage_inventory', 'perform_stock_check', 'transfer_stock', 'adjust_prices', 'view_procurement_history', 'search_items'],
        'Admin': ['manage_users', 'edit_user_profiles', 'access_admin_panel', 'manage_inventory', 'dispense_medication', 'process_sales', 'manage_customers', 'adjust_prices', 'process_returns', 'transfer_stock', 'view_sales_history', 'view_procurement_history', 'process_split_payments', 'search_items', 'perform_stock_check', 'view_reports', 'view_financial_reports', 'view_activity_logs']
    };

    // Get user's role permissions for comparison
    const rolePermissions = roleTemplates[user.user_type] || [];

    // Categorize permissions based on the API response structure (simple boolean format)
    const allGrantedPermissions = [];
    const roleBasedPermissions = [];
    const individuallyGrantedPermissions = [];
    const individuallyRevokedPermissions = [];

    // Process all permissions
    Object.entries(permissions).forEach(([permission, isGranted]) => {
        const isRolePermission = rolePermissions.includes(permission);

        if (isGranted) {
            allGrantedPermissions.push(permission);
            if (isRolePermission) {
                roleBasedPermissions.push(permission);
            } else {
                // This permission is granted but not in role - individually granted
                individuallyGrantedPermissions.push(permission);
            }
        } else if (isRolePermission) {
            // This is a role permission that has been individually revoked
            individuallyRevokedPermissions.push(permission);
        }
    });

    let html = `
        <div class="user-permissions-summary">
            <h6>Permissions for: <span class="badge badge-primary">${user.full_name || user.username}</span>
            <small class="text-muted">(${user.user_type})</small></h6>
    `;

    // Summary statistics
    html += `
        <div class="row mb-3">
            <div class="col-3">
                <div class="text-center">
                    <div class="h4 text-primary">${allGrantedPermissions.length}</div>
                    <small class="text-muted">Total Active</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <div class="h4 text-success">${roleBasedPermissions.length}</div>
                    <small class="text-muted">From Role</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <div class="h4 text-info">${individuallyGrantedPermissions.length}</div>
                    <small class="text-muted">Individual Granted</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <div class="h4 text-danger">${individuallyRevokedPermissions.length}</div>
                    <small class="text-muted">Revoked</small>
                </div>
            </div>
        </div>
    `;

    // Show categorized permissions
    if (roleBasedPermissions.length > 0) {
        html += `
            <div class="permission-category mb-3">
                <h6 class="text-success"><i class="fas fa-user-tag"></i> Role-Based Permissions (${roleBasedPermissions.length})</h6>
                <div class="permission-badges">
        `;
        roleBasedPermissions.forEach(permission => {
            const displayName = permission.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<span class="badge badge-success mr-1 mb-1">${displayName}</span>`;
        });
        html += `</div></div>`;
    }

    if (individuallyGrantedPermissions.length > 0) {
        html += `
            <div class="permission-category mb-3">
                <h6 class="text-info"><i class="fas fa-plus-circle"></i> Individually Granted (${individuallyGrantedPermissions.length})</h6>
                <div class="permission-badges">
        `;
        individuallyGrantedPermissions.forEach(permission => {
            const displayName = permission.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<span class="badge badge-info mr-1 mb-1">${displayName}</span>`;
        });
        html += `</div></div>`;
    }

    if (individuallyRevokedPermissions.length > 0) {
        html += `
            <div class="permission-category mb-3">
                <h6 class="text-danger"><i class="fas fa-minus-circle"></i> Individually Revoked (${individuallyRevokedPermissions.length})</h6>
                <div class="permission-badges">
        `;
        individuallyRevokedPermissions.forEach(permission => {
            const displayName = permission.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<span class="badge badge-danger mr-1 mb-1">${displayName}</span>`;
        });
        html += `</div></div>`;
    }

    html += `
            <div class="mt-3">
                <p class="text-info"><i class="fas fa-info-circle"></i> Use the permission management panel above to modify permissions for this user.</p>
            </div>
        </div>`;

    displayDiv.innerHTML = html;
}

function restorePermissionsSection() {
    // This function will be called after we get the permissions data
    // The actual restoration will happen in updatePermissionCheckboxes
}

function updatePermissionCheckboxes(permissions) {
    const permissionsSection = document.getElementById('permissions-section');

    // Generate the permissions section HTML
    let html = `
        <hr>
        <h6>Available Permissions:</h6>
        <div class="row" id="permissions-grid">
    `;

    // Sort permissions alphabetically
    const sortedPermissions = Object.keys(permissions).sort();

    sortedPermissions.forEach(permission => {
        const data = permissions[permission];
        const permissionLabel = permission.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        // Determine badge for permission source
        let badge = '';
        if (data.source === 'individual') {
            const badgeClass = data.granted ? 'badge-success' : 'badge-warning';
            const badgeText = data.granted ? 'Individual' : 'Revoked';
            badge = `<span class="badge ${badgeClass} badge-sm ml-1">${badgeText}</span>`;
        } else if (data.role_based) {
            badge = `<span class="badge badge-info badge-sm ml-1">Role</span>`;
        }

        html += `
            <div class="col-md-4 mb-2">
                <div class="form-check">
                    <input type="checkbox"
                           name="permission_${permission}"
                           id="id_permission_${permission}"
                           class="form-check-input"
                           ${data.granted ? 'checked' : ''}>
                    <label class="form-check-label" for="id_permission_${permission}">
                        ${permissionLabel}
                        ${badge}
                    </label>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div class="mt-3">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Save Permissions
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    `;

    permissionsSection.innerHTML = html;
}

function selectAllPermissions() {
    const checkboxes = document.querySelectorAll('input[name^="permission_"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function clearAllPermissions() {
    const checkboxes = document.querySelectorAll('input[name^="permission_"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

function applyRoleTemplate(role) {
    if (!rolePermissions[role]) {
        alert('Role template not found.');
        return;
    }

    // Clear all first
    clearAllPermissions();

    // Apply role permissions
    const permissions = rolePermissions[role];
    permissions.forEach(permission => {
        const checkbox = document.querySelector(`input[name="permission_${permission}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });

    alert(`Applied ${role} permission template.`);
}

function showBulkPermissionModal() {
    // Load users and permissions for bulk management
    loadBulkUsers();
    loadBulkPermissions();
    $('#bulkPermissionModal').modal('show');
}

function loadBulkUsers() {
    const userSelect = document.getElementById('bulk-users');
    userSelect.innerHTML = '<option>Loading users...</option>';

    // Get all users except current admin
    fetch('/api/users/')
        .then(response => response.json())
        .then(data => {
            userSelect.innerHTML = '';
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.full_name || user.username} (${user.user_type})`;
                userSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading users:', error);
            userSelect.innerHTML = '<option>Error loading users</option>';
        });
}

function loadBulkPermissions() {
    const permissionSelect = document.getElementById('bulk-permission');
    permissionSelect.innerHTML = '<option value="">Select a permission...</option>';

    // Get all available permissions
    const allPermissions = new Set();
    Object.values(rolePermissions).forEach(permissions => {
        permissions.forEach(perm => allPermissions.add(perm));
    });

    Array.from(allPermissions).sort().forEach(permission => {
        const option = document.createElement('option');
        option.value = permission;
        option.textContent = permission.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        permissionSelect.appendChild(option);
    });
}

function executeBulkPermission() {
    const selectedUsers = Array.from(document.getElementById('bulk-users').selectedOptions).map(opt => opt.value);
    const selectedPermission = document.getElementById('bulk-permission').value;
    const action = document.querySelector('input[name="bulk-action"]:checked').value;

    if (selectedUsers.length === 0) {
        alert('Please select at least one user.');
        return;
    }

    if (!selectedPermission) {
        alert('Please select a permission.');
        return;
    }

    const confirmMessage = `Are you sure you want to ${action} the permission "${selectedPermission}" for ${selectedUsers.length} user(s)?`;
    if (!confirm(confirmMessage)) {
        return;
    }

    // Execute bulk permission change
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('users', JSON.stringify(selectedUsers));
    formData.append('permission', selectedPermission);
    formData.append('action', action);

    fetch('/bulk-permission-management/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully ${action}ed permission for ${data.affected_users} user(s).`);
            $('#bulkPermissionModal').modal('hide');
            // Refresh current user permissions if one of the affected users is currently selected
            const currentUserId = document.getElementById('selected_user_id').value;
            if (selectedUsers.includes(currentUserId)) {
                loadUserPermissions();
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error executing bulk permission change');
    });
}

function resetForm() {
    document.getElementById('permissions-section').style.display = 'none';
    document.querySelector('select[name="user"]').selectedIndex = 0;
    clearAllPermissions();

    const displayDiv = document.getElementById('current-permissions-display');
    displayDiv.innerHTML = '<p class="text-muted text-center">Select a user to view their current permissions.</p>';
}

// Permission search and filter functionality
function filterPermissions(type) {
    const permissionItems = document.querySelectorAll('#permissions-grid .col-md-4');
    const filterButtons = document.querySelectorAll('.btn-group .btn');

    // Update active button
    filterButtons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${type}`).classList.add('active');

    permissionItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const isChecked = checkbox.checked;
        const hasRevokedBadge = item.querySelector('.badge-warning');

        let show = true;
        if (type === 'granted') {
            show = isChecked && !hasRevokedBadge;
        } else if (type === 'revoked') {
            show = hasRevokedBadge || (!isChecked && !item.querySelector('.badge-info'));
        }

        item.style.display = show ? 'block' : 'none';
    });
}

function searchPermissions() {
    const searchTerm = document.getElementById('permission-search').value.toLowerCase();
    const permissionItems = document.querySelectorAll('#permissions-grid .col-md-4');

    permissionItems.forEach(item => {
        const label = item.querySelector('label').textContent.toLowerCase();
        const matches = label.includes(searchTerm);

        // Only hide if it doesn't match search AND it's not already hidden by filter
        if (!matches) {
            item.style.display = 'none';
        } else if (item.style.display === 'none') {
            // Re-apply current filter to show matching items
            const activeFilter = document.querySelector('.btn-group .btn.active');
            if (activeFilter) {
                const filterType = activeFilter.id.replace('filter-', '');
                const checkbox = item.querySelector('input[type="checkbox"]');
                const isChecked = checkbox.checked;
                const hasRevokedBadge = item.querySelector('.badge-warning');

                let show = true;
                if (filterType === 'granted') {
                    show = isChecked && !hasRevokedBadge;
                } else if (filterType === 'revoked') {
                    show = hasRevokedBadge || (!isChecked && !item.querySelector('.badge-info'));
                }

                item.style.display = show ? 'block' : 'none';
            } else {
                item.style.display = 'block';
            }
        }
    });
}

// Auto-load permissions when user is selected
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.querySelector('select[name="user"]');
    if (userSelect) {
        userSelect.addEventListener('change', function() {
            if (this.value) {
                loadUserPermissions();
            } else {
                document.getElementById('permissions-section').style.display = 'none';
            }
        });
    }

    // Add search functionality
    const searchInput = document.getElementById('permission-search');
    if (searchInput) {
        searchInput.addEventListener('input', searchPermissions);
    }

    // Set default filter to 'all'
    document.getElementById('filter-all').classList.add('active');

    // Load statistics
    loadStatistics();
    
    // Load wholesale activity
    loadWholesaleActivity();
});

function loadStatistics() {
    // Load total users
    fetch('/api/users/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-users').textContent = data.users.length;
            }
        })
        .catch(error => console.error('Error loading user count:', error));

    // Calculate total permissions
    const allPermissions = new Set();
    Object.values(rolePermissions).forEach(permissions => {
        permissions.forEach(perm => allPermissions.add(perm));
    });
    document.getElementById('active-permissions').textContent = allPermissions.size;

    // Load custom permissions count (this would need another API endpoint)
    // For now, we'll set it to a placeholder
    document.getElementById('custom-permissions').textContent = '?';
    
    // Load wholesale cashier statistics
    loadWholesaleCashierStats();
}

function loadWholesaleCashierStats() {
    // Simulate loading wholesale statistics (in real implementation, this would be an API call)
    const mockStats = {
        pending_count: Math.floor(Math.random() * 20) + 5,
        accepted_count: Math.floor(Math.random() * 15) + 3,
        completed_today: Math.floor(Math.random() * 10) + 2,
        total_processed: Math.floor(Math.random() * 100) + 50,
        total_value: Math.floor(Math.random() * 50000) + 10000,
        active_cashiers: Math.floor(Math.random() * 5) + 1
    };
    
    // Update the wholesale statistics
    document.getElementById('wc-pending-count').textContent = mockStats.pending_count;
    document.getElementById('wc-accepted-count').textContent = mockStats.accepted_count;
    document.getElementById('wc-completed-today').textContent = mockStats.completed_today;
    document.getElementById('wc-total-processed').textContent = mockStats.total_processed;
    document.getElementById('wc-total-value').textContent = '₦' + mockStats.total_value.toLocaleString();
    document.getElementById('wc-active-cashiers').textContent = mockStats.active_cashiers;
}

function openWholesaleCashier() {
    window.open("{% url 'wholesale:wholesale_cashier_dashboard' %}", '_blank');
}

function viewWholesaleRequests() {
    window.open("{% url 'wholesale:wholesale_payment_requests' %}", '_blank');
}

function refreshWholesaleStats() {
    // Show loading state
    const elements = ['wc-pending-count', 'wc-accepted-count', 'wc-completed-today', 
                     'wc-total-processed', 'wc-total-value', 'wc-active-cashiers'];
    elements.forEach(id => {
        const el = document.getElementById(id);
        el.style.opacity = '0.5';
        el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    });
    
    // Simulate loading delay and refresh stats
    setTimeout(() => {
        loadWholesaleCashierStats();
        elements.forEach(id => {
            document.getElementById(id).style.opacity = '1';
        });
    }, 1000);
}

function exportWholesaleData() {
    alert('Wholesale data export functionality would be implemented here. This would export payment requests, transactions, and cashier performance data.');
}

function startCashierSession() {
    alert('Start cashier session functionality would be implemented here. This would begin a new cashier work session.');
}

function endCashierSession() {
    alert('End cashier session functionality would be implemented here. This would end the current cashier work session and generate session summary.');
}

function generateCashierReport() {
    alert('Generate daily cashier report functionality would be implemented here. This would create a comprehensive daily report of cashier activities.');
}

function viewCashierAudit() {
    alert('View cashier audit trail functionality would be implemented here. This would show detailed audit logs of cashier activities.');
}

function openBulkOperation() {
    alert('Open bulk operations modal functionality would be implemented here. This would allow bulk processing of payment requests.');
}

function loadWholesaleActivity() {
    // Simulate loading recent wholesale activity
    const activityFeed = document.getElementById('wholesale-activity-feed');
    const activities = [
        { type: 'completed', request: 'WR-00123', amount: 15000, time: '2 mins ago' },
        { type: 'accepted', request: 'WR-00122', amount: 8500, time: '5 mins ago' },
        { type: 'rejected', request: 'WR-00121', amount: 3200, time: '8 mins ago' },
        { type: 'completed', request: 'WR-00120', amount: 22800, time: '12 mins ago' }
    ];
    
    let activityHtml = '';
    activities.forEach(activity => {
        const badgeClass = activity.type === 'completed' ? 'success' : 
                          activity.type === 'accepted' ? 'info' : 'danger';
        const icon = activity.type === 'completed' ? 'check-circle' : 
                    activity.type === 'accepted' ? 'clock' : 'times-circle';
        
        activityHtml += `
            <div class="activity-item mb-2 pb-2 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-${badgeClass} badge-sm">
                            <i class="fas fa-${icon}"></i> ${activity.type}
                        </span>
                        <span class="ml-2 font-weight-bold">${activity.request}</span>
                    </div>
                    <small class="text-muted">${activity.time}</small>
                </div>
                <div class="mt-1">
                    <small>₦${activity.amount.toLocaleString()}</small>
                </div>
            </div>
        `;
    });
    
    activityFeed.innerHTML = activityHtml || '<div class="text-center text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><p>No recent activity</p></div>';
}
</script>

<style>
.permission-item {
    padding: 2px 0;
    font-size: 0.85em;
}

.d-grid {
    display: grid;
}

.gap-2 {
    gap: 0.5rem;
}

.form-check {
    padding-left: 1.5rem;
}

.form-check-input {
    margin-left: -1.5rem;
}

.permission-source-badge {
    font-size: 0.7em;
}

.badge-sm {
    font-size: 0.75em;
    padding: 0.25em 0.4em;
}

.permission-grid-item {
    transition: all 0.3s ease;
    border: 1px solid transparent;
    border-radius: 5px;
    padding: 8px;
    margin-bottom: 8px;
}

.permission-grid-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.permission-grid-item.granted {
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.permission-grid-item.revoked {
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.search-highlight {
    background-color: yellow;
    font-weight: bold;
}

.btn-group .btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.modal-lg {
    max-width: 900px;
}

.permission-category {
    border-left: 4px solid #007bff;
    padding-left: 10px;
    margin-bottom: 15px;
}

.permission-category h6 {
    color: #007bff;
    font-weight: bold;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.stats-card .stat-number {
    font-size: 2rem;
    font-weight: bold;
}

.stats-card .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}
</style>
{% endblock %}
